<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja" >

<head>
<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<meta name="dcterms.date" content="2023-06-15" />
<title>biquad_filter_comparison</title>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css"
integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js"
integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ"
crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js"
integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
onload="renderMathInElement(document.body);"></script>

<style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #666666;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #666666;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; text-decoration: underline; } /* Alert */
code span.an { color: #666666; font-style: italic; } /* Annotation */
code span.at { color: #906000; } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #000000; font-weight: bold; } /* ControlFlow */
code span.ch { color: #b000b0; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008800; } /* Comment */
code span.cv { color: #008800; } /* CommentVar */
code span.do { color: #008800; } /* Documentation */
code span.dt { color: #906000; } /* DataType */
code span.dv { color: #0000ff; } /* DecVal */
code span.er { color: #ffffff; background-color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000ff; } /* Float */
code span.im { color: #000000; font-weight: bold; } /* Import */
code span.in { color: #666666; } /* Information */
code span.kw { color: #000000; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #000000; } /* Other */
code span.pp { color: #000000; font-weight: bold; } /* Preprocessor */
code span.sc { color: #b000b0; } /* SpecialChar */
code span.ss { color: #b000b0; } /* SpecialString */
code span.st { color: #b000b0; } /* String */
code span.va { color: #000088; } /* Variable */
code span.vs { color: #b000b0; } /* VerbatimString */
code span.wa { background-color: #ffff00; font-weight: bold; font-style: italic; text-decoration: underline; } /* Warning */
</style>
<style>
body {
max-width: 704px;
margin: auto;
padding: 32px 8px;
}

img {
max-width: 100%;
}

video {
max-width: 100%;
}

kbd {
font-family: inherit;
border-style: solid;
border-width: 1px 2px 2px 1px;
border-radius: 2px;
padding: 4px;
margin: 2px;
line-height: calc(1em + 16px);
}

a {
text-decoration: none;
}

h2 {
border-left: solid 32px #000000;
padding-left: 24px;
}

h3 {
border-left: solid 20px #404040;
padding-left: 16px;
}

h4 {
border-left: solid 12px #606060;
padding-left: 8px;
}

h5 {
border-left: solid 4px #808080;
padding-left: 4px;
}

h6 {
border-left: solid 2px #a0a0a0;
padding-left: 2px;
}

table {
border-spacing: 0px;
border-collapse: separate;
border-left: 1px solid #888888;
border-right: 1px solid #888888;
border-top: 1px solid #888888;
border-bottom: hidden;
}

tr:nth-child(odd) {
background: #eeeeee;
}

tr:nth-child(even) {
background: #ffffff;
}

th {
height: 2em;
padding: 4px 1em 4px 1em;
background: #ffffff;
border-bottom: 1px solid #888888;
}

th:not(:first-child) {
border-left: 1px solid #888888;
}

td {
height: 1.5em;
padding: 4px 1em 4px 1em;
border-bottom: 1px solid #888888;
}

td:not(:first-child) {
border-left: 1px solid #888888;
}

dl {
padding-left: 2em;
}

dt {
font-weight: bold;
border-bottom: 1px dashed #000000;
margin-top: 2em;
}

dd {
border-left: 1px dotted #000000;
margin-left: 1em;
padding-left: 1em;
}

audio {
vertical-align: middle;
}

label {
vertical-align: middle;
}

:not(.sourceCode)>pre {
overflow: auto;
border: 1px solid #888888;
padding: 8px;
}

div.sourceCode {
overflow: auto;
border: 1px solid #888888;
padding: 8px;
}

pre>code.sourceCode>span>a:first-child::before {
border-right: 1px solid #888888;
padding-right: 1em;
margin-right: 1em;
text-decoration: none;
}

:not(pre)>code {
color: #163eac;
}

li {
margin: 8px;
}

summary:hover {
background-color: #eeeeee;
}

header {
border-bottom: 1px gray solid;
padding: 0.5em;
margin-bottom: 1em;
}

footer {
border-top: 1px gray solid;
padding: 0.5em;
margin-top: 1em;
}


canvas {
/* image-rendering: pixelated; */
display: inline-block;
border-style: solid;
border-width: 1px;
border-color: #627f84;
}

.controlBlock {
display: inline-block;
width: 450px;
text-align: left;
vertical-align: top;
margin-left: 4px;
}

input[type="button"] {
background-color: #ffffff;
border: 2px solid #aaaaaa;
font-size: 16px;
height: 32px;
}

input[type="button"]:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}

div.numberInput {
display: block;
white-space: nowrap;
}

div.numberInput:hover {
background-color: #e0ecff;
}

.numberInputLabel {
/* max 12 letter  */
display: inline-block;
margin: 0 8px 0 8px;
text-align: left;
vertical-align: middle;
width: 100px;

font-size: 10pt;
font-family: 'Courier New', Courier, monospace;
}

.numberInputNumber {
display: inline-block;
vertical-align: middle;
width: 120px;
}

.numberInputRange {
display: inline-block;
vertical-align: middle;
width: 160px;
}

.pullDownMenu {
display: inline-block;
text-align: center;
}

.pullDownMenu:hover {
background-color: #e0ecff;
}

select {
background-color: #ffffff;
border: 2px solid #aaaaaa;
height: 24px;
vertical-align: middle;
font-size: 12px;
}

select:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}
</style>

<script
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
type="text/javascript"></script>
</head>

<body>
<header>
<p>
何かあれば <a href="https://github.com/ryukau/filter_notes">GitHub のリポジトリ</a>に issue を作るか ryukau@gmail.com までお気軽にどうぞ。
</p>
<hr>
<a href="../index.html">インデックスに戻る</a>
<p>
Update: 2023-06-15
</p>
<details>
<summary translate="yes">Table of Contents</summary>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#biquad-フィルタの比較"
id="toc-biquad-フィルタの比較">Biquad フィルタの比較</a>
<ul>
<li><a href="#実装" id="toc-実装">実装</a>
<ul>
<li><a href="#rbj-フィルタ" id="toc-rbj-フィルタ">RBJ フィルタ</a></li>
<li><a href="#tpt-フィルタ" id="toc-tpt-フィルタ">TPT フィルタ</a></li>
</ul></li>
<li><a href="#比較" id="toc-比較">比較</a></li>
<li><a href="#その他" id="toc-その他">その他</a>
<ul>
<li><a href="#butterworth-フィルタ"
id="toc-butterworth-フィルタ">Butterworth フィルタ</a></li>
<li><a href="#レゾナンスのゲイン"
id="toc-レゾナンスのゲイン">レゾナンスのゲイン</a></li>
</ul></li>
<li><a href="#参考文献" id="toc-参考文献">参考文献</a></li>
</ul></li>
</ul>
</nav>
</details>
</header>
<h1 id="biquad-フィルタの比較">Biquad フィルタの比較</h1>
<p>以下の Biquad フィルタの実装を比較します。</p>
<ol type="1">
<li>Robert Bristow-Johnson (RBJ) さんによる<a
href="https://www.w3.org/TR/audio-eq-cookbook/">レシピ</a>。</li>
<li>Vadim Zavalishin さんによる <a
href="https://archive.org/details/the-art-of-va-filter-design-rev.-2.1.2">The
Art of VA Filter Design</a> の SVF。 Chapter 4 に詳細。</li>
</ol>
<p>ここでは 1 を RBJ フィルタ、 2 を TPT フィルタと呼ぶことにします。
TPT は topology-preserving transform の略で、 The Art of VA Filter
Design で紹介されているアナログフィルタの離散化の方法です。</p>
<h2 id="実装">実装</h2>
<p>C++ 20 で実装します。標準ライブラリの <code>&lt;array&gt;</code>,
<code>&lt;cmath&gt;</code>, <code>&lt;numbers&gt;</code>
をインクルードしています。</p>
<p>三角関数の計算は重たいのでフィルタ係数はコントロールレートでのみ計算しています。オーディオレートでの補間には以下の
<code>ExpSmoother</code> を使っています。 <code>ExpSmoother</code>
は一次ローパスあるいは exponential moving average (EMA)
と呼ばれるフィルタです。</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">struct</span> ExpSmoother <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  Sample value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  Sample target <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  Sample kp <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Exponential moving average coefficient.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setCutoff<span class="op">(</span>Sample sampleRate<span class="op">,</span> Sample cutoffHz<span class="op">)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// `double` is used for accuracy.</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> y <span class="op">=</span> <span class="dt">double</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="bu">std::</span>cos<span class="op">(</span><span class="dt">double</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span> <span class="op">*</span> <span class="bu">std::</span>numbers<span class="bu">::</span>pi_v<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="op">*</span> cutoffHz <span class="op">/</span> sampleRate<span class="op">);</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    kp <span class="op">=</span> Sample<span class="op">(</span><span class="bu">std::</span>sqrt<span class="op">((</span>y <span class="op">+</span> <span class="dt">double</span><span class="op">(</span><span class="dv">2</span><span class="op">))</span> <span class="op">*</span> y<span class="op">)</span> <span class="op">-</span> y<span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> reset<span class="op">(</span>Sample newTarget <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> newTarget<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    target <span class="op">=</span> newTarget<span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> push<span class="op">(</span>Sample newTarget <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> target <span class="op">=</span> newTarget<span class="op">;</span> <span class="op">}</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">inline</span> Sample process<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> value <span class="op">+=</span> kp <span class="op">*</span> <span class="op">(</span>target <span class="op">-</span> value<span class="op">);</span> <span class="op">}</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 id="rbj-フィルタ">RBJ フィルタ</h3>
<p><a href="https://www.w3.org/TR/audio-eq-cookbook/">Audio EQ
Cookbook</a> に基づいたローパスのみの実装例です。</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;array&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;numbers&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">class</span> RbjBiquad <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  Sample x1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  Sample x2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  Sample y1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  Sample y2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>array<span class="op">&lt;</span>ExpSmoother<span class="op">&lt;</span>Sample<span class="op">&gt;,</span> <span class="dv">5</span><span class="op">&gt;</span> co<span class="op">;</span> <span class="co">// Coefficients {b0, b1, b2, -a1, -a2}.</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="bu">std::</span>string<span class="op"> </span>name<span class="op">{</span><span class="st">&quot;RbjBiquad&quot;</span><span class="op">};</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  RbjBiquad<span class="op">()</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>x <span class="op">:</span> co<span class="op">)</span> x<span class="op">.</span>setCutoff<span class="op">(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">),</span> Sample<span class="op">(</span><span class="fl">0.02</span><span class="op">));</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ASSIGN_COEFFICINETS</span><span class="op">(</span>method<span class="op">)</span><span class="pp">                                                      </span><span class="op">\</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="pp">  </span><span class="co">/* normalizedFreq = cutoffHz / sampleRate. */</span><span class="pp">                                          </span><span class="op">\</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="pp">  </span><span class="dt">void</span><span class="pp"> </span>method<span class="op">##</span>Lowpass<span class="op">(</span>Sample<span class="pp"> </span>normalizedFreq<span class="op">,</span><span class="pp"> </span>Sample<span class="pp"> </span>Q<span class="op">)</span><span class="pp">                                  </span><span class="op">\</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="pp">  </span><span class="op">{</span><span class="pp">                                                                                      </span><span class="op">\</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="kw">auto</span><span class="pp"> </span>omega<span class="pp"> </span><span class="op">=</span><span class="pp"> </span><span class="bu">std::</span>numbers<span class="bu">::</span>pi_v<span class="op">&lt;</span>Sample<span class="op">&gt;</span><span class="pp"> </span><span class="op">*</span><span class="pp"> </span>Sample<span class="op">(</span><span class="dv">2</span><span class="op">)</span><span class="pp"> </span><span class="op">*</span><span class="pp"> </span>normalizedFreq<span class="op">;</span><span class="pp">                </span><span class="op">\</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="kw">auto</span><span class="pp"> </span>cos<span class="pp"> </span><span class="op">=</span><span class="pp"> </span><span class="bu">std::</span>cos<span class="op">(</span>omega<span class="op">);</span><span class="pp">                                                          </span><span class="op">\</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="kw">auto</span><span class="pp"> </span>sin<span class="pp"> </span><span class="op">=</span><span class="pp"> </span><span class="bu">std::</span>sin<span class="op">(</span>omega<span class="op">);</span><span class="pp">                                                          </span><span class="op">\</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="kw">auto</span><span class="pp"> </span>alpha<span class="pp"> </span><span class="op">=</span><span class="pp"> </span>sin<span class="pp"> </span><span class="op">/</span><span class="pp"> </span><span class="op">(</span>Sample<span class="op">(</span><span class="dv">2</span><span class="op">)</span><span class="pp"> </span><span class="op">*</span><span class="pp"> </span>Q<span class="op">);</span><span class="pp">                                                  </span><span class="op">\</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="kw">auto</span><span class="pp"> </span>a0_inv<span class="pp"> </span><span class="op">=</span><span class="pp"> </span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">/</span><span class="pp"> </span><span class="op">(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span>alpha<span class="op">);</span><span class="pp">                                       </span><span class="op">\</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span>co<span class="op">[</span><span class="dv">0</span><span class="op">].</span>method<span class="op">(</span>a0_inv<span class="pp"> </span><span class="op">*((</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span>cos<span class="op">)</span><span class="pp"> </span><span class="op">/</span><span class="pp"> </span>Sample<span class="op">(</span><span class="dv">2</span><span class="op">)));</span><span class="pp"> </span><span class="co">/* b0 */</span><span class="pp">                      </span><span class="op">\</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span>co<span class="op">[</span><span class="dv">1</span><span class="op">].</span>method<span class="op">(</span>a0_inv<span class="pp"> </span><span class="op">*(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span>cos<span class="op">));</span><span class="pp">               </span><span class="co">/* b1 */</span><span class="pp">                      </span><span class="op">\</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span>co<span class="op">[</span><span class="dv">2</span><span class="op">].</span>method<span class="op">(</span>a0_inv<span class="pp"> </span><span class="op">*((</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span>cos<span class="op">)</span><span class="pp"> </span><span class="op">/</span><span class="pp"> </span>Sample<span class="op">(</span><span class="dv">2</span><span class="op">)));</span><span class="pp"> </span><span class="co">/* b2 */</span><span class="pp">                      </span><span class="op">\</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span>co<span class="op">[</span><span class="dv">3</span><span class="op">].</span>method<span class="op">(-</span>a0_inv<span class="pp"> </span><span class="op">*(</span>Sample<span class="op">(-</span><span class="dv">2</span><span class="op">)</span><span class="pp"> </span><span class="op">*</span><span class="pp"> </span>cos<span class="op">));</span><span class="pp">             </span><span class="co">/* a1 */</span><span class="pp">                      </span><span class="op">\</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span>co<span class="op">[</span><span class="dv">4</span><span class="op">].</span>method<span class="op">(-</span>a0_inv<span class="pp"> </span><span class="op">*(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span>alpha<span class="op">));</span><span class="pp">            </span><span class="co">/* a2 */</span><span class="pp">                      </span><span class="op">\</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="pp">  </span><span class="op">}</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  ASSIGN_COEFFICINETS<span class="op">(</span>reset<span class="op">);</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  ASSIGN_COEFFICINETS<span class="op">(</span>push<span class="op">);</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="pp">#undef ASSIGN_COEFFICINETS</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> reset<span class="op">(</span>Sample normalizedFreq<span class="op">,</span> Sample Q<span class="op">,</span> Sample value <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    x1 <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    x2 <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    y1 <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    y2 <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    resetLowpass<span class="op">(</span>normalizedFreq<span class="op">,</span> Q<span class="op">);</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> prepare<span class="op">(</span>Sample normalizedFreq<span class="op">,</span> Sample Q<span class="op">)</span> <span class="op">{</span> pushLowpass<span class="op">(</span>normalizedFreq<span class="op">,</span> Q<span class="op">);</span> <span class="op">}</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample x0<span class="op">)</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> <span class="op">&amp;</span>x <span class="op">:</span> co<span class="op">)</span> x<span class="op">.</span>process<span class="op">();</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> y0 <span class="op">=</span> co<span class="op">[</span><span class="dv">0</span><span class="op">].</span>value <span class="op">*</span> x0 <span class="op">+</span> co<span class="op">[</span><span class="dv">1</span><span class="op">].</span>value <span class="op">*</span> x1 <span class="op">+</span> co<span class="op">[</span><span class="dv">2</span><span class="op">].</span>value <span class="op">*</span> x2 <span class="op">+</span> co<span class="op">[</span><span class="dv">3</span><span class="op">].</span>value <span class="op">*</span> y1</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>      <span class="op">+</span> co<span class="op">[</span><span class="dv">4</span><span class="op">].</span>value <span class="op">*</span> y2<span class="op">;</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    x2 <span class="op">=</span> x1<span class="op">;</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    x1 <span class="op">=</span> x0<span class="op">;</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    y2 <span class="op">=</span> y1<span class="op">;</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    y1 <span class="op">=</span> y0<span class="op">;</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y0<span class="op">;</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><code>process()</code> の <code>y0</code>
の計算で加算と減算を混ぜないようにするため、フィルタ係数 <code>co</code>
の <span class="math inline">\(a_1, a_2\)</span>
の符号を反転しています。</p>
<p>マクロで定義しているのでややこしいですが、
<code>resetLowpass()</code> と <code>pushLowpass()</code>
でフィルタ係数を設定します。 <code>reset*</code>
は音の再生開始前などに内部状態をリセットするときに呼び出します。
<code>push*</code> と <code>prepare</code>
は音の再生中にコントロールレートでフィルタ係数を設定するときに使います。
<code>prepare</code>
は個人的に使っているコントロールレートでのパラメータ設定を行うメソッド名で、消しても問題ありません。</p>
<p>テンプレートで並列処理する信号の数を指定できるようにした実装も行いました。これは
<code>cl.exe</code> のオプションに <code>/Qvec-report:1</code>
を指定して SIMD がどれくらい入るかを検証するためです。</p>
<ul>
<li><a
href="https://github.com/ryukau/filter_notes/blob/3b830660c7a13fbb730ffd14e0a251fc53acdc54/biquad_filter_comparison/code/cpp/benchmark.cpp#L283-L377">RbjBiquadParallel</a></li>
</ul>
<h3 id="tpt-フィルタ">TPT フィルタ</h3>
<p>The Art of VA Filter Design
で紹介されている手法に基づいたローパスのみの実装例です。 <a
href="https://github.com/grame-cncm/faustlibraries/blob/ea4fae33bb57357c7e2880c094079018bb4bd769/filters.lib#L2628-L2707">Faust
Libraries の svf</a> を参考にしています。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">class</span> TptBiquad <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  ExpSmoother<span class="op">&lt;</span>Sample<span class="op">&gt;</span> g<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  ExpSmoother<span class="op">&lt;</span>Sample<span class="op">&gt;</span> R<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  ExpSmoother<span class="op">&lt;</span>Sample<span class="op">&gt;</span> d<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  Sample s1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  Sample s2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="bu">std::</span>string<span class="op"> </span>name<span class="op">{</span><span class="st">&quot;TptBiquad&quot;</span><span class="op">};</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  TptBiquad<span class="op">()</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> Sample cutoff <span class="op">=</span> Sample<span class="op">(</span><span class="fl">0.02</span><span class="op">);</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span>setCutoff<span class="op">(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">),</span> cutoff<span class="op">);</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    R<span class="op">.</span>setCutoff<span class="op">(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">),</span> cutoff<span class="op">);</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    d<span class="op">.</span>setCutoff<span class="op">(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">),</span> cutoff<span class="op">);</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ASSIGN_COEFFICINETS</span><span class="op">(</span>method<span class="op">)</span><span class="pp">                                                      </span><span class="op">\</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="pp">  </span><span class="co">/* normalizedFreq = cutoffHz / sampleRate. */</span><span class="pp">                                          </span><span class="op">\</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="pp">  </span><span class="dt">void</span><span class="pp"> </span>method<span class="op">##</span>Coefficient<span class="op">(</span>Sample<span class="pp"> </span>normalizedFreq<span class="op">,</span><span class="pp"> </span>Sample<span class="pp"> </span>Q<span class="op">)</span><span class="pp">                              </span><span class="op">\</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="pp">  </span><span class="op">{</span><span class="pp">                                                                                      </span><span class="op">\</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span>g<span class="op">.</span>method<span class="op">(</span><span class="bu">std::</span>tan<span class="op">(</span><span class="bu">std::</span>numbers<span class="bu">::</span>pi_v<span class="op">&lt;</span>Sample<span class="op">&gt;</span><span class="pp"> </span><span class="op">*</span>normalizedFreq<span class="op">));</span><span class="pp">                      </span><span class="op">\</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span>R<span class="op">.</span>method<span class="op">(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">/</span><span class="pp"> </span>Q<span class="op">);</span><span class="pp">                                                             </span><span class="op">\</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span>d<span class="op">.</span>method<span class="op">(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">/</span><span class="pp"> </span><span class="op">(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">+</span><span class="pp"> </span>g<span class="op">.</span>target<span class="pp"> </span><span class="op">*</span><span class="pp"> </span>g<span class="op">.</span>target<span class="pp"> </span><span class="op">+</span><span class="pp"> </span>g<span class="op">.</span>target<span class="pp"> </span><span class="op">*</span><span class="pp"> </span>R<span class="op">.</span>target<span class="op">));</span><span class="pp">       </span><span class="op">\</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="pp">  </span><span class="op">}</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  ASSIGN_COEFFICINETS<span class="op">(</span>push<span class="op">);</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  ASSIGN_COEFFICINETS<span class="op">(</span>reset<span class="op">);</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="pp">#undef ASSIGN_COEFFICINETS</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> reset<span class="op">(</span>Sample normalizedFreq<span class="op">,</span> Sample Q<span class="op">,</span> Sample value <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    s1 <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    s2 <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    resetCoefficient<span class="op">(</span>normalizedFreq<span class="op">,</span> Q<span class="op">);</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> prepare<span class="op">(</span>Sample normalizedFreq<span class="op">,</span> Sample Q<span class="op">)</span> <span class="op">{</span> pushCoefficient<span class="op">(</span>normalizedFreq<span class="op">,</span> Q<span class="op">);</span> <span class="op">}</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Lowpass.</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample x0<span class="op">)</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span>process<span class="op">();</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    d<span class="op">.</span>process<span class="op">();</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> v1 <span class="op">=</span> <span class="op">(</span>s1 <span class="op">+</span> g<span class="op">.</span>value <span class="op">*</span> <span class="op">(</span>x0 <span class="op">-</span> s2<span class="op">))</span> <span class="op">*</span> d<span class="op">.</span>value<span class="op">;</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> v2 <span class="op">=</span> s2 <span class="op">+</span> g<span class="op">.</span>value <span class="op">*</span> v1<span class="op">;</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    s1 <span class="op">=</span> Sample<span class="op">(</span><span class="dv">2</span><span class="op">)</span> <span class="op">*</span> v1 <span class="op">-</span> s1<span class="op">;</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    s2 <span class="op">=</span> Sample<span class="op">(</span><span class="dv">2</span><span class="op">)</span> <span class="op">*</span> v2 <span class="op">-</span> s2<span class="op">;</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> v2<span class="op">;</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>以下はテンプレートで並列処理する信号の数を指定できるようにした実装です。</p>
<ul>
<li><a
href="https://github.com/ryukau/filter_notes/blob/3b830660c7a13fbb730ffd14e0a251fc53acdc54/biquad_filter_comparison/code/cpp/benchmark.cpp#L379-L450">TptBiquadParallel</a></li>
</ul>
<p>以下はオーディオレートで計算を行う素朴な実装です。</p>
<ul>
<li><a
href="https://github.com/ryukau/filter_notes/blob/master/biquad_filter_comparison/code/svf.cpp">filter_notes/biquad_filter_comparison/code/svf.cpp
at master · ryukau/filter_notes · GitHub</a></li>
</ul>
<p>以下は動作確認に使った Python 3 での実装です。</p>
<ul>
<li><a
href="https://github.com/ryukau/filter_notes/blob/master/biquad_filter_comparison/code/svf.py">filter_notes/biquad_filter_comparison/code/svf.py
at master · ryukau/filter_notes · GitHub</a></li>
</ul>
<h2 id="比較">比較</h2>
<p>使い勝手については以下の違いがあります。</p>
<ul>
<li>RBJ フィルタはフィルタの種類によって係数の設定が異なるが、
<code>process</code> の計算は共通。</li>
<li>TPT フィルタはフィルタの種類によって <code>process</code>
の計算が異なるが、係数の設定はおおよそ共通。</li>
</ul>
<p>コードの長さについては TPT
フィルタのほうが短くなる傾向があります。ただし TPT フィルタは bell 、
low-shelf 、 high-shelf については係数の計算が変わります。</p>
<p>RBJ フィルタはフィルタ係数が 5
つで、補間を行うときは安定性に疑問が残ります。 TPT フィルタの係数は 3
つと比較的少ないですが、こちらも <code>d</code>
については補間による安定性がはっきりしません。 <code>d</code>
については補間を行わずに <code>g</code> と <code>R</code>
からオーディオレートで計算することで安定しますが、除算が出てくるので速度は落ちます。</p>
<p>今回の実装の計算速度について簡単なベンチマークをとってみたところ、以下のような結果が得られました。<code>Sample Count</code>
は計算したサンプル数です。 <code>Last Output</code>
は最後の出力の総和で、実装間の出力に差がないことを確認するためにプリントしています。
<code>TptSvf</code> はローパス、バンドパス、ハイパスを同時に計算する
<code>TptBiquad</code> の実装の派生です。 <code>RbjBiquadParallel</code>
と <code>TptBiquadParallel</code> は 16 出力を同時に計算しています。</p>
<p>以下は <code>float</code> でのベンチマーク結果です。</p>
<table>
<thead>
<tr class="header">
<th>Filter Type</th>
<th style="text-align: right;">Time Elapsed [ms]</th>
<th style="text-align: right;">Sample Count</th>
<th style="text-align: right;">Last Output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RbjBiquad</td>
<td style="text-align: right;">17.73569999997201</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">-0.03840086</td>
</tr>
<tr class="even">
<td>TptBiquad</td>
<td style="text-align: right;">17.528799999972524</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">-0.038400784</td>
</tr>
<tr class="odd">
<td>TptSvf</td>
<td style="text-align: right;">17.455699999972666</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">-0.038400736</td>
</tr>
<tr class="even">
<td>RbjBiquadParallel</td>
<td style="text-align: right;">290.3656000015933</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">0.15570019</td>
</tr>
<tr class="odd">
<td>TptBiquadParallel</td>
<td style="text-align: right;">148.51210000301913</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">0.15563208</td>
</tr>
</tbody>
</table>
<p>以下は <code>double</code> でのベンチマーク結果です。</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 27%" />
<col style="width: 18%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>Filter Type</th>
<th style="text-align: right;">Time Elapsed [ms]</th>
<th style="text-align: right;">Sample Count</th>
<th style="text-align: right;">Last Output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RbjBiquad</td>
<td style="text-align: right;">19.11819999996879</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">0.06474569475653402</td>
</tr>
<tr class="even">
<td>TptBiquad</td>
<td style="text-align: right;">22.07949999996203</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">0.06474569475653402</td>
</tr>
<tr class="odd">
<td>TptSvf</td>
<td style="text-align: right;">21.63369999996292</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">0.06474569475653393</td>
</tr>
<tr class="even">
<td>RbjBiquadParallel</td>
<td style="text-align: right;">293.51290000144576</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">0.81283637843879</td>
</tr>
<tr class="odd">
<td>TptBiquadParallel</td>
<td style="text-align: right;">150.7567000030868</td>
<td style="text-align: right;">960000</td>
<td style="text-align: right;">0.8128361199584616</td>
</tr>
</tbody>
</table>
<p>以下はベンチマークに使ったコードへのリンクです。</p>
<ul>
<li><a
href="https://github.com/ryukau/filter_notes/blob/master/biquad_filter_comparison/code/cpp/benchmark.cpp">filter_notes/biquad_filter_comparison/code/cpp/benchmark.cpp
at master · ryukau/filter_notes · GitHub</a></li>
</ul>
<p>結論としては TPT フィルタだけを使えばよさそうです。特に多出力では TPT
フィルタが圧倒的に速いです。 <code>double</code> かつ 1 出力であれば RBJ
フィルタがわずかに速いので、普段は TPT
フィルタを使い、どうしても速度が要るときに RBJ
フィルタへの切り替えも検討するという方針がよさそうです。</p>
<p>また <code>cl.exe</code> の <code>/Qvec-report:2</code>
で検証したところ、今回の実装のすべてのフィルタのコードについて<a
href="https://learn.microsoft.com/en-us/cpp/parallel/auto-parallelization-and-auto-vectorization?view=msvc-170#auto-vectorizer">自動ベクトル化</a>
(auto vectorization) は行われませんでした。より速くするには SIMD
を直接、あるいは <a
href="https://github.com/simd-everywhere/simde">simde</a> や <a
href="https://github.com/vectorclass/version2">VCL</a>
などのライブラリを通して間接的に書くしかなさそうです。</p>
<h2 id="その他">その他</h2>
<h3 id="butterworth-フィルタ">Butterworth フィルタ</h3>
<p>TPT フィルタのレゾナンスが <span class="math inline">\(R =
\dfrac{1}{\sqrt{2}}\)</span> のとき Butterworth フィルタになります。</p>
<p>Butterworth フィルタは maximally flat
なフィルタです。つまり、ローパスであればカットオフ周波数から 0 Hz
までの範囲の振幅特性が最も平坦となります。また、振幅特性が 1 倍
(あるいは 0 dB)
を超えない最大のレゾナンスが設定されたフィルタとも言えます。</p>
<h3 id="レゾナンスのゲイン">レゾナンスのゲイン</h3>
<p>The Art of VA Filter Design (rev. 2.1.2) の 4.2 Resonance
にローパスのレゾナンスが <span class="math inline">\(R\)</span>
のときのゲイン <span class="math inline">\(A_{\mathrm{LP}}\)</span>
の計算方法が載っています。</p>
<p><span class="math display">\[
\begin{align*}
A_{\mathrm{LP}} &amp;= \frac{1}{2 R \sqrt{1 - R^2}}, \quad \text{where}
\quad  R &lt; \dfrac{1}{\sqrt{2}}. \\
\end{align*}
\]</span></p>
<p><span class="math inline">\(R \geq \dfrac{1}{\sqrt{2}}\)</span>
のときはレゾナンスによるゲインのピークが現れません。未定義としないときは周波数
0 でのゲインを使って <span class="math inline">\(A_{\mathrm{LP}} =
1\)</span> とすることが考えられます。</p>
<p>ハイパスのゲイン <span class="math inline">\(A_{\mathrm{HP}}\)</span>
も導出します。以下はハイパスのアナログプロトタイプの伝達関数です。</p>
<p><span class="math display">\[
\begin{align*}
H_{\mathrm{HP}}(s)
= \frac{s^2}{s^2 + 2 R s + 1}
= \frac{1}{1 + 2 R s^{-1} + s^{-2}}
\end{align*}
\]</span></p>
<p><span class="math inline">\(s = j\omega\)</span>
を代入して絶対値を取ります。伝達関数の絶対値はゲインを表します。</p>
<p><span class="math display">\[
\begin{align*}
|H_{\mathrm{HP}}(j\omega)| = \frac{1}{|1 + 2 R (j\omega)^{-1} +
(j\omega)^{-2}|}
\end{align*}
\]</span></p>
<p>ここで分母が最小となるとき、ゲインが最大となります。分母の最小値を求めます。</p>
<p><span class="math display">\[
\begin{align*}
0
&amp;= |1 + 2 R (j\omega)^{-1} + (j\omega)^{-2}| \\
&amp;= \sqrt{(1 - \omega^{-2})^2 + (2 R \omega^{-1})^2} \\
&amp;= \sqrt{1 + (4 R^2 - 2) \omega^{-2} + \omega^{-4}} \\
\\
0
&amp;= \omega^{4} + (4 R^2 - 2) \omega^{2} + 1
\end{align*}
\]</span></p>
<p>この式は The Art of VA Filter Design (rev. 2.1.2), p.102 の <span
class="math inline">\(|H_{\mathrm{LP}}(j\omega)|^{-2}\)</span>
の式と同じです。左辺が 0 なので、平方根に入っている <span
class="math inline">\(\omega^{-2}\)</span>
の多項式を二次方程式の解の公式で解くとゲインが最大となる周波数 <span
class="math inline">\(\omega_{\mathrm{peak}}\)</span> が得られます。</p>
<p><span class="math display">\[
\omega_{\mathrm{peak}} = \sqrt{1 - 2 R^2}
\]</span></p>
<p><span class="math inline">\(\omega_{\mathrm{peak}}\)</span>
を伝達関数に代入するとハイパスのレゾナンスのゲイン <span
class="math inline">\(A_{\mathrm{HP}}\)</span> が得られます。</p>
<p><span class="math display">\[
\begin{align*}
|H_{\mathrm{HP}}(\omega_{\mathrm{peak}})|^2
&amp;= \frac{1}{1 + (4 R^2 - 2) \omega^{-2} + \omega^{-4}} \\
&amp;= \frac{1}{1 + (4 R^2 - 2) (1 - 2 R^2)^{-1} + (1 - 2 R^2)^{-2}} \\
&amp;= \frac{(1 - 2 R^2)^2}{4 R^2 - 4 R^4} \\
\\
A_{\mathrm{HP}} = |H_{\mathrm{HP}}(\omega_{\mathrm{peak}})|
&amp;=\frac{1 - 2 R^2}{2 R \sqrt{1 - R^2}}, \quad \text{where} \quad R
&lt; \dfrac{1}{\sqrt{2}}.\\
\end{align*}
\]</span></p>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a href="https://www.w3.org/TR/audio-eq-cookbook/">Audio EQ
Cookbook</a></li>
<li><a
href="https://archive.org/details/the-art-of-va-filter-design-rev.-2.1.2">The
Art of VA Filter Design (rev. 2.1.2) (February 14, 2020) : Vadim
Zavalishin : Free Download, Borrow, and Streaming : Internet
Archive</a></li>
<li><a
href="https://github.com/grame-cncm/faustlibraries/blob/ea4fae33bb57357c7e2880c094079018bb4bd769/filters.lib#L2628-L2707">faustlibraries/filters.lib
at master · grame-cncm/faustlibraries · GitHub</a></li>
<li><a
href="https://learn.microsoft.com/en-us/cpp/parallel/auto-parallelization-and-auto-vectorization?view=msvc-170#auto-vectorizer">Auto-Parallelization
and Auto-Vectorization | Microsoft Learn</a></li>
<li><a
href="https://learn.microsoft.com/en-us/cpp/build/reference/qvec-report-auto-vectorizer-reporting-level?view=msvc-170">/Qvec-report
(Auto-Vectorizer Reporting Level) | Microsoft Learn</a></li>
<li><a
href="https://learn.microsoft.com/en-us/cpp/error-messages/tool-errors/vectorizer-and-parallelizer-messages?view=msvc-170">Vectorizer
and parallelizer messages | Microsoft Learn</a></li>
</ul>
<footer>
<a href="../index.html">インデックスに戻る</a>
</footer>
</body>

</html>

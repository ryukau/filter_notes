<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja" >

<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
      <meta name="dcterms.date" content="2024-08-06" />
      <title>control_rate_interpolation</title>

  <style>
    :root {
      --background-color: #ffffff;
      --foreground-color: #000000;
      --table-odd-background-color: #eeeeee;
      --link-color: #0000ee;
      --visited-color: #551a8b;
      --active-color: #ff0000;
      --border-color: #888888;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #202020;
        --foreground-color: #eeeeee;
        --table-odd-background-color: #333333;
        --link-color: #88aaee;
        --visited-color: #dd77cc;
        --active-color: #ff6666;
        --border-color: #888888;
      }

      audio,
      code,
      img,
      .sourceCode {
        /*
        0.8745 ~= 1 - 0x20 / 0xff.
        0x20 and 0xff are brightness of dark and light theme.
        */
        filter: invert(0.8745098039215686);
      }

      pre>code {
        filter: invert(0);
      }
    }

    body {
      max-width: 704px;
      margin: auto;
      padding: 32px 8px;

      background-color: var(--background-color);
      color: var(--foreground-color);
    }

    img {
      max-width: 100%;
    }

    video {
      max-width: 100%;
    }

    kbd {
      font-family: inherit;
      border-style: solid;
      border-width: 1px 2px 2px 1px;
      border-radius: 2px;
      padding: 4px;
      margin: 2px;
      line-height: calc(1em + 16px);
    }

    a {
      text-decoration: none;
    }

    :link {
      color: var(--link-color);
    }

    :visited {
      color: var(--visited-color);
    }

    :link:active,
    :visited:active {
      color: var(--active-color);
    }

    .header-anchor {
      color: var(--foreground-color);
    }

    .header-anchor:hover {
      color: var(--link-color);
    }

    .header-anchor:hover::after {
      display: inline-block;
      font-size: min(1em, 1rem);
      content: '(クリックでここへリンク)';
      padding-left: 1em;
      color: var(--link-color);
    }

    h2 {
      border-left: solid 32px #000000;
      padding-left: 24px;
    }

    h3 {
      border-left: solid 20px #404040;
      padding-left: 16px;
    }

    h4 {
      font-size: 100%;
      border-left: solid 12px #606060;
      padding-left: 8px;
    }

    h5 {
      font-size: 90%;
      border-left: solid 8px #808080;
      padding-left: 8px;
    }

    h6 {
      font-size: 80%;
      border-left: solid 4px #a0a0a0;
      padding-left: 4px;
    }

    table {
      border-spacing: 0px;
      border-collapse: separate;
      border-left: 1px solid var(--border-color);
      border-right: 1px solid var(--border-color);
      border-top: 1px solid var(--border-color);
      border-bottom: hidden;
    }

    tr:nth-child(odd) {
      background: var(--table-odd-background-color);
    }

    tr:nth-child(even) {
      background: var(--background-color);
    }

    th {
      height: 2em;
      padding: 4px 1em 4px 1em;
      background: var(--background-color);
      border-bottom: 1px solid var(--border-color);
    }

    th:not(:first-child) {
      border-left: 1px solid var(--border-color);
    }

    td {
      height: 1.5em;
      padding: 4px 1em 4px 1em;
      border-bottom: 1px solid var(--border-color);
    }

    td:not(:first-child) {
      border-left: 1px solid var(--border-color);
    }

    dl {
      padding-left: 2em;
    }

    dt {
      font-weight: bold;
      border-bottom: 1px dashed #000000;
      margin-top: 2em;
    }

    dd {
      border-left: 1px dotted #000000;
      margin-left: 1em;
      padding-left: 1em;
    }

    audio {
      vertical-align: middle;
    }

    label {
      vertical-align: middle;
    }

    :not(.sourceCode)>pre {
      overflow: auto;
      border: 1px solid var(--border-color);
      padding: 8px;
    }

    div.sourceCode {
      overflow: auto;
      border: 1px solid var(--border-color);
      padding: 8px;
    }

    pre>code.sourceCode>span>a:first-child::before {
      border-right: 1px solid var(--border-color);
      padding-right: 1em;
      margin-right: 1em;
      text-decoration: none;
    }

    :not(pre)>code {
      color: #163eac;
    }

    li {
      margin: 8px;
    }

    summary:hover {
      background-color: var(--table-odd-background-color);
    }

    header {
      border-bottom: 1px var(--border-color) solid;
      padding: 0.5em;
      margin-bottom: 1em;
    }

    footer {
      border-top: 1px var(--border-color) solid;
      padding: 0.5em;
      margin-top: 1em;
    }


    canvas {
      /* image-rendering: pixelated; */
      display: inline-block;
      border-style: solid;
      border-width: 1px;
      border-color: #627f84;
    }

    .controlBlock {
      display: inline-block;
      width: 450px;
      text-align: left;
      vertical-align: top;
      margin-left: 4px;
    }

    input[type="button"] {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      font-size: 16px;
      height: 32px;
    }

    input[type="button"]:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }

    div.numberInput {
      display: block;
      white-space: nowrap;
    }

    div.numberInput:hover {
      background-color: #e0ecff;
    }

    .numberInputLabel {
      /* max 12 letter  */
      display: inline-block;
      margin: 0 8px 0 8px;
      text-align: left;
      vertical-align: middle;
      width: 100px;

      font-size: 10pt;
      font-family: 'Courier New', Courier, monospace;
    }

    .numberInputNumber {
      display: inline-block;
      vertical-align: middle;
      width: 120px;
    }

    .numberInputRange {
      display: inline-block;
      vertical-align: middle;
      width: 160px;
    }

    .pullDownMenu {
      display: inline-block;
      text-align: center;
    }

    .pullDownMenu:hover {
      background-color: #e0ecff;
    }

    select {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      height: 24px;
      vertical-align: middle;
      font-size: 12px;
    }

    select:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }

    span.math.inline a {
      color: #000000;
    }

    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #ffffff;
        color: #666666;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #666666;  padding-left: 4px; }
    div.sourceCode
      { color: #000000; background-color: #ffffff; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; text-decoration: underline; } /* Alert */
    code span.an { color: #666666; text-decoration: underline; } /* Annotation */
    code span.at { color: #333333; } /* Attribute */
    code span.bu { color: #000000; } /* BuiltIn */
    code span.cf { color: #666666; } /* ControlFlow */
    code span.ch { color: #b000b0; } /* Char */
    code span.cn { color: #000000; } /* Constant */
    code span.co { color: #008800; } /* Comment */
    code span.cv { color: #008800; } /* CommentVar */
    code span.do { color: #008800; } /* Documentation */
    code span.dt { color: #333333; } /* DataType */
    code span.dv { color: #0000ff; } /* DecVal */
    code span.er { color: #ffffff; background-color: #ff0000; } /* Error */
    code span.ex { color: #000000; } /* Extension */
    code span.fl { color: #0000ff; } /* Float */
    code span.im { color: #666666; } /* Import */
    code span.in { color: #666666; } /* Information */
    code span.kw { color: #666666; } /* Keyword */
    code span.op { color: #000000; } /* Operator */
    code span.ot { color: #000000; } /* Other */
    code span.pp { color: #666666; } /* Preprocessor */
    code span.sc { color: #b000b0; } /* SpecialChar */
    code span.ss { color: #b000b0; } /* SpecialString */
    code span.st { color: #b000b0; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #b000b0; } /* VerbatimString */
    code span.wa { color: #000000; background-color: #ffff00; text-decoration: underline; } /* Warning */
  </style>

    <script>
    MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script src="../lib/MathJax/es5/tex-chtml-full.js"
  type="text/javascript"></script>
    </head>

<body>
    <header>
    <p>
      何かあれば <a href="https://github.com/ryukau/filter_notes">GitHub のリポジトリ</a>に issue を作るか ryukau@gmail.com までお気軽にどうぞ。
    </p>
    <hr>
    <a href="../index.html">インデックスに戻る</a>
        <p>
      Update: 2024-08-06
    </p>
            <details>
      <summary translate="yes">Table of Contents</summary>
      <nav id="TOC" role="doc-toc">
        <ul>
        <li><a href="#オーディオプラグインの-ui-から入力された値の補間"
        id="toc-オーディオプラグインの-ui-から入力された値の補間">オーディオプラグインの
        UI から入力された値の補間</a>
        <ul>
        <li><a href="#素朴なパラメータの受け取り"
        id="toc-素朴なパラメータの受け取り">素朴なパラメータの受け取り</a></li>
        <li><a href="#バッファ内で線形補間"
        id="toc-バッファ内で線形補間">バッファ内で線形補間</a>
        <ul>
        <li><a href="#パラメータチューニング"
        id="toc-パラメータチューニング">パラメータチューニング</a></li>
        <li><a href="#異なる計算方法"
        id="toc-異なる計算方法">異なる計算方法</a></li>
        </ul></li>
        <li><a href="#exponential-moving-average-フィルタ"
        id="toc-exponential-moving-average-フィルタ">Exponential Moving
        Average フィルタ</a>
        <ul>
        <li><a href="#周波数特性"
        id="toc-周波数特性">周波数特性</a></li>
        <li><a href="#k_p-からカットオフ周波数を求める"
        id="toc-k_p-からカットオフ周波数を求める"><span
        class="math inline">\(k_p\)</span>
        からカットオフ周波数を求める</a></li>
        <li><a href="#カットオフ周波数から-k_p-を求める"
        id="toc-カットオフ周波数から-k_p-を求める">カットオフ周波数から
        <span class="math inline">\(k_p\)</span> を求める</a></li>
        <li><a href="#複素数を使わずにカットオフ周波数から-k_p-求める式"
        id="toc-複素数を使わずにカットオフ周波数から-k_p-求める式">複素数を使わずにカットオフ周波数から
        <span class="math inline">\(k_p\)</span> 求める式</a></li>
        <li><a href="#実装" id="toc-実装">実装</a></li>
        </ul></li>
        <li><a href="#rate-limiter" id="toc-rate-limiter">Rate
        Limiter</a>
        <ul>
        <li><a href="#仕様" id="toc-仕様">仕様</a></li>
        <li><a href="#実装-1" id="toc-実装-1">実装</a></li>
        </ul></li>
        <li><a href="#比較" id="toc-比較">比較</a></li>
        <li><a href="#その他" id="toc-その他">その他</a></li>
        <li><a href="#変更点" id="toc-変更点">変更点</a></li>
        </ul></li>
        </ul>
      </nav>
    </details>
      </header>
  <h1 id="オーディオプラグインの-ui-から入力された値の補間"><a
  href="#オーディオプラグインの-ui-から入力された値の補間"
  class="header-anchor" aria-hidden="true">オーディオプラグインの UI
  から入力された値の補間</a></h1>
  <p>VST 3 や LV2 ではオーディオ処理のメソッドが呼び出されるたびに UI
  (ユーザインタフェース)
  で変更されたパラメータが渡されます。更新するバッファ内で一定の値を使うだけだと滑らかでなくなるので補間します。</p>
  <h2 id="素朴なパラメータの受け取り"><a
  href="#素朴なパラメータの受け取り" class="header-anchor"
  aria-hidden="true">素朴なパラメータの受け取り</a></h2>
  <p>オーディオ処理のメソッドが呼び出される頻度のことをコントロールレートと呼ぶことがあります。オーディオデバイスのバッファの長さを
  <span class="math inline">\(L\)</span> 、サンプリング周波数を <span
  class="math inline">\(f_s\)</span> とするとコントロールレートは <span
  class="math inline">\(f_s / L\)</span> です。</p>
  <p>次のコードはバッファ単位で <code>process</code>
  を呼び出す例です。バッファに書き込み直す処理を <code>main</code> 内の
  <code>for</code>
  ループで回していますが、実際にはオーディオデバイスによる割り込みに応じて
  DAW のオーディオスレッドから呼び出されます。</p>
  <div class="sourceCode" id="cb1"><pre
  class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// naive.cpp</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstring&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> sampleRate <span class="op">=</span> <span class="fl">48000.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">size_t</span> nFrame <span class="op">=</span> <span class="dv">512</span><span class="op">;</span> <span class="co">// 式中の L 。</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">size_t</span> nBuffer <span class="op">=</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> DSP <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> gain <span class="op">=</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">;</span> <span class="co">// 適当なパラメータ。</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> process<span class="op">(</span><span class="at">const</span> <span class="dt">float</span> frame<span class="op">,</span> <span class="dt">float</span> <span class="op">*</span>out<span class="op">)</span> <span class="co">// オーディオ処理のメソッド</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> frame<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> out<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> gain<span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> wav<span class="op">(</span>nFrame <span class="op">*</span> nBuffer<span class="op">);</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> out<span class="op">[</span>nFrame<span class="op">];</span> <span class="co">// VST 3 や LV2 にならってバッファに C の配列を使う。</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>minstd_rand rng<span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>uniform_real_distribution<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> gainDist<span class="op">(</span><span class="fl">0.0</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  DSP dsp<span class="op">;</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> gainValue <span class="op">=</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> idx <span class="op">&lt;</span> nBuffer<span class="op">;</span> <span class="op">++</span>idx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>idx <span class="op">%</span> <span class="dv">4</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> gainValue <span class="op">=</span> gainDist<span class="op">(</span>rng<span class="op">);</span> <span class="co">// パラメータの更新頻度を下げる。</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    dsp<span class="op">.</span>gain <span class="op">=</span> gainValue<span class="op">;</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    dsp<span class="op">.</span>process<span class="op">(</span>nFrame<span class="op">,</span> out<span class="op">);</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>memcpy<span class="op">(&amp;</span>wav<span class="op">[</span>idx <span class="op">*</span> nFrame<span class="op">],</span> out<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">float</span><span class="op">)</span> <span class="op">*</span> nFrame<span class="op">);</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> writeWave<span class="op">(</span><span class="st">&quot;snd/naive.wav&quot;</span><span class="op">,</span> wav<span class="op">,</span> sampleRate<span class="op">);</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
  <p><code>writeWave</code>
  の実装を含む完成したコードは次のリンクに掲載しています。コンパイルには
  <a
  href="%5Blibsndfile%5D(http://www.mega-nerd.com/libsndfile/)">libsndfile</a>
  が必要です。</p>
  <ul>
  <li><a
  href="https://github.com/ryukau/filter_notes/blob/master/control_rate_interpolation/demo/naive.cpp">filter_notes/naive.cpp
  at master · ryukau/filter_notes · GitHub</a></li>
  </ul>
  <p>コンパイルして実行します。</p>
  <div class="sourceCode" id="cb2"><pre
  class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">g++</span> <span class="at">-lsndfile</span> <span class="at">-O3</span> naive.cpp</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./a.out</span></span></code></pre></div>
  <p>実行結果の波形です。</p>
  <figure>
  <img src="img/naive.png" alt="Image of naively received parameter." style="padding-bottom: 12px;"/>
  </figure>
  <p>図の波形に 100 Hz の正弦波を掛け合わせた音です。</p>
  <figure>
  <figcaption>
  Naive
  </figcaption>
  <audio controls>
  <source src="snd/sin_naive.wav" type="audio/wav">
  </audio>
  </figure>
  <p>バッファの境界で値が不連続に変化しているので、そのまま使うとノイズが乗ることがあります。</p>
  <p>不連続点が目立ってしまうパラメータの例としては、音量、フィルタのカットオフ周波数、ディレイ時間、オシレータの周波数などが挙げられます。特に
  IIR
  フィルタのカットオフ周波数を急激に変更すると発散することがあるのでパラメータを補間せずに使うことは避けたいです。</p>
  <p>パラメータによって変更される値が 1
  サンプルあたりの変化量を表しているときは不連続点が目立たないことがあります。実装によりますがエンベロープの傾きなどが例として挙げられます。</p>
  <h2 id="バッファ内で線形補間"><a href="#バッファ内で線形補間"
  class="header-anchor" aria-hidden="true">バッファ内で線形補間</a></h2>
  <p>サンプリング周波数とバッファサイズが固定ならパラメータが変化したときだけ次のバッファまで線形補間することでノイズが大きく減ります。</p>
  <p><strong>注意</strong>
  バッファサイズが可変のときは、この節で紹介している手法を使うとノイズが乗ります。後で紹介する
  exponential moving average フィルタを使う方法をお勧めします。 FL
  Studio 20.6 はバッファサイズが可変でした。</p>
  <p>デスクトップ環境では設定によってサンプリング周波数とバッファサイズが変わります。そこで古い値から新しい値へと更新される時間を指定できるようにします。</p>
  <p>まずはサンプリング周波数 <span class="math inline">\(f_s\)</span>
  とユーザが指定した新しい値へと更新される秒数 <span
  class="math inline">\(t\)</span>
  から、新しい値へと更新されるサンプル数 <span
  class="math inline">\(n\)</span> を求めます。</p>
  <p><span class="math display">\[
  n = t f_s
  \]</span></p>
  <p>次に新しく受け取ったパラメータの値 <span
  class="math inline">\(p\)</span> 、 1
  つ前のバッファの終端でのパラメータの値 <span
  class="math inline">\(p_1\)</span> 、 バッファの長さ <span
  class="math inline">\(L\)</span>
  を使って、現在のバッファの終端でのパラメータの値 <span
  class="math inline">\(p_0\)</span> を計算します。</p>
  <p><span class="math display">\[
  p_0 = \frac{L}{n} (p - p_1) + p_1
  \]</span></p>
  <p>そしてバッファ内でのパラメータの値 <span
  class="math inline">\(p_i\)</span>
  をバッファの先頭から経過したサンプル数 <span
  class="math inline">\(i\)</span> を使って計算します。この式は <span
  class="math inline">\(p_1\)</span> と <span
  class="math inline">\(p_0\)</span> の線形補間です。</p>
  <p><span class="math display">\[
  p_i = p_1 + \frac{i}{L} (p_0 - p_1)
  \]</span></p>
  <p>この計算は指定した時間で目的の値に到達しませんがシンセサイザで使うには十分です。より正確に指定したいときはパラメータチューニングの項を参照してください。</p>
  <p>実装します。</p>
  <div class="sourceCode" id="cb3"><pre
  class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> sampleRate <span class="op">=</span> <span class="fl">48000.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">size_t</span> nFrame <span class="op">=</span> <span class="dv">512</span><span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">size_t</span> nBuffer <span class="op">=</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">class</span> Smoother <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setSampleRate<span class="op">(</span>Sample sampleRate<span class="op">,</span> Sample time <span class="op">=</span> <span class="fl">0.04</span><span class="op">)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span>sampleRate <span class="op">=</span> sampleRate<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    setTime<span class="op">(</span>time<span class="op">);</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setTime<span class="op">(</span>Sample seconds<span class="op">)</span> <span class="op">{</span> timeInSamples <span class="op">=</span> seconds <span class="op">*</span> sampleRate<span class="op">;</span> <span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setBufferSize<span class="op">(</span>Sample bufferSize<span class="op">)</span> <span class="op">{</span> <span class="kw">this</span><span class="op">-&gt;</span>bufferSize <span class="op">=</span> bufferSize<span class="op">;</span> <span class="op">}</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">inline</span> Sample getValue<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> value<span class="op">;</span> <span class="op">}</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> push<span class="op">(</span>Sample newTarget<span class="op">)</span> <span class="co">// newTarget は式中の p 。</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    p1 <span class="op">=</span> p0<span class="op">;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    p0 <span class="op">=</span> timeInSamples <span class="op">&gt;=</span> bufferSize</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;&amp;</span> fabs<span class="op">(</span>p0 <span class="op">-</span> newTarget<span class="op">)</span> <span class="op">&gt;=</span> Sample<span class="op">(</span><span class="fl">1e-5</span><span class="op">)</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> <span class="op">(</span>newTarget <span class="op">-</span> p0<span class="op">)</span> <span class="op">*</span> bufferSize <span class="op">/</span> timeInSamples <span class="op">+</span> p0</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> newTarget<span class="op">;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span><span class="dt">float</span> index<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value <span class="op">=</span> p1 <span class="op">+</span> index <span class="op">/</span> bufferSize <span class="op">*</span> <span class="op">(</span>p0 <span class="op">-</span> p1<span class="op">);</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="kw">protected</span><span class="op">:</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  Sample sampleRate <span class="op">=</span> <span class="dv">44100</span><span class="op">;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  Sample timeInSamples <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span> <span class="co">// 式中の n 。</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  Sample bufferSize <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>     <span class="co">// 式中の L 。</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  Sample p0 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  Sample p1 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  Sample value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>          <span class="co">// 1 フレーム内で計算結果を 2 回以上使うときに必要。</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> DSP <span class="op">{</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  Smoother<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> gain<span class="op">;</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> process<span class="op">(</span><span class="at">const</span> <span class="dt">size_t</span> frame<span class="op">,</span> <span class="dt">float</span> <span class="op">*</span>out<span class="op">)</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> frame<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> out<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> gain<span class="op">.</span>process<span class="op">(</span>i<span class="op">);</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> wav<span class="op">(</span>nFrame <span class="op">*</span> nBuffer<span class="op">);</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> out<span class="op">[</span>nFrame<span class="op">];</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>minstd_rand rng<span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>uniform_real_distribution<span class="op">&lt;</span><span class="dt">float</span><span class="op">&gt;</span> gainDist<span class="op">(</span><span class="fl">0.0</span><span class="bu">f</span><span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  DSP dsp<span class="op">;</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  dsp<span class="op">.</span>gain<span class="op">.</span>setSampleRate<span class="op">(</span>sampleRate<span class="op">,</span> <span class="fl">0.02</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> gainValue <span class="op">=</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> idx <span class="op">&lt;</span> nBuffer<span class="op">;</span> <span class="op">++</span>idx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>idx <span class="op">%</span> <span class="dv">4</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> gainValue <span class="op">=</span> gainDist<span class="op">(</span>rng<span class="op">);</span> <span class="co">// パラメータの更新頻度を下げる。</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    dsp<span class="op">.</span>gain<span class="op">.</span>setBufferSize<span class="op">(</span>nFrame<span class="op">);</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    dsp<span class="op">.</span>gain<span class="op">.</span>push<span class="op">(</span>gainValue<span class="op">);</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    dsp<span class="op">.</span>process<span class="op">(</span>nFrame<span class="op">,</span> out<span class="op">);</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>memcpy<span class="op">(&amp;</span>wav<span class="op">[</span>idx <span class="op">*</span> nFrame<span class="op">],</span> out<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">float</span><span class="op">)</span> <span class="op">*</span> nFrame<span class="op">);</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> writeWave<span class="op">(</span><span class="st">&quot;snd/smoother.wav&quot;</span><span class="op">,</span> wav<span class="op">,</span> sampleRate<span class="op">);</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
  <p>完成したコードへのリンクです。</p>
  <ul>
  <li><a
  href="https://github.com/ryukau/filter_notes/blob/master/control_rate_interpolation/demo/smoother.cpp">filter_notes/smoother.cpp
  at master · ryukau/filter_notes · GitHub</a></li>
  </ul>
  <p>実行結果です。</p>
  <figure>
  <img src="img/smoother.png" alt="Image of smoothed parameter." style="padding-bottom: 12px;"/>
  </figure>
  <h3 id="パラメータチューニング"><a href="#パラメータチューニング"
  class="header-anchor"
  aria-hidden="true">パラメータチューニング</a></h3>
  <p><span class="math inline">\(p_0\)</span> の振る舞いは指数関数的減衰
  (exponential decay) になります。経過したバッファ数を <span
  class="math inline">\(j\)</span> として <span class="math inline">\(L,
  n, p\)</span> を固定します。さらに <span class="math inline">\(\alpha
  = L / n,\ p_1 = 0\)</span> とすれば次のように書き直せます。</p>
  <p><span class="math display">\[
  p_0 = \alpha^j p
  \]</span></p>
  <p><span class="math inline">\(\alpha^j\)</span> が適当なしきい値
  <span class="math inline">\(\epsilon\)</span>
  に到達する時間を求めます。</p>
  <p><span class="math display">\[
  \begin{aligned}
  \epsilon &amp;= \alpha^j \\
  j &amp;= \frac{\log \epsilon}{\log \alpha}
  \end{aligned}
  \]</span></p>
  <p>また <span class="math inline">\(\epsilon\)</span> と <span
  class="math inline">\(j\)</span> が分かっているとき <span
  class="math inline">\(\alpha = \epsilon^{\frac{1}{j}}\)</span>
  です。</p>
  <h3 id="異なる計算方法"><a href="#異なる計算方法"
  class="header-anchor" aria-hidden="true">異なる計算方法</a></h3>
  <p>Uhhyou Plugins
  では以前、異なる計算方法を使っていたので記録しておきます。</p>
  <p><code>Smoother::process()</code> での計算式を再掲します。</p>
  <div class="sourceCode" id="cb4"><pre
  class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>value <span class="op">=</span> p1 <span class="op">+</span> index <span class="op">/</span> bufferSize <span class="op">*</span> <span class="op">(</span>p0 <span class="op">-</span> p1<span class="op">);</span></span></code></pre></div>
  <p><code>index</code> はバッファ内のインデックスです。 1
  サンプルあたりに <code>value</code>
  が増える量を事前に計算しておけばバッファ内のインデックスを使わずに計算できます。</p>
  <div class="sourceCode" id="cb5"><pre
  class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">class</span> SmootherRamp <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setSampleRate<span class="op">(</span>Sample sampleRate<span class="op">,</span> Sample time <span class="op">=</span> <span class="fl">0.04</span><span class="op">)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span>sampleRate <span class="op">=</span> sampleRate<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    timeInSamples <span class="op">=</span> seconds <span class="op">*</span> sampleRate<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setBufferSize<span class="op">(</span>Sample bufferSize<span class="op">)</span> <span class="op">{</span> <span class="kw">this</span><span class="op">-&gt;</span>bufferSize <span class="op">=</span> bufferSize<span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> push<span class="op">(</span>Sample newTarget<span class="op">)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    target <span class="op">=</span> newTarget<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>timeInSamples <span class="op">&lt;</span> bufferSize<span class="op">)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      value <span class="op">=</span> target<span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>      ramp <span class="op">=</span> <span class="op">(</span>target <span class="op">-</span> value<span class="op">)</span> <span class="op">/</span> timeInSamples<span class="op">;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">()</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>value <span class="op">==</span> target<span class="op">)</span> <span class="cf">return</span> value<span class="op">;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    value <span class="op">+=</span> ramp<span class="op">;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fabs<span class="op">(</span>value <span class="op">-</span> target<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1e-5</span><span class="op">)</span> value <span class="op">=</span> target<span class="op">;</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value<span class="op">;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="kw">protected</span><span class="op">:</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  Sample sampleRate <span class="op">=</span> <span class="dv">44100</span><span class="op">;</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  Sample timeInSamples <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  Sample bufferSize <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  Sample value <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  Sample target <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  Sample ramp <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span> <span class="co">// 1 サンプルあたりに value が増える量。</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
  <p>指定されたスムーシング時間がバッファ長よりも短いときは
  <code>push()</code>
  の条件分岐によってスムーシングを無効にしています。</p>
  <p><code>process()</code> の条件分岐
  <code>fabs(value - target) &lt; 1e-5</code>
  でオーバーシュートを防いでいます。 <code>1e-5</code>
  は適当に決めた値です。パラメータの値の範囲が広いときは
  <code>1e-5</code>
  をより大きな値に変えないと上手く動かない可能性があるので、この実装は危険です。</p>
  <p>1
  サンプルあたりの増加量を使う方法はバッファ内のインデックスを使う方法よりも遅いです。スムーシング時間が固定でオーバーシュートがあってもいいなら
  <code>process()</code>
  内の条件分岐を消せるので使えるかもしれません。</p>
  <p>ベンチマークに使ったコードを次のリンクに掲載しています。</p>
  <ul>
  <li><a
  href="https://github.com/ryukau/filter_notes/blob/master/control_rate_interpolation/demo/bench_smoother.cpp">filter_notes/bench_smoother.cpp
  at master · ryukau/filter_notes · GitHub</a></li>
  </ul>
  <h2 id="exponential-moving-average-フィルタ"><a
  href="#exponential-moving-average-フィルタ" class="header-anchor"
  aria-hidden="true">Exponential Moving Average フィルタ</a></h2>
  <p>Exponential moving average (EMA)
  フィルタはステップ応答が指数関数となる 1
  次ローパスフィルタです。エンベロープの角を取って滑らかにするときにも使えます。</p>
  <p>EMA フィルタの素朴な実装です。</p>
  <div class="sourceCode" id="cb6"><pre
  class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">class</span> EmaFilter <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setup<span class="op">(</span>Sample p<span class="op">)</span> <span class="op">{</span> kp <span class="op">=</span> <span class="bu">std::</span>clamp<span class="op">&lt;</span>Sample<span class="op">&gt;(</span>p<span class="op">,</span> Sample<span class="op">(</span><span class="dv">0</span><span class="op">),</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">));</span> <span class="op">}</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> reset<span class="op">()</span> <span class="op">{</span> value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample input<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> value <span class="op">+=</span> kp <span class="op">*</span> <span class="op">(</span>input <span class="op">-</span> value<span class="op">);</span> <span class="op">}</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  Sample kp <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Range in [0, 1].</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  Sample value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
  <h3 id="周波数特性"><a href="#周波数特性" class="header-anchor"
  aria-hidden="true">周波数特性</a></h3>
  <p><code>EmaFilter</code> の伝達関数を出します。
  <code>process()</code> での計算式です。</p>
  <div class="sourceCode" id="cb7"><pre
  class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>value <span class="op">+=</span> kp <span class="op">*</span> <span class="op">(</span>input <span class="op">-</span> value<span class="op">);</span></span></code></pre></div>
  <p><span class="math inline">\(n\)</span> を経過サンプル数とすると
  <code>value</code> は <span class="math inline">\(y[n - 1]\)</span> 、
  <code>input</code> は <span class="math inline">\(x[n]\)</span>
  となります。出力は <span class="math inline">\(y[n]\)</span> です。
  <code>process()</code> の計算式の記号を置き換えます。</p>
  <p><span class="math display">\[
  \begin{aligned}
  y[n] &amp;= y[n - 1] + k_p (x[n] - y[n - 1]) \\
  y[n] + (k_p - 1) y[n - 1] &amp;= k_p x[n]
  \end{aligned}
  \]</span></p>
  <p>出力 <span class="math inline">\(y\)</span>
  の項だけを集めた左辺を使って入力 <span
  class="math inline">\(x\)</span>
  の項だけを集めた右辺を割ることで伝達関数が得られます。</p>
  <p><span class="math display">\[
  H(z) = \frac{k_p}{1 + (k_p - 1) z^{-1}}
  \]</span></p>
  <p><code>EmaFilter</code> の振幅特性です。ローパスに近い特性です。</p>
  <figure>
  <img src="img/emafilter_amplitude.png" alt="Image of amplitude response of P controller." style="padding-bottom: 12px;"/>
  </figure>
  <p><code>EmaFilter</code> の位相特性です。</p>
  <figure>
  <img src="img/emafilter_phase.png" alt="Image of phase response of P controller." style="padding-bottom: 12px;"/>
  </figure>
  <h3 id="k_p-からカットオフ周波数を求める"><a
  href="#k_p-からカットオフ周波数を求める" class="header-anchor"
  aria-hidden="true"><span class="math inline">\(k_p\)</span>
  からカットオフ周波数を求める</a></h3>
  <p>伝達関数 <span class="math inline">\(H(z)\)</span>
  からカットオフ周波数 <span class="math inline">\(\omega\)</span>
  を求めます。</p>
  <p><span class="math display">\[
  \begin{aligned}
  |H(e^{j \omega})|
    = \frac{1}{\sqrt{2}}
    &amp;= \left| \frac{k_p}{1 + (k_p - 1) e^{-j \omega}} \right| \\
  \end{aligned}
  \]</span></p>
  <p>Maxima で <span class="math inline">\(\omega\)</span>
  について解きます。</p>
  <div class="sourceCode" id="cb8"><pre
  class="sourceCode maxima"><code class="sourceCode maxima"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ω<span class="cn">_eq</span>: <span class="fu">solve</span>(<span class="dv">1</span>/<span class="dv">2</span> = (<span class="cn">k_p</span> / (<span class="dv">1</span> + (<span class="cn">k_p</span> - <span class="dv">1</span>) * <span class="fu">exp</span>(-<span class="va">%i</span> * ω)))^<span class="dv">2</span>, ω);</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ratsimp</span>(ω<span class="cn">_eq</span>);</span></code></pre></div>
  <p>出力です。2つの解が出てきたので <span
  class="math inline">\(\omega_1\)</span> と <span
  class="math inline">\(\omega_2\)</span> という名前をつけています。</p>
  <p><span class="math display">\[
  \omega_1 = -j \log{\left( -\frac{\sqrt{2}\, {{{k_p}}^{2}}+\left(
  -\sqrt{2}-1\right) \, {k_p}+1}{2 {{{k_p}}^{2}}-1}\right) }
  \operatorname{,}\quad
  \omega_2 = -j \log{\left( \frac{\sqrt{2}\, {{{k_p}}^{2}}+\left(
  1-\sqrt{2}\right) \, {k_p}-1}{2 {{{k_p}}^{2}}-1}\right) }
  \]</span></p>
  <p><span class="math inline">\(\omega_1\)</span> は虚数 <span
  class="math inline">\(j\)</span>
  を外してプロットするとそれらしい曲線が出てきます。カットオフ周波数は縦軸です。
  <span class="math inline">\(\pi\)</span>
  を超えているのは、そういうものなのか計算誤差なのか判断できていません。</p>
  <div class="sourceCode" id="cb9"><pre
  class="sourceCode maxima"><code class="sourceCode maxima"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot2d</span>(-<span class="fu">log</span>(-(<span class="fu">sqrt</span>(<span class="dv">2</span>)*<span class="cn">k_p</span>^<span class="dv">2</span>+(-<span class="fu">sqrt</span>(<span class="dv">2</span>)<span class="dv">-1</span>)*<span class="cn">k_p</span><span class="dv">+1</span>)/(<span class="dv">2</span>*<span class="cn">k_p</span>^<span class="dv">2-1</span>)), [<span class="cn">k_p</span>, <span class="dv">0</span>, <span class="fl">1.1</span>]);</span></code></pre></div>
  <figure>
  <img src="img/emafilter_kp_omega_plot.svg" alt="Image of k_p-omega plot." style="width: 480px;padding-bottom: 12px;"/>
  </figure>
  <h3 id="カットオフ周波数から-k_p-を求める"><a
  href="#カットオフ周波数から-k_p-を求める" class="header-anchor"
  aria-hidden="true">カットオフ周波数から <span
  class="math inline">\(k_p\)</span> を求める</a></h3>
  <p><span class="math inline">\(\omega\)</span> の式を <span
  class="math inline">\(k_p\)</span> について解きます。</p>
  <div class="sourceCode" id="cb10"><pre
  class="sourceCode maxima"><code class="sourceCode maxima"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cn">k_eq</span>: <span class="fu">solve</span>(<span class="dv">1</span>/<span class="dv">2</span> = (<span class="cn">k_p</span> / (<span class="dv">1</span> + (<span class="cn">k_p</span> - <span class="dv">1</span>) * <span class="fu">exp</span>(-<span class="va">%i</span> * ω)))^<span class="dv">2</span>, <span class="cn">k_p</span>);</span></code></pre></div>
  <p>出力です。試しに計算したところ <span
  class="math inline">\(k_{p,2}\)</span>
  を使うと正しい値が得られました。</p>
  <p><span class="math display">\[
  \begin{aligned}
  k_{p,1} &amp;= -\frac{\sqrt{2} e^{2 j \omega} + (-\sqrt{2} - 1) e^{j
  \omega} + 1}{2 e^{2 j \omega} - 1} \\
  k_{p,2} &amp;= \frac{\sqrt{2} {e^{2 j \omega}} + (1 - \sqrt{2}) e^{j
  \omega} - 1}{2 e^{2 j \omega} - 1}
  \end{aligned}
  \]</span></p>
  <p>次の図の縦線がカットオフ周波数 <span
  class="math inline">\(\omega\)</span>
  を表しています。同じ色の曲線は振幅特性です。対応するカットオフ周波数と振幅特性が全て
  -3 dB で交差しているので正しく計算できています。</p>
  <figure>
  <img src="img/emafilter_cutoff.png" alt="Image of ." style="padding-bottom: 12px;"/>
  </figure>
  <h3 id="複素数を使わずにカットオフ周波数から-k_p-求める式"><a
  href="#複素数を使わずにカットオフ周波数から-k_p-求める式"
  class="header-anchor"
  aria-hidden="true">複素数を使わずにカットオフ周波数から <span
  class="math inline">\(k_p\)</span> 求める式</a></h3>
  <p>dsp.stackexchange.com で回答を見つけました。 <span
  class="math inline">\(f_c\)</span> はカットオフ周波数、 <span
  class="math inline">\(f_s\)</span> はサンプリング周波数です。</p>
  <p><span class="math display">\[
  k_p = -y + \sqrt{y^2 + 2y}, \quad y = 1 - \cos(2 \pi f_c / f_s)
  \]</span></p>
  <p>Maxima で解くときは <code>cabs</code> と <code>trigsimp</code>
  が使えます。</p>
  <div class="sourceCode" id="cb11"><pre
  class="sourceCode maxima"><code class="sourceCode maxima"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cn">H_</span>ω: <span class="cn">k_p</span> / (<span class="dv">1</span> - (<span class="dv">1</span> - <span class="cn">k_p</span>) * <span class="cn">exp</span>(-<span class="va">%i</span> * ω));</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cn">H_</span>ω<span class="cn">_abs</span>: <span class="cn">trigsimp</span>(<span class="fu">cabs</span>(<span class="cn">H_</span>ω));</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(<span class="dv">1</span> / <span class="dv">2</span> = <span class="cn">H_</span>ω<span class="cn">_abs</span>^<span class="dv">2</span>, <span class="cn">k_p</span>);</span></code></pre></div>
  <p><span class="math display">\[
  \left| H(e^{j \omega}) \right| = \frac{\left| {k_p}\right|
  }{\sqrt{\left( 2 {k_p}-2\right)  \cos{\left( \omega \right)
  }+{{{k_p}}^{2}}-2 {k_p}+2}}
  \]</span></p>
  <p><span class="math display">\[
  {k_p}=-\sqrt{{{\cos{\left( \omega \right) }}^{2}}-4 \cos{\left( \omega
  \right) }+3}+\cos{\left( \omega \right) }-1\operatorname{,}\quad
  {k_p}=\sqrt{{{\cos{\left( \omega \right) }}^{2}}-4 \cos{\left( \omega
  \right) }+3}+\cos{\left( \omega \right) }-1
  \]</span></p>
  <ul>
  <li><a
  href="https://dsp.stackexchange.com/questions/54086/single-pole-iir-low-pass-filter-which-is-the-correct-formula-for-the-decay-coe">Single-pole
  IIR low-pass filter - which is the correct formula for the decay
  coefficient? - Signal Processing Stack Exchange</a></li>
  <li><a
  href="https://dsp.stackexchange.com/questions/28308/exponential-weighted-moving-average-time-constant/28314#28314">digital
  filters - Exponential weighted moving average time constant - Signal
  Processing Stack Exchange</a></li>
  <li><a
  href="https://dsp.stackexchange.com/questions/26941/how-frequency-response-related-to-a-transfer-function">How
  frequency response related to a transfer function - Signal Processing
  Stack Exchange</a></li>
  <li><a
  href="https://tttapa.github.io/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential%20Moving%20Average/Exponential-Moving-Average.pdf">Exponential-Moving-Average.pdf</a></li>
  </ul>
  <h3 id="実装"><a href="#実装" class="header-anchor"
  aria-hidden="true">実装</a></h3>
  <p>C++ です。カットオフ周波数から <span
  class="math inline">\(k_p\)</span>
  を求めるメソッドが追加されています。</p>
  <div class="sourceCode" id="cb12"><pre
  class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">class</span> EmaFilter <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// float 型での cutoffHz の下限は 3~4 Hz 程度。</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> Sample cutoffToP<span class="op">(</span>Sample sampleRate<span class="op">,</span> Sample cutoffHz<span class="op">)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> omega_c <span class="op">=</span> Sample<span class="op">(</span>twopi<span class="op">)</span> <span class="op">*</span> cutoffHz <span class="op">/</span> sampleRate<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> y <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">-</span> cos<span class="op">(</span>omega_c<span class="op">);</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>y <span class="op">+</span> sqrt<span class="op">((</span>y <span class="op">+</span> Sample<span class="op">(</span><span class="dv">2</span><span class="op">))</span> <span class="op">*</span> y<span class="op">);</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setup<span class="op">(</span>Sample p<span class="op">)</span> <span class="op">{</span> kp <span class="op">=</span> <span class="bu">std::</span>clamp<span class="op">&lt;</span>Sample<span class="op">&gt;(</span>p<span class="op">,</span> Sample<span class="op">(</span><span class="dv">0</span><span class="op">),</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">));</span> <span class="op">}</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> reset<span class="op">()</span> <span class="op">{</span> value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample input<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> value <span class="op">+=</span> kp <span class="op">*</span> <span class="op">(</span>input <span class="op">-</span> value<span class="op">);</span> <span class="op">}</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  Sample kp <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Range in [0, 1].</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  Sample value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
  <p><code>cutoffHz = 30</code> としたときの出力です。</p>
  <figure>
  <img src="img/emafilter.png" alt="Image of EmaFilter output." style="padding-bottom: 12px;"/>
  </figure>
  <p>テストに使ったコードへのリンクです。</p>
  <ul>
  <li><a
  href="https://github.com/ryukau/filter_notes/blob/master/control_rate_interpolation/demo/emafilter.cpp">filter_notes/emafilter.cpp
  at master · ryukau/filter_notes · GitHub</a></li>
  </ul>
  <h2 id="rate-limiter"><a href="#rate-limiter" class="header-anchor"
  aria-hidden="true">Rate Limiter</a></h2>
  <p>mathworks.com で紹介されていた Rate Limiter を実装します。 Rate
  Limiter を通った信号は 1
  サンプルあたりの増加量が制限されます。出力波形は線形補間と同じですが、パラメータとして傾きを指定する点が異なります。</p>
  <ul>
  <li><a
  href="https://www.mathworks.com/help/simulink/slref/ratelimiter.html">Limit
  rate of change of signal - Simulink</a></li>
  </ul>
  <h3 id="仕様"><a href="#仕様" class="header-anchor"
  aria-hidden="true">仕様</a></h3>
  <p>まず 1 サンプルあたりの増加量 <span
  class="math inline">\(\mathrm{rate}\)</span> を計算します。</p>
  <p><span class="math display">\[
  \mathrm{rate} = \frac{x[i] - y[i - 1]}{\Delta t}, \quad \Delta t =
  t[i] - t[i - 1].
  \]</span></p>
  <p><span class="math inline">\(x\)</span> は入力信号、 <span
  class="math inline">\(y\)</span> は出力信号、 <span
  class="math inline">\(t\)</span> は秒数、 インデックス <span
  class="math inline">\(i\)</span>
  は経過したサンプル数です。インデックス <span class="math inline">\(i -
  1\)</span> は 1 サンプル前の値を表しています。</p>
  <p><span class="math inline">\(\mathrm{rate}\)</span> を使って出力
  <span class="math inline">\(y[i]\)</span> を計算します。</p>
  <p><span class="math display">\[
  \begin{aligned}
  y[i] =&amp; \begin{cases}
    \Delta t \cdot R + y[i - 1] &amp; \text{if} \enspace \mathrm{rate}
  &gt; R, \\
    \Delta t \cdot F + y[i - 1] &amp; \text{if} \enspace \mathrm{rate}
  &lt; F, \\
    x[i]                        &amp; \text{otherwise.}
  \end{cases}
  \\
  &amp; R &gt; 0, \quad F &lt; 0.
  \end{aligned}
  \]</span></p>
  <p><span class="math inline">\(R\)</span> は <ruby>Rising slew
  rate<rt>ライジング スルー レート</rt></ruby> 、 <span
  class="math inline">\(F\)</span> は <ruby>Falling slew
  rate<rt>フォーリング スルー レート</rt></ruby>
  です。どちらもユーザが指定する実数です。</p>
  <h3 id="実装-1"><a href="#実装-1" class="header-anchor"
  aria-hidden="true">実装</a></h3>
  <p>C++ です。</p>
  <div class="sourceCode" id="cb13"><pre
  class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">class</span> RateLimiter <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setup<span class="op">(</span>Sample sampleRate<span class="op">)</span> <span class="op">{</span> dt <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">/</span> sampleRate<span class="op">;</span> <span class="op">}</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> reset<span class="op">()</span> <span class="op">{</span> y1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setRate<span class="op">(</span>Sample risingSlewRate<span class="op">,</span> Sample fallingSlewRate<span class="op">)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    rise <span class="op">=</span> risingSlewRate<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    fall <span class="op">=</span> fallingSlewRate<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample input<span class="op">)</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> rate <span class="op">=</span> <span class="op">(</span>input <span class="op">-</span> y1<span class="op">)</span> <span class="op">/</span> dt<span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rate <span class="op">&gt;</span> rise<span class="op">)</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>      y1 <span class="op">+=</span> dt <span class="op">*</span> rise<span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>rate <span class="op">&lt;</span> fall<span class="op">)</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>      y1 <span class="op">+=</span> dt <span class="op">*</span> fall<span class="op">;</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>      y1 <span class="op">=</span> input<span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y1<span class="op">;</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  Sample dt <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="fl">44100.0</span><span class="op">;</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  Sample y1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  Sample rise <span class="op">=</span> <span class="dv">10000</span><span class="op">;</span>  <span class="co">// 正の値であるべき。</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  Sample fall <span class="op">=</span> <span class="op">-</span><span class="dv">10000</span><span class="op">;</span> <span class="co">// 負の値であるべき。</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
  <p><code>rise = 26.041666, fall = -52.083332</code>
  としたときの出力です。</p>
  <figure>
  <img src="img/rate_limiter.png" alt="Image of Rate Limiter output." style="padding-bottom: 12px;"/>
  </figure>
  <p>テストに使ったコードへのリンクです。</p>
  <ul>
  <li><a
  href="https://github.com/ryukau/filter_notes/blob/master/control_rate_interpolation/demo/rate_limiter.cpp">filter_notes/rate_limiter.cpp
  at master · ryukau/filter_notes · GitHub</a></li>
  </ul>
  <h2 id="比較"><a href="#比較" class="header-anchor"
  aria-hidden="true">比較</a></h2>
  <p>出力を比較しやすいように再掲します。</p>
  <p>素朴な実装の結果の再掲です。</p>
  <figure>
  <img src="img/naive.png" alt="Image of naively received parameter." style="padding-bottom: 12px;"/>
  </figure>
  <p>パラメータが変更されたバッファのみ線形補間したときの結果も掲載します。手間を省きたいときは線形補間で十分です。</p>
  <figure>
  <img src="img/linterp.png" alt="Image of linear interpolated parameter." style="padding-bottom: 12px;"/>
  </figure>
  <p><code>linterp</code> のコードへのリンク: <a
  href="https://github.com/ryukau/filter_notes/blob/master/control_rate_interpolation/demo/linterp.cpp">filter_notes/linterp.cpp
  at master · ryukau/filter_notes · GitHub</a></p>
  <p>バッファ内で線形補間の節で実装した <code>Smoother</code>
  の実行結果です。</p>
  <figure>
  <img src="img/smoother.png" alt="Image of smoothed parameter." style="padding-bottom: 12px;"/>
  </figure>
  <p>EmaFilter の出力です。 <code>Smoother</code>
  よりも滑らかですが、完全に 0 や 1 になるには時間がかかります。</p>
  <figure>
  <img src="img/emafilter.png" alt="Image of EmaFilter output." style="padding-bottom: 12px;"/>
  </figure>
  <p>Rate Limiter の出力です。 <code>linterp</code>
  とほぼ同じですが、立ち上がりと立ち下りの傾きを独立に指定できます。</p>
  <figure>
  <img src="img/rate_limiter.png" alt="Image of Rate Limiter output." style="padding-bottom: 12px;"/>
  </figure>
  <p>図の波形に 100 Hz
  のサイン波を掛け合わせた音です。素朴な実装と比べるとどれもポップノイズが減っています。</p>
  <figure>
  <figcaption>
  Naive
  </figcaption>
  <audio controls>
  <source src="snd/sin_naive.wav" type="audio/wav">
  </audio>
  </figure>
  <figure>
  <figcaption>
  Linterp
  </figcaption>
  <audio controls>
  <source src="snd/sin_linterp.wav" type="audio/wav">
  </audio>
  </figure>
  <figure>
  <figcaption>
  Smoother
  </figcaption>
  <audio controls>
  <source src="snd/sin_smoother.wav" type="audio/wav">
  </audio>
  </figure>
  <figure>
  <figcaption>
  EmaFilter
  </figcaption>
  <audio controls>
  <source src="snd/sin_emafilter.wav" type="audio/wav">
  </audio>
  </figure>
  <figure>
  <figcaption>
  Rate Limiter
  </figcaption>
  <audio controls>
  <source src="snd/sin_rate_limiter.wav" type="audio/wav">
  </audio>
  </figure>
  <h2 id="その他"><a href="#その他" class="header-anchor"
  aria-hidden="true">その他</a></h2>
  <p>Slew limiter
  と呼ばれるアナログシンセサイザのモジュールが挙動や用途としては近そうです。</p>
  <ul>
  <li><a href="http://www.doepfer.de/a170.htm">A-170</a></li>
  <li><a href="https://www.synthesizers.com/q105.html">Q105 Slew Limiter
  - Analog Modular Synthesizers for Electronic Music by
  Synthesizers.com</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Slew_rate">Slew rate -
  Wikipedia</a></li>
  </ul>
  <h2 id="変更点"><a href="#変更点" class="header-anchor"
  aria-hidden="true">変更点</a></h2>
  <ul>
  <li>2024/05/06
  <ul>
  <li>“P Controller” という呼び方を、一般的な用語の “exponential moving
  average フィルタ” に置換。</li>
  </ul></li>
  <li>2020/03/26
  <ul>
  <li>文章の整理。</li>
  <li><code>P Controller</code> を <code>直線の ADSR エンベロープ</code>
  から移動。</li>
  <li><code>Rate Limiter</code> を追加。</li>
  <li><code>比較</code> を追加。</li>
  </ul></li>
  </ul>
    <footer>
    <a href="../index.html">インデックスに戻る</a>
  </footer>
</body>

</html>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja" >

<head>
<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<meta name="dcterms.date" content="2024-06-25" />
<title>resonant_one_pole_filter</title>

<!-- MathJax -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
window.MathJax = {
  tex: {
    tags: 'ams'
  }
};
</script>

<style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #666666;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #666666;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; text-decoration: underline; } /* Alert */
code span.an { color: #666666; font-style: italic; } /* Annotation */
code span.at { color: #906000; } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #000000; font-weight: bold; } /* ControlFlow */
code span.ch { color: #b000b0; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008800; } /* Comment */
code span.cv { color: #008800; } /* CommentVar */
code span.do { color: #008800; } /* Documentation */
code span.dt { color: #906000; } /* DataType */
code span.dv { color: #0000ff; } /* DecVal */
code span.er { color: #ffffff; background-color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000ff; } /* Float */
code span.im { color: #000000; font-weight: bold; } /* Import */
code span.in { color: #666666; } /* Information */
code span.kw { color: #000000; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #000000; } /* Other */
code span.pp { color: #000000; font-weight: bold; } /* Preprocessor */
code span.sc { color: #b000b0; } /* SpecialChar */
code span.ss { color: #b000b0; } /* SpecialString */
code span.st { color: #b000b0; } /* String */
code span.va { color: #000088; } /* Variable */
code span.vs { color: #b000b0; } /* VerbatimString */
code span.wa { background-color: #ffff00; font-weight: bold; font-style: italic; text-decoration: underline; } /* Warning */
</style>
<style>
body {
max-width: 704px;
margin: auto;
padding: 32px 8px;
}

img {
max-width: 100%;
}

video {
max-width: 100%;
}

kbd {
font-family: inherit;
border-style: solid;
border-width: 1px 2px 2px 1px;
border-radius: 2px;
padding: 4px;
margin: 2px;
line-height: calc(1em + 16px);
}

a {
text-decoration: none;
}

.header-anchor {
color: #000000;
}

.header-anchor:hover {
color: #0000EE;
}

.header-anchor:hover::after {
display: inline-block;
font-size: min(1em, 1rem);
content: '(クリックでここへリンク)';
padding-left: 1em;
color: #0000EE;
}

h2 {
border-left: solid 32px #000000;
padding-left: 24px;
}

h3 {
border-left: solid 20px #404040;
padding-left: 16px;
}

h4 {
font-size: 100%;
border-left: solid 12px #606060;
padding-left: 8px;
}

h5 {
font-size: 90%;
border-left: solid 4px #808080;
padding-left: 4px;
}

h6 {
font-size: 80%;
border-left: solid 2px #a0a0a0;
padding-left: 2px;
}

table {
border-spacing: 0px;
border-collapse: separate;
border-left: 1px solid #888888;
border-right: 1px solid #888888;
border-top: 1px solid #888888;
border-bottom: hidden;
}

tr:nth-child(odd) {
background: #eeeeee;
}

tr:nth-child(even) {
background: #ffffff;
}

th {
height: 2em;
padding: 4px 1em 4px 1em;
background: #ffffff;
border-bottom: 1px solid #888888;
}

th:not(:first-child) {
border-left: 1px solid #888888;
}

td {
height: 1.5em;
padding: 4px 1em 4px 1em;
border-bottom: 1px solid #888888;
}

td:not(:first-child) {
border-left: 1px solid #888888;
}

dl {
padding-left: 2em;
}

dt {
font-weight: bold;
border-bottom: 1px dashed #000000;
margin-top: 2em;
}

dd {
border-left: 1px dotted #000000;
margin-left: 1em;
padding-left: 1em;
}

audio {
vertical-align: middle;
}

label {
vertical-align: middle;
}

:not(.sourceCode)>pre {
overflow: auto;
border: 1px solid #888888;
padding: 8px;
}

div.sourceCode {
overflow: auto;
border: 1px solid #888888;
padding: 8px;
}

pre>code.sourceCode>span>a:first-child::before {
border-right: 1px solid #888888;
padding-right: 1em;
margin-right: 1em;
text-decoration: none;
}

:not(pre)>code {
color: #163eac;
}

li {
margin: 8px;
}

summary:hover {
background-color: #eeeeee;
}

header {
border-bottom: 1px gray solid;
padding: 0.5em;
margin-bottom: 1em;
}

footer {
border-top: 1px gray solid;
padding: 0.5em;
margin-top: 1em;
}


canvas {
/* image-rendering: pixelated; */
display: inline-block;
border-style: solid;
border-width: 1px;
border-color: #627f84;
}

.controlBlock {
display: inline-block;
width: 450px;
text-align: left;
vertical-align: top;
margin-left: 4px;
}

input[type="button"] {
background-color: #ffffff;
border: 2px solid #aaaaaa;
font-size: 16px;
height: 32px;
}

input[type="button"]:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}

div.numberInput {
display: block;
white-space: nowrap;
}

div.numberInput:hover {
background-color: #e0ecff;
}

.numberInputLabel {
/* max 12 letter  */
display: inline-block;
margin: 0 8px 0 8px;
text-align: left;
vertical-align: middle;
width: 100px;

font-size: 10pt;
font-family: 'Courier New', Courier, monospace;
}

.numberInputNumber {
display: inline-block;
vertical-align: middle;
width: 120px;
}

.numberInputRange {
display: inline-block;
vertical-align: middle;
width: 160px;
}

.pullDownMenu {
display: inline-block;
text-align: center;
}

.pullDownMenu:hover {
background-color: #e0ecff;
}

select {
background-color: #ffffff;
border: 2px solid #aaaaaa;
height: 24px;
vertical-align: middle;
font-size: 12px;
}

select:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}

span.math.inline a {
  color: #000000;
}
</style>

<script
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
type="text/javascript"></script>
</head>

<body>
<header>
<p>
何かあれば <a href="https://github.com/ryukau/filter_notes">GitHub のリポジトリ</a>に issue を作るか ryukau@gmail.com までお気軽にどうぞ。
</p>
<hr>
<a href="../index.html">インデックスに戻る</a>
<p>
Update: 2024-06-25
</p>
<details>
<summary translate="yes">Table of Contents</summary>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#一次ローパスと一次オールパスからなるレゾナントフィルタ"
id="toc-一次ローパスと一次オールパスからなるレゾナントフィルタ">一次ローパスと一次オールパスからなるレゾナントフィルタ</a>
<ul>
<li><a href="#実装" id="toc-実装">実装</a>
<ul>
<li><a href="#一次ローパス" id="toc-一次ローパス">一次ローパス</a></li>
<li><a href="#一次オールパス"
id="toc-一次オールパス">一次オールパス</a></li>
<li><a href="#レゾナントフィルタ"
id="toc-レゾナントフィルタ">レゾナントフィルタ</a></li>
</ul></li>
<li><a href="#レゾナンスの最大値の探索"
id="toc-レゾナンスの最大値の探索">レゾナンスの最大値の探索</a>
<ul>
<li><a href="#伝達関数" id="toc-伝達関数">伝達関数</a></li>
<li><a href="#数値計算" id="toc-数値計算">数値計算</a></li>
<li><a href="#安定条件の解き方の見直し"
id="toc-安定条件の解き方の見直し">安定条件の解き方の見直し</a></li>
</ul></li>
<li><a href="#音のデモ" id="toc-音のデモ">音のデモ</a></li>
<li><a href="#その他" id="toc-その他">その他</a>
<ul>
<li><a href="#一次ローパスと一次オールパスの伝達関数"
id="toc-一次ローパスと一次オールパスの伝達関数">一次ローパスと一次オールパスの伝達関数</a></li>
</ul></li>
<li><a href="#参考文献" id="toc-参考文献">参考文献</a></li>
<li><a href="#変更点" id="toc-変更点">変更点</a></li>
</ul></li>
</ul>
</nav>
</details>
</header>
<h1 id="一次ローパスと一次オールパスからなるレゾナントフィルタ"><a
href="#一次ローパスと一次オールパスからなるレゾナントフィルタ"
class="header-anchor"
aria-hidden="true">一次ローパスと一次オールパスからなるレゾナントフィルタ</a></h1>
<p>TestBedSynth
に組み込む候補として、以下のブロック線図のフィルタを思いつきました。以降ではレゾナントフィルタと呼ぶことにします。</p>
<p><img src="img/resonant_one_pole.svg"
alt="Block diagram of resonant filter composed from first order low-pass (LP1) and first order all-pass (AP1). Input signal goes into LP1. Output of LP1 is diverged to 2 paths: One is used as output of entire filter, and the other goes to feedback path. Feedback signal goes into AP1, then gain -q is applied." /><br />
</p>
<ul>
<li>LP1: 一次ローパス。</li>
<li>AP1: 一次オールパス。</li>
<li><span class="math inline">\(c_1, c_2\)</span>:
フィルタ係数。カットオフ周波数から計算。</li>
<li><span class="math inline">\(q\)</span>: レゾナンス。</li>
</ul>
<p>実装して試したところ、カットオフ周波数に応じてフィルタが発散する
<code>q</code>
の値が変わることがわかりました。ここではカットオフ周波数から発散しない
<code>q</code>
の最大値を求める関数を作ってフィルタをチューニングします。</p>
<h2 id="実装"><a href="#実装" class="header-anchor"
aria-hidden="true">実装</a></h2>
<h3 id="一次ローパス"><a href="#一次ローパス" class="header-anchor"
aria-hidden="true">一次ローパス</a></h3>
<p>一次ローパスについては Pieter P さんによる <a
href="https://tttapa.github.io/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential%20Moving%20Average/Exponential-Moving-Average.html">Exponential
Moving Average</a> の記事で丁寧に説明されています。</p>
<p>以下は一次ローパス、あるいは exponential moving average (EMA)
と呼ばれるフィルタの実装例です。コードは C++ で、
<code>#include &lt;cmath&gt;</code> は省略しています。 <code>pi</code>
は円周率です。</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">struct</span> LP1 <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  Sample u1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  Sample cut1 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setCutoff<span class="op">(</span>Sample sampleRate<span class="op">,</span> Sample cutoffHz<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> y <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> <span class="bu">std::</span>cos<span class="op">(</span><span class="dv">2</span> <span class="op">*</span> pi <span class="op">*</span> cutoffHz <span class="op">/</span> sampleRate<span class="op">);</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    cut1 <span class="op">=</span> <span class="bu">std::</span>sqrt<span class="op">((</span>y <span class="op">+</span> <span class="dv">2</span><span class="op">)</span> <span class="op">*</span> y<span class="op">)</span> <span class="op">-</span> y<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample x0<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> u1 <span class="op">+=</span> cut1 <span class="op">*</span> <span class="op">(</span>x0 <span class="op">-</span> u1<span class="op">);</span> <span class="op">}</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 id="一次オールパス"><a href="#一次オールパス" class="header-anchor"
aria-hidden="true">一次オールパス</a></h3>
<p>以下は一次オールパスの実装例です。 <a
href="https://thewolfsound.com/allpass-filter/">WolfSound の記事</a>
を参考にしています。</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">struct</span> AP1 <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  Sample v1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  Sample u2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  Sample cut2 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> setCutoff<span class="op">(</span>Sample sampleRate<span class="op">,</span> Sample cutoffHz<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> t <span class="op">=</span> <span class="bu">std::</span>tan<span class="op">(</span>pi <span class="op">*</span> cutoffHz <span class="op">/</span> sampleRate<span class="op">);</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    cut2 <span class="op">=</span> <span class="op">(</span>t <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span>t <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample x0<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    v1 <span class="op">=</span> cut2 <span class="op">*</span> <span class="op">(</span>x0 <span class="op">-</span> v1<span class="op">)</span> <span class="op">+</span> u2<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    u2 <span class="op">=</span> x0<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> v1<span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 id="レゾナントフィルタ"><a href="#レゾナントフィルタ"
class="header-anchor" aria-hidden="true">レゾナントフィルタ</a></h3>
<p>一次ローパスと一次オールパスを組み合わせて以下のように実装しました。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">struct</span> ResonantEmaLowpass <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  Sample u1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  Sample v1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  Sample u2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  Sample cut1 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  Sample cut2 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  Sample q <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> reset<span class="op">()</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    u1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    v1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    u2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  resonance の範囲は [0.0, 1.0] 。 cutoffHz &lt; sampleRate / 2 。</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> prepare<span class="op">(</span>Sample sampleRate<span class="op">,</span> Sample cutoffHz<span class="op">,</span> Sample resonance<span class="op">)</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// cut1, cut2 の設定は LP1, AP1 の setCutoff と同じなので省略。</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> resonance <span class="op">*</span> getMaxResonance<span class="op">(</span>cutoffHz <span class="op">/</span> sampleRate<span class="op">);</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample input<span class="op">)</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    v1 <span class="op">=</span> cut2 <span class="op">*</span> <span class="op">(</span>u1 <span class="op">-</span> v1<span class="op">)</span> <span class="op">+</span> u2<span class="op">;</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    u2 <span class="op">=</span> u1<span class="op">;</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> u1 <span class="op">+=</span> cut1 <span class="op">*</span> <span class="op">(</span>input <span class="op">-</span> u1<span class="op">)</span> <span class="op">-</span> q <span class="op">*</span> v1<span class="op">;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>レゾナントフィルタは<a
href="#伝達関数">伝達関数</a>を見ると二次フィルタですが、<a
href="https://webaudio.github.io/Audio-EQ-Cookbook/audio-eq-cookbook.html">バイクアッドフィルタ</a>に比べると状態変数の数が少なく、加算と乗算の数も少ないので効率よく計算できます。バイクアッドフィルタと同様に、信号の流れの計算よりもカットオフ周波数をフィルタ係数に変換する計算のほうが重いです。フィルタ係数の更新はコントロールレートでのみ行い、オーディオレートでは補間することによって計算量を節約できます。</p>
<p>以降では <code>getMaxResonance</code>
を実装するために試行錯誤します。</p>
<h2 id="レゾナンスの最大値の探索"><a href="#レゾナンスの最大値の探索"
class="header-anchor"
aria-hidden="true">レゾナンスの最大値の探索</a></h2>
<h3 id="伝達関数"><a href="#伝達関数" class="header-anchor"
aria-hidden="true">伝達関数</a></h3>
<p>以下はフィルタ計算のコードです。</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>v1 <span class="op">=</span> cut2 <span class="op">*</span> <span class="op">(</span>u1 <span class="op">-</span> v1<span class="op">)</span> <span class="op">+</span> u2<span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>u2 <span class="op">=</span> u1<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> u1 <span class="op">+=</span> cut1 <span class="op">*</span> <span class="op">(</span>input <span class="op">-</span> u1<span class="op">)</span> <span class="op">-</span> q <span class="op">*</span> v1<span class="op">;</span></span></code></pre></div>
<p>以下は変数の一覧です。</p>
<ul>
<li><code>u1</code>: 一次ローパスの状態変数。</li>
<li><code>v1</code>, <code>u2</code>: 一次オールパスの状態変数。</li>
<li><code>cut1</code>:
一次ローパスのフィルタ係数。カットオフ周波数から計算。</li>
<li><code>cut2</code>:
一次オールパスのフィルタ係数。カットオフ周波数から計算。</li>
<li><code>q</code>: レゾナンス。</li>
</ul>
<p>連立方程式の形に変形します。コードで <code>s1 = f(s1)</code>
のような計算を行っている式を <code>s0 = f(s1)</code>
と置きなおしています。変数の添え字は、何サンプル前に計算された値なのかを表しています。
<code>v</code> はオールパスの出力、 <code>u</code> はローパスの出力 、
<code>x</code> は入力です。また、以降で数式として書くので
<code>cut</code> を <code>c</code> と置きなおしています。</p>
<pre><code>v0 = c2 * (u1 - v1) + u2; // (A)
u0 = c1 * x0 + (1 - c1) * u1 - q * v0;</code></pre>
<p><code>u0</code> の式を <code>v0</code> について解きます。</p>
<pre><code>v0 = (c1 * x0 + (1 - c1) * u1 - u0) / q;</code></pre>
<p>得られた式を <code>(A)</code> に代入します。 <a
href="https://maxima.sourceforge.io/">Maxima</a>
を使います。変数の添え字 <code>i</code> を <code>(n - i)</code>
と置きなおしています。</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode maxima"><code class="sourceCode maxima"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cn">v</span>(<span class="cn">n</span>) := (<span class="cn">c_1</span> * <span class="cn">x</span>(<span class="cn">n</span>) + (<span class="dv">1</span> - <span class="cn">c_1</span>) * <span class="cn">u</span>(<span class="cn">n</span> - <span class="dv">1</span>) - <span class="cn">u</span>(<span class="cn">n</span>)) / <span class="cn">q</span>;</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="cn">result</span>: <span class="cn">v</span>(<span class="cn">n</span>) = <span class="cn">c_2</span> * (<span class="cn">u</span>(<span class="cn">n</span> - <span class="dv">1</span>) - <span class="cn">v</span>(<span class="cn">n</span> - <span class="dv">1</span>)) + <span class="cn">u</span>(<span class="cn">n</span> - <span class="dv">2</span>);</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ratvars</span>(<span class="cn">u</span>(<span class="cn">n</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-3</span>), <span class="cn">x</span>(<span class="cn">n</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-3</span>));</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ratsimp</span>(<span class="dv">0</span> = <span class="fu">lhs</span>(<span class="cn">result</span>) - <span class="fu">rhs</span>(<span class="cn">result</span>));</span></code></pre></div>
<p>整理した出力です。</p>
<p><span class="math display">\[
  u[n]
- (1 - c_1 - c_2 - q c_2) u[n - 1]
- (c_2 - c_1 c_2 - q) u[n - 2]
=
  c_1 x[n]
+ c_1 c_2 x[n - 1]
\]</span></p>
<p>伝達関数です。 <span class="math inline">\(f_c\)</span>
はカットオフ周波数、 <span class="math inline">\(f_s\)</span>
はサンプリング周波数です。</p>
<p><span class="math display">\[
\begin{align}
H(z) &amp;= \frac{
  c_1 + c_1 c_2 z^{-1}
}{
  1 - (1 - c_1 - c_2 - q c_2) z^{-1} - (c_2 - c_1 c_2 - q) z^{-2}
}. \\
\end{align}
\]</span></p>
<p><span class="math display">\[
\begin{align}
c_1 &amp;= -s + \sqrt{s^2 + 2 s}, &amp;&amp; \text{where} \quad s = 1 -
\cos(2 \pi f_c / f_s). \\
c_2 &amp;= \frac{t - 1}{t + 1} ,  &amp;&amp; \text{where} \quad t =
\tan(\pi f_c / f_s). \\
\end{align}
\]</span></p>
<p><span class="math inline">\(H(z)\)</span>
は離散系の伝達関数なので、<a
href="https://web.mit.edu/2.14/www/Handouts/PoleZero.pdf">極</a>が単位円以内であれば安定です。つまり以下の条件を満たせばフィルタは発散しません。不等式の右辺は二次方程式の解の公式です。
<span class="math inline">\(a = 1\)</span> なので、 <span
class="math inline">\(a\)</span> は省略しています。</p>
<p><strong>注意</strong>: 以下の解き方は中途半端です。<a
href="#安定条件の解き方の見直し">安定条件の解き方の見直し</a>で使える解が得られています。</p>
<p><span class="math display">\[
\begin{aligned}
1 &amp;&gt; \left| \frac{-b \pm \sqrt{b^2 - 4c}}{2} \right| \\
b &amp;= - (1 - c_1 - c_2 - q c_2) \\
c &amp;= - (c_2 - c_1 c_2 - q) \\
\end{aligned}
\]</span></p>
<p>厳密には二次方程式の解の公式に代入する <span
class="math inline">\(a\)</span> と <span
class="math inline">\(c\)</span>
の値が逆なのですが、最終的な結果に影響しなかったのでここでは適当に流します。</p>
<p>Maxima の <code>to_poly_solve</code> で安定条件を <span
class="math inline">\(q\)</span> について解きます。</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode maxima"><code class="sourceCode maxima"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="cn">to_poly_solve</span>);</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cn">b</span>: - (<span class="dv">1</span> - <span class="cn">c_1</span> - <span class="cn">c_2</span> - <span class="cn">q</span>*<span class="cn">c_2</span>);</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="cn">c</span>: - (<span class="cn">c_2</span> - <span class="cn">c_1</span>*<span class="cn">c_2</span> - <span class="cn">q</span>);</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cn">resultP</span>: <span class="cn">to_poly_solve</span>(<span class="dv">1</span> = <span class="fu">abs</span>((-<span class="cn">b</span> + (<span class="cn">b</span>^<span class="dv">2</span> - <span class="dv">4</span>*<span class="cn">c</span>)^(<span class="dv">1</span>/<span class="dv">2</span>))/<span class="dv">2</span>), <span class="cn">q</span>);</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cn">resultN</span>: <span class="cn">to_poly_solve</span>(<span class="dv">1</span> = <span class="fu">abs</span>((-<span class="cn">b</span> - (<span class="cn">b</span>^<span class="dv">2</span> - <span class="dv">4</span>*<span class="cn">c</span>)^(<span class="dv">1</span>/<span class="dv">2</span>))/<span class="dv">2</span>), <span class="cn">q</span>);</span></code></pre></div>
<p>以下は整形した <code>resultP</code> の出力です。 <code>resultN</code>
は条件の <code>parg</code>
内の正負が逆になるだけだったので省略しています。</p>
<pre><code>%union(
  %if(
    (-(%pi/2) &lt; parg((1-c_1)*c_2+c_1+1))
      %and (parg((1-c_1)*c_2+c_1+1) &lt;= %pi/2),
    [q=-c_1],
    %union()
  )
  ,
  %if(
    (-(%pi/2) &lt; parg((c_1-1)*c_2+c_1-3))
      %and (parg((c_1-1)*c_2+c_1-3) &lt;= %pi/2),
    [q=c_1-2],
    %union()
  )
)</code></pre>
<ul>
<li><a
href="https://maxima.sourceforge.io/docs/manual/maxima_346.html#index-_0025union"><code>%union</code></a>
は解の集合。 <code>%union()</code> は空集合、つまり解なし。</li>
<li><a
href="https://maxima.sourceforge.io/docs/manual/maxima_346.html#index-parg"><code>parg</code></a>
は <code>[-%pi, %pi]</code> の範囲で値を返す複素数の偏角 (complex
argument) 。</li>
</ul>
<p>以下の解らしい式が 2 つ得られています。</p>
<ul>
<li><span class="math inline">\(q = -c_1\)</span></li>
<li><span class="math inline">\(q = c_1 - 2\)</span></li>
</ul>
<p><span class="math inline">\(q\)</span> の値の範囲は <span
class="math inline">\([0, 1]\)</span>
を想定していたのですが、どちらも負の値となっています。適当に <span
class="math inline">\(q = c_1\)</span>
としたところ発散はしなくなったのですが、発散寸前の状態とはなりませんでした。つまり
<span class="math inline">\(q = c_1\)</span>
はレゾナンスの最大値としては不適です。</p>
<h3 id="数値計算"><a href="#数値計算" class="header-anchor"
aria-hidden="true">数値計算</a></h3>
<p>Maxima の <code>to_poly_solve</code>
では安定条件が解けないことがわかったので、数値計算でレゾナンスの最大値
<span class="math inline">\(q\)</span>
のテーブルを作ってルックアップすることにします。</p>
<p>レゾナンスの最大値は二分探索で求めました。以下は探索の手順です。</p>
<ol start="0" type="1">
<li>探索の初期状態を <code>low = 0, mid = 1, high = 2</code>
と設定。</li>
<li>レゾナンスを <code>q = mid</code>
としてフィルタのインパルス応答を計算。インパルスの振幅は 1 。</li>
<li>フィルタが発散しているか判定。
<ul>
<li>発散しているときは <code>high = mid</code> と代入。</li>
<li>発散していないときは <code>low = mid</code> と代入。</li>
</ul></li>
<li><code>mid = (low + high) / 2</code> と代入。</li>
<li>1 に戻る。</li>
</ol>
<p>発散しているかどうかの判定として以下の 3
つの方法を思いつきました。</p>
<ul>
<li>方法 1: インパルス応答を一定の時間まで計算。振幅の絶対値が 1
を超えたら発散と判定。</li>
<li>方法 2: インパルス応答を 2
つめのピークまで計算。前のピークが後のピークより小さければ発散と判定。</li>
<li>方法 3:
インパルス応答を一定の時間まで計算。得られた信号の線形回帰の傾きが正の値なら発散と判定。</li>
</ul>
<p>結論を先に言うと、方法 3 が最もいい値を得ることができます。方法 1
は探索範囲が狭くなってきたときに発散が検知できません。方法 2
はカットオフ周波数がかなり低くなければ発散が検知できません。</p>
<p>以下は探索に使ったコードへのリンクです。</p>
<ul>
<li><a
href="https://github.com/ryukau/filter_notes/blob/master/resonant_one_pole_filter/code/resonance.py">探索に使った
Python 3 のコード (github.com)</a></li>
</ul>
<p>以下は得られたテーブルです。フィルタのカットオフが周波数 (Hz)
で入力されるときは等間隔、 MIDI
ノートなどの対数スケールで入力されるときは対数スケーリングしたテーブルの使用を想定しています。</p>
<ul>
<li><a
href="https://github.com/ryukau/filter_notes/blob/master/resonant_one_pole_filter/code/table_linear.json">カットオフが等間隔のテーブル
(github.com)</a></li>
<li><a
href="https://github.com/ryukau/filter_notes/blob/master/resonant_one_pole_filter/code/table_log.json">カットオフが対数スケールのテーブル
(github.com)</a></li>
</ul>
<p>以下はテーブルルックアップの実装例です。</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;array&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> FeedbackEmaUtil <span class="op">{</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span> <span class="kw">struct</span> ResonanceTable <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="kw">constexpr</span> <span class="bu">std::</span>array<span class="op">&lt;</span>T<span class="op">,</span> <span class="dv">32768</span><span class="op">&gt;</span> qTableLin<span class="op">{</span> <span class="co">/* テーブルの値は省略。 */</span> <span class="op">};</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="kw">constexpr</span> <span class="bu">std::</span>array<span class="op">&lt;</span>T<span class="op">,</span> <span class="dv">32768</span><span class="op">&gt;</span> qTableLog<span class="op">{</span> <span class="co">/* テーブルの値は省略。 */</span> <span class="op">};</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// `normalizedFreq` の範囲は [0, 0.5] 。単位は [rad/2π] 。</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> T getLinear<span class="op">(</span>T normalizedFreq<span class="op">)</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    T pos <span class="op">=</span> normalizedFreq <span class="op">*</span> T<span class="op">(</span><span class="dv">2</span><span class="op">)</span> <span class="op">*</span> T<span class="op">(</span>qTableLin<span class="op">.</span>size<span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> i <span class="op">=</span> <span class="dt">size_t</span><span class="op">(</span>pos<span class="op">);</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> qTableLin<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> <span class="op">(</span>pos <span class="op">-</span> T<span class="op">(</span>i<span class="op">))</span> <span class="op">*</span> <span class="op">(</span>qTableLin<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">-</span> qTableLin<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// `note` の範囲は [0, 127] 。単位は MIDI ノート番号 。</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> T getLog<span class="op">(</span>T note<span class="op">)</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>note <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>note <span class="op">&gt;</span> T<span class="op">(</span><span class="dv">127</span><span class="op">))</span> <span class="cf">return</span> qTableLog<span class="op">.</span>back<span class="op">();</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    T pos <span class="op">=</span> note <span class="op">*</span> T<span class="op">(</span>qTableLog<span class="op">.</span>size<span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> T<span class="op">(</span><span class="dv">127</span><span class="op">);</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> i <span class="op">=</span> <span class="dt">size_t</span><span class="op">(</span>pos<span class="op">);</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> qTableLog<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> <span class="op">(</span>pos <span class="op">-</span> T<span class="op">(</span>i<span class="op">))</span> <span class="op">*</span> <span class="op">(</span>qTableLog<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">-</span> qTableLog<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 id="安定条件の解き方の見直し"><a href="#安定条件の解き方の見直し"
class="header-anchor"
aria-hidden="true">安定条件の解き方の見直し</a></h3>
<p>この記事の初版を見直していたところ、伝達関数の安定条件を場合分けすれば
Maxima の <code>solve</code>
で解ける形にできることに気が付きました。</p>
<p>以下は安定条件の再掲です。得られる解の数が変わったので、先に掲載した式とは
<span class="math inline">\(a\)</span> と <span
class="math inline">\(c\)</span> が入れ替わっています。</p>
<p><span class="math display">\[
\begin{aligned}
1 &amp;&gt; \left| \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} \right| \\
a &amp;= - (c_2 - c_1 c_2 - q) \\
b &amp;= - (1 - c_1 - c_2 - q c_2) \\
c &amp;= 1 \\
\end{aligned}
\]</span></p>
<p>Maxima で解きます。</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode maxima"><code class="sourceCode maxima"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cn">a</span>: - (<span class="cn">c_2</span> - <span class="cn">c_1</span>*<span class="cn">c_2</span> - <span class="cn">q</span>);</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cn">b</span>: - (<span class="dv">1</span> - <span class="cn">c_1</span> - <span class="cn">c_2</span> - <span class="cn">q</span>*<span class="cn">c_2</span>);</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="cn">case1</span>: (<span class="dv">2</span>*<span class="cn">a</span> + <span class="cn">b</span>)^<span class="dv">2</span> = +<span class="cn">b</span>^<span class="dv">2</span> - <span class="dv">4</span>*<span class="cn">a</span>;</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="cn">case2</span>: (<span class="dv">2</span>*<span class="cn">a</span> + <span class="cn">b</span>)^<span class="dv">2</span> = -<span class="cn">b</span>^<span class="dv">2</span> + <span class="dv">4</span>*<span class="cn">a</span>;</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="cn">case3</span>: (<span class="dv">2</span>*<span class="cn">a</span> - <span class="cn">b</span>)^<span class="dv">2</span> = -<span class="cn">b</span>^<span class="dv">2</span> + <span class="dv">4</span>*<span class="cn">a</span>;</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cn">case4</span>: (<span class="dv">2</span>*<span class="cn">a</span> - <span class="cn">b</span>)^<span class="dv">2</span> = +<span class="cn">b</span>^<span class="dv">2</span> - <span class="dv">4</span>*<span class="cn">a</span>;</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(<span class="cn">case1</span>, <span class="cn">q</span>);</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(<span class="cn">case2</span>, <span class="cn">q</span>);</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(<span class="cn">case3</span>, <span class="cn">q</span>);</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(<span class="cn">case4</span>, <span class="cn">q</span>);</span></code></pre></div>
<p>以下は <code>case1</code> の解です。</p>
<pre><code>[
  q = c_2 - c_1*c_2,
  q = -c_1
]</code></pre>
<p>新しく出てきた解 <span class="math inline">\(q = c_2 - c_1
c_2\)</span> を数値計算で得られた <span class="math inline">\(q\)</span>
の値と比べたところ以下の図が得られました。図の Analytical
が新しく出てきた解、 Numerical が数値計算で得られた値です。</p>
<p><img src="img/solution_comparison_1.svg"
alt="Comparison of numerical and analytical solution. 2 lines look parallel." /><br />
</p>
<p>切片がずれているだけのように見えるので Analytical に 1
を足します。</p>
<p><img src="img/solution_comparison_2.svg"
alt="Comparison of numerical and adjusted analytical solution. 2 lines look identical." /><br />
</p>
<p>曲線が一致しました。つまり、レゾナンスの最大値の曲線は以下の式で表されます。</p>
<p><span class="math display">\[
q = c_2 - c_1 c_2 + 1.
\]</span></p>
<p>以下はレゾナンスの最大値の曲線の式を使った完全な
<code>ResonantEmaLowpass</code> の実装例です。 C++ 20 です。</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;numbers&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">struct</span> ResonantEmaLowpass <span class="op">{</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  Sample u1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  Sample v1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  Sample u2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  Sample c1Value <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  Sample c2Value <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  Sample qValue <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  Sample c1Target <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  Sample c2Target <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  Sample qTarget <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> reset<span class="op">()</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    u1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    v1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    u2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    c1Value <span class="op">=</span> c1Target <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    c2Value <span class="op">=</span> c2Target <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    qValue <span class="op">=</span> qTarget <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  resonance の範囲は [0.0, 1.0] 。 cutoffHz &lt; sampleRate / 2 。</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 計算が重いのでコントロールレートで呼び出す。</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> prepare<span class="op">(</span>Sample sampleRate<span class="op">,</span> Sample cutoffHz<span class="op">,</span> Sample resonance<span class="op">)</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> Sample pi <span class="op">=</span> <span class="bu">std::</span>numbers::pi_v<span class="op">&lt;</span>Sample<span class="op">&gt;;</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> freq <span class="op">=</span> <span class="bu">std::</span>clamp<span class="op">(</span>cutoffHz <span class="op">/</span> sampleRate<span class="op">,</span> Sample<span class="op">(</span><span class="dv">0</span><span class="op">),</span> Sample<span class="op">(</span><span class="fl">0.4999</span><span class="op">));</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> s <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">-</span> <span class="bu">std::</span>cos<span class="op">(</span>Sample<span class="op">(</span><span class="dv">2</span><span class="op">)</span> <span class="op">*</span> pi <span class="op">*</span> freq<span class="op">);</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    c1Target <span class="op">=</span> <span class="bu">std::</span>sqrt<span class="op">((</span>s <span class="op">+</span> Sample<span class="op">(</span><span class="dv">2</span><span class="op">))</span> <span class="op">*</span> s<span class="op">)</span> <span class="op">-</span> s<span class="op">;</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> t <span class="op">=</span> <span class="bu">std::</span>tan<span class="op">(</span>pi <span class="op">*</span> freq<span class="op">);</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    c2Target <span class="op">=</span> <span class="op">(</span>t <span class="op">-</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">))</span> <span class="op">/</span> <span class="op">(</span>t <span class="op">+</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> maxQ <span class="op">=</span> c2Target <span class="op">-</span> c1Target <span class="op">*</span> c2Target <span class="op">+</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    qTarget <span class="op">=</span> maxQ <span class="op">*</span> resonance<span class="op">;</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample input<span class="op">)</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 一次ローパスによる状態変数の補間。</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    c1Value <span class="op">+=</span> rate <span class="op">*</span> <span class="op">(</span>c1Target <span class="op">-</span> c1Value<span class="op">);</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    c2Value <span class="op">+=</span> rate <span class="op">*</span> <span class="op">(</span>c2Target <span class="op">-</span> c2Value<span class="op">);</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    qValue <span class="op">+=</span> rate <span class="op">*</span> <span class="op">(</span>qTarget <span class="op">-</span> qValue<span class="op">);</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// フィルタ本体の計算。</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    v1 <span class="op">=</span> c2Value <span class="op">*</span> <span class="op">(</span>u1 <span class="op">-</span> v1<span class="op">)</span> <span class="op">+</span> u2<span class="op">;</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    u2 <span class="op">=</span> u1<span class="op">;</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> u1 <span class="op">+=</span> c1Value <span class="op">*</span> <span class="op">(</span>input <span class="op">-</span> u1<span class="op">)</span> <span class="op">-</span> qValue <span class="op">*</span> v1<span class="op">;</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>実装時の注意点として、カットオフ周波数がナイキスト周波数ぴったりになるとフィルタが発散します。したがって
<code>std::clamp(cutoff, 0.0, 0.4999)</code>
などとしてナイキスト周波数を少しだけ下回るようにしておくと安全です。</p>
<h2 id="音のデモ"><a href="#音のデモ" class="header-anchor"
aria-hidden="true">音のデモ</a></h2>
<p>以下はカットオフ周波数を等間隔で区切ったテーブルを使ったフィルタのデモです。入力はのこぎり波です。
<code>q=0.99</code> としているのは発振を避けるためです。
<code>q=1.0</code> とするとちょうど発振します。</p>
<figure>
<figcaption>
Cutoff 0.1 to Nyquist [Hz], q=0.99, No oversampling.
</figcaption>
<audio controls src="audio/resonant_lp_1x.opus">
<a href="audio/resonant_lp_1x.opus">Download audio</a>
</audio>
</figure>
<figure>
<figcaption>
Cutoff 0.1 to Nyquist [Hz], q=0.99, 2-fold oversampling.
</figcaption>
<audio controls src="audio/resonant_lp_1x.opus">
<a href="audio/resonant_lp_1x.opus">Download audio</a>
</audio>
</figure>
<figure>
<figcaption>
Cutoff 0.1 to 100000 [Hz], q=0.99, 8-fold oversampling.
</figcaption>
<audio controls src="audio/resonant_lp_1x.opus">
<a href="audio/resonant_lp_1x.opus">Download audio</a>
</audio>
</figure>
<p>FL Studio の 3x OSC などで使える Fast LP
と似ていますが、低域でも発振する点が異なります。</p>
<p>ここで得られたレゾナンスの最大値をそのまま使うこともできますが、発振の有無、低域あるいは高域に向かってレゾナンスを弱くする、といった楽器としてのチューニングを施すことで音の印象を変えることができます。</p>
<h2 id="その他"><a href="#その他" class="header-anchor"
aria-hidden="true">その他</a></h2>
<h3 id="一次ローパスと一次オールパスの伝達関数"><a
href="#一次ローパスと一次オールパスの伝達関数" class="header-anchor"
aria-hidden="true">一次ローパスと一次オールパスの伝達関数</a></h3>
<p>以下は一次ローパスの伝達関数です。</p>
<p><span class="math display">\[
H_L (z) = \frac{k_p}{1 - (1 - k_p) z^{-1}}
\]</span></p>
<p>以下は一次オールパスの伝達関数です。</p>
<p><span class="math display">\[
H_A (z) = \frac{a_1 + z^{-1}}{1 + a_1 z^{-1}}
\]</span></p>
<h2 id="参考文献"><a href="#参考文献" class="header-anchor"
aria-hidden="true">参考文献</a></h2>
<ul>
<li><a
href="https://tttapa.github.io/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential%20Moving%20Average/Exponential-Moving-Average.html">Exponential
Moving Average</a></li>
<li><a
href="https://dsp.stackexchange.com/questions/54086/single-pole-iir-low-pass-filter-which-is-the-correct-formula-for-the-decay-coe">Single-pole
IIR low-pass filter - which is the correct formula for the decay
coefficient? - Signal Processing Stack Exchange</a></li>
<li><a href="https://thewolfsound.com/allpass-filter/">Allpass Filter:
All You Need To Know - WolfSound</a></li>
<li><a
href="https://ccrma.stanford.edu/~jos/filters/Stability_Revisited.html">Stability
Revisited</a></li>
<li><a
href="https://stackoverflow.com/questions/46907829/maxima-does-not-solve-the-system-sqrtx-1-y-1-with-the-solve-function">Maxima
does not solve the system sqrt(x)=1, y=1 with the solve function - Stack
Overflow</a></li>
<li><a
href="https://maxima.sourceforge.io/docs/manual/maxima_346.html">Maxima
5.46.0 Manual: Functions and Variables for to_poly_solve</a></li>
<li><a
href="https://webaudio.github.io/Audio-EQ-Cookbook/audio-eq-cookbook.html">Cookbook
formulae for audio EQ biquad filter coefficients</a></li>
</ul>
<h2 id="変更点"><a href="#変更点" class="header-anchor"
aria-hidden="true">変更点</a></h2>
<ul>
<li>2023/06/13
<ul>
<li>「安定条件の解き方の見直し」の節を追加。</li>
</ul></li>
</ul>
<footer>
<a href="../index.html">インデックスに戻る</a>
</footer>
</body>

</html>

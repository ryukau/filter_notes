<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja" >

<head>
<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<meta name="dcterms.date" content="2024-06-25" />
<title>3pole_lowpass</title>

<!-- MathJax -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
window.MathJax = {
  tex: {
    tags: 'ams'
  }
};
</script>

<style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #666666;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #666666;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; text-decoration: underline; } /* Alert */
code span.an { color: #666666; font-style: italic; } /* Annotation */
code span.at { color: #906000; } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #000000; font-weight: bold; } /* ControlFlow */
code span.ch { color: #b000b0; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008800; } /* Comment */
code span.cv { color: #008800; } /* CommentVar */
code span.do { color: #008800; } /* Documentation */
code span.dt { color: #906000; } /* DataType */
code span.dv { color: #0000ff; } /* DecVal */
code span.er { color: #ffffff; background-color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000ff; } /* Float */
code span.im { color: #000000; font-weight: bold; } /* Import */
code span.in { color: #666666; } /* Information */
code span.kw { color: #000000; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #000000; } /* Other */
code span.pp { color: #000000; font-weight: bold; } /* Preprocessor */
code span.sc { color: #b000b0; } /* SpecialChar */
code span.ss { color: #b000b0; } /* SpecialString */
code span.st { color: #b000b0; } /* String */
code span.va { color: #000088; } /* Variable */
code span.vs { color: #b000b0; } /* VerbatimString */
code span.wa { background-color: #ffff00; font-weight: bold; font-style: italic; text-decoration: underline; } /* Warning */
</style>
<style>
body {
max-width: 704px;
margin: auto;
padding: 32px 8px;
}

img {
max-width: 100%;
}

video {
max-width: 100%;
}

kbd {
font-family: inherit;
border-style: solid;
border-width: 1px 2px 2px 1px;
border-radius: 2px;
padding: 4px;
margin: 2px;
line-height: calc(1em + 16px);
}

a {
text-decoration: none;
}

.header-anchor {
color: #000000;
}

.header-anchor:hover {
color: #0000EE;
}

.header-anchor:hover::after {
display: inline-block;
font-size: min(1em, 1rem);
content: '(クリックでここへリンク)';
padding-left: 1em;
color: #0000EE;
}

h2 {
border-left: solid 32px #000000;
padding-left: 24px;
}

h3 {
border-left: solid 20px #404040;
padding-left: 16px;
}

h4 {
font-size: 100%;
border-left: solid 12px #606060;
padding-left: 8px;
}

h5 {
font-size: 90%;
border-left: solid 4px #808080;
padding-left: 4px;
}

h6 {
font-size: 80%;
border-left: solid 2px #a0a0a0;
padding-left: 2px;
}

table {
border-spacing: 0px;
border-collapse: separate;
border-left: 1px solid #888888;
border-right: 1px solid #888888;
border-top: 1px solid #888888;
border-bottom: hidden;
}

tr:nth-child(odd) {
background: #eeeeee;
}

tr:nth-child(even) {
background: #ffffff;
}

th {
height: 2em;
padding: 4px 1em 4px 1em;
background: #ffffff;
border-bottom: 1px solid #888888;
}

th:not(:first-child) {
border-left: 1px solid #888888;
}

td {
height: 1.5em;
padding: 4px 1em 4px 1em;
border-bottom: 1px solid #888888;
}

td:not(:first-child) {
border-left: 1px solid #888888;
}

dl {
padding-left: 2em;
}

dt {
font-weight: bold;
border-bottom: 1px dashed #000000;
margin-top: 2em;
}

dd {
border-left: 1px dotted #000000;
margin-left: 1em;
padding-left: 1em;
}

audio {
vertical-align: middle;
}

label {
vertical-align: middle;
}

:not(.sourceCode)>pre {
overflow: auto;
border: 1px solid #888888;
padding: 8px;
}

div.sourceCode {
overflow: auto;
border: 1px solid #888888;
padding: 8px;
}

pre>code.sourceCode>span>a:first-child::before {
border-right: 1px solid #888888;
padding-right: 1em;
margin-right: 1em;
text-decoration: none;
}

:not(pre)>code {
color: #163eac;
}

li {
margin: 8px;
}

summary:hover {
background-color: #eeeeee;
}

header {
border-bottom: 1px gray solid;
padding: 0.5em;
margin-bottom: 1em;
}

footer {
border-top: 1px gray solid;
padding: 0.5em;
margin-top: 1em;
}


canvas {
/* image-rendering: pixelated; */
display: inline-block;
border-style: solid;
border-width: 1px;
border-color: #627f84;
}

.controlBlock {
display: inline-block;
width: 450px;
text-align: left;
vertical-align: top;
margin-left: 4px;
}

input[type="button"] {
background-color: #ffffff;
border: 2px solid #aaaaaa;
font-size: 16px;
height: 32px;
}

input[type="button"]:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}

div.numberInput {
display: block;
white-space: nowrap;
}

div.numberInput:hover {
background-color: #e0ecff;
}

.numberInputLabel {
/* max 12 letter  */
display: inline-block;
margin: 0 8px 0 8px;
text-align: left;
vertical-align: middle;
width: 100px;

font-size: 10pt;
font-family: 'Courier New', Courier, monospace;
}

.numberInputNumber {
display: inline-block;
vertical-align: middle;
width: 120px;
}

.numberInputRange {
display: inline-block;
vertical-align: middle;
width: 160px;
}

.pullDownMenu {
display: inline-block;
text-align: center;
}

.pullDownMenu:hover {
background-color: #e0ecff;
}

select {
background-color: #ffffff;
border: 2px solid #aaaaaa;
height: 24px;
vertical-align: middle;
font-size: 12px;
}

select:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}

span.math.inline a {
  color: #000000;
}
</style>

<script
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
type="text/javascript"></script>
</head>

<body>
<header>
<p>
何かあれば <a href="https://github.com/ryukau/filter_notes">GitHub のリポジトリ</a>に issue を作るか ryukau@gmail.com までお気軽にどうぞ。
</p>
<hr>
<a href="../index.html">インデックスに戻る</a>
<p>
Update: 2024-06-25
</p>
<details>
<summary translate="yes">Table of Contents</summary>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#pole-ローパスフィルタ"
id="toc-pole-ローパスフィルタ">3-pole ローパスフィルタ</a>
<ul>
<li><a href="#出力の大きさ" id="toc-出力の大きさ">出力の大きさ</a></li>
<li><a href="#伝達関数" id="toc-伝達関数">伝達関数</a></li>
<li><a href="#ローパスのカットオフ周波数のチューニング"
id="toc-ローパスのカットオフ周波数のチューニング">ローパスのカットオフ周波数のチューニング</a></li>
<li><a href="#レゾナンスのチューニング"
id="toc-レゾナンスのチューニング">レゾナンスのチューニング</a></li>
<li><a href="#ハイパスのカットオフ周波数のチューニング"
id="toc-ハイパスのカットオフ周波数のチューニング">ハイパスのカットオフ周波数のチューニング</a></li>
<li><a href="#実装" id="toc-実装">実装</a></li>
<li><a href="#音のサンプル" id="toc-音のサンプル">音のサンプル</a>
<ul>
<li><a href="#指数カーブのカットオフ"
id="toc-指数カーブのカットオフ">指数カーブのカットオフ</a></li>
<li><a href="#直線のカットオフ"
id="toc-直線のカットオフ">直線のカットオフ</a></li>
</ul></li>
<li><a href="#その他" id="toc-その他">その他</a></li>
<li><a href="#変更" id="toc-変更">変更</a></li>
</ul></li>
</ul>
</nav>
</details>
</header>
<h1 id="pole-ローパスフィルタ"><a href="#pole-ローパスフィルタ"
class="header-anchor" aria-hidden="true">3-pole
ローパスフィルタ</a></h1>
<p>ばねとダンパの項を含んだ加速度の式がフィルタになりそうだと思いました。</p>
<p><span class="math display">\[
\ddot{u} = c \dot{u} + k u
\]</span></p>
<p><span class="math inline">\(c\)</span> はダンピング係数、 <span
class="math inline">\(k\)</span> はばね係数です。</p>
<p><span class="math inline">\(\ddot{u}\)</span>
の式から試行錯誤して以下の式を見つけました。</p>
<p><span class="math display">\[
\begin{aligned}
\ddot{u} =&amp; c \dot{u} + k \ddot{u} \\
\dot{u} \mathrel{{-}{=}}&amp; \ddot{u} + V[n] \\
u \mathrel{{-}{=}}&amp; \frac{c}{1 - k} \dot{u} \\
\end{aligned}
\]</span></p>
<p><span class="math inline">\(k u\)</span> が <span
class="math inline">\(k \ddot{u}\)</span>
になっているのは式からコードに翻訳したときの打ち間違いなのですが、上手く動いてしまいました。この時点で
<span class="math inline">\(k\)</span>
はばね係数ではなくなっています。</p>
<p><span class="math inline">\(V[n]\)</span>
は入力信号から計算した速度です。</p>
<p><span class="math display">\[
V[n] = x[n] - x[n-1]
\]</span></p>
<p>係数 <span class="math inline">\(c\)</span> 、 <span
class="math inline">\(k\)</span> 、 <span
class="math inline">\(\alpha\)</span> の範囲は全て 0 以上、 1
以下です。</p>
<p><span class="math display">\[
0 \leq c \leq 1, \quad 0 \leq k \leq 1, \quad 0 \leq \alpha \leq 1
\]</span></p>
<p>実装です。</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.signal <span class="im">as</span> signal</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> pyplot</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model:</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, damping, spring_k):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.c <span class="op">=</span> damping</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.k <span class="op">=</span> spring_k</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.acc <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vel <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pos <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.x1 <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process(<span class="va">self</span>, x0):</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.acc <span class="op">=</span> <span class="va">self</span>.c <span class="op">*</span> <span class="va">self</span>.vel <span class="op">+</span> <span class="va">self</span>.k <span class="op">*</span> <span class="va">self</span>.acc</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vel <span class="op">-=</span> <span class="va">self</span>.acc <span class="op">+</span> x0 <span class="op">-</span> <span class="va">self</span>.x1</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pos <span class="op">-=</span> <span class="va">self</span>.c <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> <span class="va">self</span>.k) <span class="op">*</span> <span class="va">self</span>.vel</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.x1 <span class="op">=</span> x0</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.pos</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(<span class="fl">0.01</span>, <span class="fl">0.96</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>samplerate <span class="op">=</span> <span class="dv">48000</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>duration <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>frequency <span class="op">=</span> <span class="dv">60</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>phase <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> frequency <span class="op">*</span> duration, <span class="bu">int</span>(duration <span class="op">*</span> samplerate))</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>sig <span class="op">=</span> signal.square(phase)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># sig = np.sin(phase)</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>filtered <span class="op">=</span> np.array([model.process(x) <span class="cf">for</span> x <span class="kw">in</span> sig])</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>pyplot.plot(sig)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>pyplot.plot(filtered)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>pyplot.show()</span></code></pre></div>
<p>係数を <span class="math inline">\(c = 0.01,\ k = 0.96\)</span>
として、周波数 60 Hz 、デューティ比 50%
の矩形波を入力したときの出力です。</p>
<figure>
<img src="img/Square.png" alt="Image of the filter output from 60 Hz square wave input." style="padding-bottom: 12px;"/>
</figure>
<p>係数を <span class="math inline">\(c = 0.01,\ k = 0.96\)</span>
として 60 Hz のサイン波を入力したときの出力です。</p>
<figure>
<img src="img/Sin.png" alt="Image of the filter output from 60 Hz sine wave input." style="padding-bottom: 12px;"/>
</figure>
<p>性質を調べて <span class="math inline">\(c\)</span> と <span
class="math inline">\(k\)</span> をチューニングします。</p>
<h2 id="出力の大きさ"><a href="#出力の大きさ" class="header-anchor"
aria-hidden="true">出力の大きさ</a></h2>
<p><span class="math inline">\(u\)</span>
の式で出力の大きさを調整しています。</p>
<p><span class="math display">\[
u \mathrel{{-}{=}} \frac{c}{1 - k} \dot{u}
\]</span></p>
<p><span class="math inline">\(\dot{u}\)</span> の係数に <span
class="math inline">\(\dfrac{c}{1 - k}\)</span>
を使うとカットオフ周波数が低くなっても出力の大きさがあまり変わりません。</p>
<p><span class="math inline">\(\dot{u}\)</span> の係数に <span
class="math inline">\(c\)</span>
を使うとカットオフ周波数が低くなると出力も小さくなります。</p>
<p>これらの係数は試行錯誤で見つけました。</p>
<h2 id="伝達関数"><a href="#伝達関数" class="header-anchor"
aria-hidden="true">伝達関数</a></h2>
<p>フィルタの式に時間のインデックスをつけます。</p>
<p><span class="math display">\[
\begin{aligned}
\ddot{u}[n] =&amp; c \dot{u}[n-1] + k \ddot{u}[n-1] \\
\dot{u}[n] =&amp; \dot{u}[n-1] - \ddot{u}[n] - x[n] + x[n-1] \\
u[n] =&amp; \alpha \left( u[n-1] - \frac{c}{1 - k} \dot{u}[n] \right) \\
\end{aligned}
\]</span></p>
<p><span class="math inline">\(n\)</span>
はサンプル数で表された現在の時刻、 <span
class="math inline">\(\alpha\)</span>
は直流を除去するために追加した適当な係数です。</p>
<p><span class="math inline">\(u[n]\)</span> の式を <span
class="math inline">\(\dot{u}[n]\)</span> について解きます。</p>
<p><span class="math display">\[
\dot{u}[n] = \frac{1 - k}{c} \left( u[n-1] - \frac{1}{\alpha} u[n]
\right)
\]</span></p>
<p><span class="math inline">\(\dot{u}[n]\)</span> の式を <span
class="math inline">\(\ddot{u}[n]\)</span> について解きます。</p>
<p><span class="math display">\[
\ddot{u}[n] = \dot{u}[n-1] - \dot{u}[n] - x[n] + x[n-1]
\]</span></p>
<p>Maxima を使って <span class="math inline">\(u[n-i]\)</span>
の項だけが残るように式を変形します。</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode maxima"><code class="sourceCode maxima"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cn">d1_u</span>(<span class="cn">n</span>) := (<span class="dv">1</span> - <span class="cn">k</span>) / <span class="cn">c</span> * (<span class="cn">u</span>(<span class="cn">n</span> - <span class="dv">1</span>) - <span class="cn">u</span>(<span class="cn">n</span>) / α);</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cn">d2_u</span>(<span class="cn">n</span>) := <span class="cn">d1_u</span>(<span class="cn">n</span> - <span class="dv">1</span>) - <span class="cn">d1_u</span>(<span class="cn">n</span>) - <span class="cn">x</span>(<span class="cn">n</span>) + <span class="cn">x</span>(<span class="cn">n</span> - <span class="dv">1</span>);</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cn">result</span>: <span class="cn">d2_u</span>(<span class="cn">n</span>) = <span class="cn">c</span> * <span class="cn">d1_u</span>(<span class="cn">n</span> - <span class="dv">1</span>) + <span class="cn">k</span> * <span class="cn">d2_u</span>(<span class="cn">n</span> - <span class="dv">1</span>);</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ratvars</span>(<span class="cn">u</span>(<span class="cn">n</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-3</span>), <span class="cn">x</span>(<span class="cn">n</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-3</span>));</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ratexpand</span>(<span class="dv">0</span> = <span class="fu">lhs</span>(<span class="cn">result</span>) - <span class="fu">rhs</span>(<span class="cn">result</span>));</span></code></pre></div>
<p>出力です。</p>
<p><span class="math display">\[
\begin{aligned}
0=&amp;
- x(n)
\\&amp;
+ k x(n-1) + x( n-1)
\\&amp;
- k x(n-2)
\\&amp;
-\frac{k u(n)}{c \alpha}+\frac{u(n)}{c \alpha }
\\&amp;
+\frac{k^2 u(n-1)}{c \alpha}
- \frac{u(n-1)}{c \alpha}
- \frac{k u(n-1)}{\alpha}
+ \frac{u(n-1)}{\alpha}
+ \frac{k u(n-1)}{c}
- \frac{u(n-1)}{c}
\\&amp;
- \frac{k^2 u(n-2)}{c \alpha}
+ \frac{k u(n-2)}{c \alpha}
- \frac{k^2 u(n-2)}{c}
+ \frac{u(n-2)}{c}
+ k u(n-2)
- u(n-2)
\\&amp;
+ \frac{k^2 u(n-3)}{c}
- \frac{k u(n-3)}{c}
\end{aligned}
\]</span></p>
<p>出力を整理した式です。</p>
<p><span class="math display">\[
\begin{aligned}
x[n] - (1 + k) x[n-1] + k x[n-2]
=&amp;
- \frac{k - 1}{c \alpha} u[n]
\\&amp;
+ \left( \frac{k^2 - 1}{c \alpha} - \frac{k - 1}{\alpha} + \frac{k -
1}{c} \right) u[n-1]
\\&amp;
+ \left( -\frac{k^2 - k}{c \alpha} - \frac{k^2 - 1}{c} + k - 1 \right)
u[n-2]
\\&amp;
+ \frac{k^2 - k}{c} u[n-3]
\end{aligned}
\]</span></p>
<p>伝達関数が得られました。</p>
<p><span class="math display">\[
H(z) = \frac{
  1 - (k + 1) z^{-1} + k z^{-2}
}{
    C_0
  + C_1 z^{-1}
  + C_2 z^{-2}
  + C_3 z^{-3}
}
\qquad
\begin{aligned}
C_0 &amp;= - \frac{k - 1}{c \alpha} \\
C_1 &amp;= \frac{k^2 - 1}{c \alpha} - \frac{k - 1}{\alpha} + \frac{k -
1}{c} \\
C_2 &amp;= -\frac{k^2 - k}{c \alpha} - \frac{k^2 - 1}{c} + k - 1 \\
C_3 &amp;= \frac{k^2 - k}{c} \\
\end{aligned}
\]</span></p>
<h2 id="ローパスのカットオフ周波数のチューニング"><a
href="#ローパスのカットオフ周波数のチューニング" class="header-anchor"
aria-hidden="true">ローパスのカットオフ周波数のチューニング</a></h2>
<p>Maxima の <a
href="http://maxima.sourceforge.net/docs/manual/maxima_20.html#solve"><code>solve</code></a>
を試したところ伝達関数からカットオフ周波数 <span
class="math inline">\(\omega_c\)</span>
を計算する式は得られませんでした。そこで <a
href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.freqz.html"><code>scipy.signal.freqz</code></a>
から得られる振幅特性を基にして <span
class="math inline">\(\omega_c\)</span> から係数 <span
class="math inline">\(c\)</span>
を求める近似曲線を作ることにしました。</p>
<p>係数 <span class="math inline">\(c\)</span>
の値を変えるとカットオフ周波数 <span
class="math inline">\(\omega_c\)</span> が変わるようなので <span
class="math inline">\(c\)</span> と <span
class="math inline">\(\omega_c\)</span> の関係をプロットします。 <span
class="math inline">\(k\)</span> の値は 0 に固定します。</p>
<p>次のコードを Python3 のインタープリタにコピペすると動きます。 <a
href="https://numpy.org/">NumPy</a> 、 <a
href="https://scipy.org/">SciPy</a> 、 <a
href="https://matplotlib.org/">Matplotlib</a> が必要です。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.signal <span class="im">as</span> signal</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> pyplot</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transferFunction(c, k, α<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">1</span>, <span class="op">-</span>(k <span class="op">+</span> <span class="dv">1</span>), k, <span class="dv">0</span>],</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span>(k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> (c <span class="op">*</span> α),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            (k <span class="op">*</span> k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> (c <span class="op">*</span> α) <span class="op">-</span> (k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> α <span class="op">+</span> (k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> c,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            k <span class="op">*</span> (k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> (c <span class="op">*</span> α) <span class="op">-</span> (k <span class="op">*</span> k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> c <span class="op">+</span> k <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            k <span class="op">*</span> (k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> c,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cutoffPlot():</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    cmap <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;viridis&quot;</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    nPlot <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, c <span class="kw">in</span> <span class="bu">enumerate</span>(np.geomspace(<span class="fl">1e-5</span>, <span class="dv">1</span>, nPlot)):</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">#</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 振幅特性をプロット。</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        b, a <span class="op">=</span> transferFunction(c, <span class="fl">0.0</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        ω, h <span class="op">=</span> signal.freqz(b, a, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        gain <span class="op">=</span> <span class="dv">20</span> <span class="op">*</span> np.log10(<span class="bu">abs</span>(h))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        pyplot.plot(ω, gain, color<span class="op">=</span>cmap(idx <span class="op">/</span> nPlot), label<span class="op">=</span><span class="ss">f&quot;c=</span><span class="sc">{</span>c<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">#</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -3 dB の ω_c を探す。</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        index <span class="op">=</span> np.argmax(gain <span class="op">&lt;=</span> <span class="op">-</span><span class="dv">3</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> index <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        prev <span class="op">=</span> index <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        delta_range <span class="op">=</span> gain[index] <span class="op">-</span> gain[prev]</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        ratio <span class="op">=</span> (<span class="op">-</span><span class="dv">3</span> <span class="op">-</span> gain[prev]) <span class="op">/</span> delta_range</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> ω[prev] <span class="op">+</span> ratio <span class="op">*</span> (ω[index] <span class="op">-</span> ω[prev])</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> gain[prev] <span class="op">+</span> ratio <span class="op">*</span> delta_range</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        pyplot.scatter(x, y, color<span class="op">=</span>cmap(idx <span class="op">/</span> nPlot))</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    pyplot.xscale(<span class="st">&quot;log&quot;</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    pyplot.show()</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>cutoffPlot()</span></code></pre></div>
<p>出力された振幅特性のプロットです。丸い点は対応する色の振幅特性の -3
dB の位置を表しています。</p>
<figure>
<img src="img/AmplitudeResponse.png" alt="Image of amplitude responce plot." style="padding-bottom: 12px;"/>
</figure>
<p>カットオフ周波数 <span class="math inline">\(\omega_c\)</span>
と対応する係数 <span class="math inline">\(c\)</span>
の値をプロットします。</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dampingCutoffPlot():</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    cmapReal <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;viridis&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    xC <span class="op">=</span> np.linspace(<span class="fl">1e-5</span>, <span class="dv">1</span>, <span class="dv">128</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> []</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, c <span class="kw">in</span> <span class="bu">enumerate</span>(xC):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        b, a <span class="op">=</span> transferFunction(c, <span class="fl">0.0</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        ω, h <span class="op">=</span> signal.freqz(b, a, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        gain <span class="op">=</span> <span class="dv">20</span> <span class="op">*</span> np.log10(<span class="bu">abs</span>(h))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        index <span class="op">=</span> np.argmax(gain <span class="op">&lt;=</span> <span class="op">-</span><span class="dv">3</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> index <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        prev <span class="op">=</span> index <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        delta_range <span class="op">=</span> gain[index] <span class="op">-</span> gain[prev]</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        ratio <span class="op">=</span> (<span class="op">-</span><span class="dv">3</span> <span class="op">-</span> gain[prev]) <span class="op">/</span> delta_range</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        cutoff <span class="op">=</span> ω[prev] <span class="op">+</span> ratio <span class="op">*</span> (ω[index] <span class="op">-</span> ω[prev])</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        data.append((c, cutoff))</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        pyplot.scatter(cutoff, c, color<span class="op">=</span>cmapReal(idx <span class="op">/</span> <span class="bu">len</span>(xC)))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># [0, 1] に正規化された周波数から c を計算するための近似曲線を求める。</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    xC_fit, ω_c_fit <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>data)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    ω_c_fit <span class="op">=</span> np.array(ω_c_fit) <span class="op">/</span> <span class="dv">2</span> <span class="op">/</span> np.pi</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    polyCoef <span class="op">=</span> np.polyfit(ω_c_fit, xC_fit, <span class="dv">6</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>([p <span class="cf">for</span> p <span class="kw">in</span> polyCoef])</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    polyCoef[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># ω_c = 0 のとき c = 0 となるように定数を変更。</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    poly <span class="op">=</span> np.poly1d(polyCoef)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    curveX <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1024</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    curveY <span class="op">=</span> poly(curveX)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    pyplot.plot(curveX <span class="op">*</span> <span class="dv">2</span> <span class="op">*</span> np.pi, curveY, label<span class="op">=</span><span class="st">&quot;polyfit&quot;</span>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># プロット。</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    pyplot.title(<span class="st">&quot;c - ω_c Plot&quot;</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    pyplot.ylabel(<span class="st">&quot;c&quot;</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    pyplot.xlabel(<span class="st">&quot;Cutoff Frequency [rad/sample]&quot;</span>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    pyplot.legend()</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    pyplot.grid()</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    pyplot.show()</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>dampingCutoffPlot()</span></code></pre></div>
<p>出力された <span class="math inline">\(c \text{--} \omega_c\)</span>
プロットです。丸い点が実データ、曲線は 6
次の多項式による近似曲線です。</p>
<figure>
<img src="img/Factor_cCutoffPlot.png" alt="Image of c-ω_c plot." style="padding-bottom: 12px;"/>
</figure>
<p>カットオフ周波数 <span class="math inline">\(\omega_c\)</span>
から係数 <span class="math inline">\(c\)</span>
を求める近似曲線の多項式です。中点 <span
class="math inline">\(\cdot\)</span> は乗算を表しています。 <span
class="math inline">\(x = \dfrac{\omega_c}{\pi}\)</span>
と定義しています。</p>
<p><span class="math display">\[
\begin{aligned}
c \approx &amp; 56.85341479156533 \cdot x^6 - 60.92051508862034 \cdot
x^5 - 1.6515635438744682 \cdot x^4 \\
  &amp; + 31.558896956675998 \cdot x^3 - 20.61402812645397 \cdot x^2 +
6.320753515093109 \cdot x
\end{aligned}
\]</span></p>
<p>カットオフ周波数 <span class="math inline">\(\omega_c\)</span>
から係数 <span class="math inline">\(c\)</span> を求める多項式の C++
の実装です。</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> lowpassHzToC<span class="op">(</span><span class="dt">float</span> sampleRate<span class="op">,</span> <span class="dt">float</span> cutoffHz<span class="op">)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> x <span class="op">=</span> cutoffHz <span class="op">/</span> sampleRate<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dt">float</span><span class="op">(</span><span class="fl">56.85341479156533</span><span class="op">)</span> <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> <span class="dt">float</span><span class="op">(-</span><span class="fl">60.92051508862034</span><span class="op">)</span>   <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> <span class="dt">float</span><span class="op">(-</span><span class="fl">1.6515635438744682</span><span class="op">)</span>  <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> <span class="dt">float</span><span class="op">(</span><span class="fl">31.558896956675998</span><span class="op">)</span>   <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> <span class="dt">float</span><span class="op">(-</span><span class="fl">20.61402812645397</span><span class="op">)</span>   <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> <span class="dt">float</span><span class="op">(</span><span class="fl">6.320753515093109</span><span class="op">)</span>    <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>次のような式の書き方もできますが、 <code>g++ -O3</code> で chrono
を使って簡単なベンチマークを取ったところ、私の環境では計算速度は変わらなかったです。</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> lowpassHzToC<span class="op">(</span><span class="dt">float</span> sampleRate<span class="op">,</span> <span class="dt">float</span> cutoffHz<span class="op">)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> x <span class="op">=</span> cutoffHz <span class="op">/</span> sampleRate<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(((((</span><span class="dt">float</span><span class="op">(</span><span class="fl">56.85341479156533</span><span class="op">)</span> <span class="op">*</span> x <span class="op">+</span> <span class="dt">float</span><span class="op">(-</span><span class="fl">60.92051508862034</span><span class="op">)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">*</span> x <span class="op">+</span> <span class="dt">float</span><span class="op">(-</span><span class="fl">1.6515635438744682</span><span class="op">)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">*</span> x <span class="op">+</span> <span class="dt">float</span><span class="op">(</span><span class="fl">31.558896956675998</span><span class="op">)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">*</span> x <span class="op">+</span> <span class="dt">float</span><span class="op">(-</span><span class="fl">20.61402812645397</span><span class="op">)</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">*</span> x <span class="op">+</span> <span class="dt">float</span><span class="op">(</span><span class="fl">6.320753515093109</span><span class="op">)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="レゾナンスのチューニング"><a href="#レゾナンスのチューニング"
class="header-anchor"
aria-hidden="true">レゾナンスのチューニング</a></h2>
<p>フィルタの式の係数 <span class="math inline">\(k\)</span>
を変えるとレゾナンスが変わるようです。レゾナンスを変えたときの振幅のピークが一定になるようにチューニングします。</p>
<p>まずは <span class="math inline">\(k\)</span>
を変えたときに振幅特性のピークがどう変わるかを調べました。</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> resonancePeakPlot():</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    cmap <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;viridis&quot;</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    nC <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    kArray <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> np.geomspace(<span class="fl">1e-5</span>, <span class="dv">1</span>, <span class="dv">128</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, c <span class="kw">in</span> <span class="bu">enumerate</span>(np.linspace(<span class="fl">0.1</span>, <span class="dv">1</span>, nC)):</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        dataY <span class="op">=</span> []</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> kArray:</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            b, a <span class="op">=</span> transferFunction(c, k, <span class="dv">1</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>            ω, h <span class="op">=</span> signal.freqz(b, a, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>            h[np.isfinite(h) <span class="op">==</span> <span class="va">False</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            peak <span class="op">=</span> np.<span class="bu">max</span>(np.<span class="bu">abs</span>(h))</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> np.isfinite(peak):</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(idx, c, k, peak)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>            dataY.append(peak)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        pyplot.plot(<span class="dv">1</span> <span class="op">-</span> kArray, dataY, color<span class="op">=</span>cmap(idx <span class="op">/</span> nC), label<span class="op">=</span><span class="ss">f&quot;c=</span><span class="sc">{</span>c<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    pyplot.ylabel(<span class="st">&quot;Peak Amplitude&quot;</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    pyplot.xlabel(<span class="st">&quot;1 - k&quot;</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    pyplot.xscale(<span class="st">&quot;log&quot;</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    pyplot.yscale(<span class="st">&quot;log&quot;</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    pyplot.grid()</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    pyplot.legend()</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    pyplot.show()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>resonancePeakPlot()</span></code></pre></div>
<p>出力されたプロットです。</p>
<figure>
<img src="img/PeakKPlot.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<p><span class="math inline">\(c\)</span> の値によらず、 <span
class="math inline">\(1 - k\)</span> が 0
に近づくと指数関数的にピークが大きくなっています。近似曲線を 1 つ作って
<span class="math inline">\(c\)</span>
に応じてスケーリングを変えれば良さそうです。</p>
<p>振幅特性のピークの値と係数 <span class="math inline">\(c\)</span>
の値を決めたときの <span class="math inline">\(k\)</span>
を二分探索で探します。次のコードを実行すると <code>data.json</code>
ファイルを作成して計算結果を書き込みます。</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> findUniformResonance():</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    maxIteration <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> []</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    targetPeak <span class="op">=</span> np.geomspace(<span class="dv">1</span>, <span class="fl">1e5</span>, <span class="dv">16</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    nC <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    xC <span class="op">=</span> np.geomspace(<span class="fl">1e-4</span>, <span class="dv">1</span>, nC)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> target <span class="kw">in</span> targetPeak:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        peakData <span class="op">=</span> []</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> xC:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>            jdx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>            diff <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            k <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            delta <span class="op">=</span> k</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>            peak <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> diff <span class="op">&gt;</span> <span class="fl">1e-5</span> <span class="kw">and</span> jdx <span class="op">&lt;</span> maxIteration:</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>                b, a <span class="op">=</span> transferFunction(c, k)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>                ω, h <span class="op">=</span> signal.freqz(b, a, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>                h[np.isfinite(h) <span class="op">==</span> <span class="va">False</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                peak <span class="op">=</span> np.<span class="bu">max</span>(np.<span class="bu">abs</span>(h))</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                diff <span class="op">=</span> <span class="bu">abs</span>(target <span class="op">-</span> peak)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                delta <span class="op">*=</span> <span class="fl">0.5</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> peak <span class="op">&lt;</span> target:</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                    k <span class="op">+=</span> delta</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                    k <span class="op">-=</span> delta</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>                jdx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>target<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>peak<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>            peakData.append({<span class="st">&quot;c&quot;</span>: c, <span class="st">&quot;k&quot;</span>: k, <span class="st">&quot;peak&quot;</span>: peak})</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        data.append({</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;targetPeak&quot;</span>: target,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;c&quot;</span>: [d[<span class="st">&quot;c&quot;</span>] <span class="cf">for</span> d <span class="kw">in</span> peakData],</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;k&quot;</span>: [d[<span class="st">&quot;k&quot;</span>] <span class="cf">for</span> d <span class="kw">in</span> peakData],</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;peak&quot;</span>: [d[<span class="st">&quot;peak&quot;</span>] <span class="cf">for</span> d <span class="kw">in</span> peakData],</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;data.json&quot;</span>, <span class="st">&quot;w&quot;</span>) <span class="im">as</span> fi:</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        json.dump(data, fi, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>findUniformResonance()</span></code></pre></div>
<p>出力された <code>data.json</code> から <span
class="math inline">\(c\)</span> と <span
class="math inline">\(k\)</span>
についてプロットします。点線は近似曲線です。</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plotResonance(data):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    cmapV <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;viridis&quot;</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    cmapP <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;plasma&quot;</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, dat <span class="kw">in</span> <span class="bu">enumerate</span>(data):</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dat[<span class="st">&quot;targetPeak&quot;</span>] <span class="op">==</span> <span class="fl">1.0</span>:</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        damping <span class="op">=</span> np.array(dat[<span class="st">&quot;c&quot;</span>])</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        spring <span class="op">=</span> np.array(dat[<span class="st">&quot;k&quot;</span>])</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        peak <span class="op">=</span> np.array(dat[<span class="st">&quot;peak&quot;</span>])</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        pyplot.plot(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>            damping,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span> <span class="op">-</span> spring,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            lw<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>cmapV(idx <span class="op">/</span> <span class="bu">len</span>(data)),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f&quot;Peak=</span><span class="sc">{</span>dat[<span class="st">&#39;targetPeak&#39;</span>]<span class="sc">:g}</span><span class="ss">&quot;</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        kMin <span class="op">=</span> np.<span class="bu">min</span>(spring)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        kMax <span class="op">=</span> np.<span class="bu">max</span>(spring)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> kMax <span class="op">-</span> (kMax <span class="op">-</span> kMin) <span class="op">*</span> np.arccos(<span class="dv">1</span> <span class="op">-</span> np.array(damping)) <span class="op">/</span> (np.pi <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        pyplot.plot(damping, <span class="dv">1</span> <span class="op">-</span> y, lw<span class="op">=</span><span class="dv">1</span>, ls<span class="op">=</span><span class="st">&quot;:&quot;</span>, color<span class="op">=</span>cmapP(idx <span class="op">/</span> <span class="bu">len</span>(data)))</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    pyplot.title(<span class="st">&quot;c-k Plot (dotted line is approximation)&quot;</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    pyplot.xlabel(<span class="st">&quot;c&quot;</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    pyplot.ylabel(<span class="st">&quot;1 - k&quot;</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    pyplot.yscale(<span class="st">&quot;log&quot;</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    pyplot.legend(ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    pyplot.grid()</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    pyplot.tight_layout()</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    pyplot.show()</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;data.json&quot;</span>, <span class="st">&quot;r&quot;</span>) <span class="im">as</span> fi:</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> json.load(fi)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>plotResonance(data)</span></code></pre></div>
<p>出力されたプロットです。実線は <code>data.json</code>
からプロットした実データ、点線は近似曲線です。</p>
<figure>
<img src="img/CKPlot.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<p>近似曲線の式です。</p>
<p><span class="math display">\[
k \approx k_{\mathrm{Max}} - \frac{2}{\pi} (k_{\mathrm{Max}} -
k_{\mathrm{Min}}) \arccos(1 - c)
\]</span></p>
<p>近似曲線は <span class="math inline">\(\arccos\)</span>
を使って試行錯誤で作りました。 <span
class="math inline">\(\arccos\)</span> の利用は <span
class="math inline">\(1-k\)</span>
の軸を線形スケールにしたときのプロットを見て適当に決めました。</p>
<p><span class="math inline">\(\arccos\)</span>
による近似曲線はピークが小さくなるほど実際の特性からずれていますが、ピークが大きいときはよく近似できているように見えます。</p>
<p>上の <span class="math inline">\(c \text{--} k\)</span> プロットでは
<span class="math inline">\(k_{\mathrm{Min}}\)</span> と <span
class="math inline">\(k_{\mathrm{Max}}\)</span>
を実データから取得して近似曲線を計算しています。 DSP
の計算中には実データは使えないので <span
class="math inline">\(k_{\mathrm{Min}}\)</span> と <span
class="math inline">\(k_{\mathrm{Max}}\)</span>
の近似曲線を作ります。</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plotSpringMinMax(data):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    kMin <span class="op">=</span> []</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    kMax <span class="op">=</span> []</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    target <span class="op">=</span> []</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, dat <span class="kw">in</span> <span class="bu">enumerate</span>(data):</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        damping <span class="op">=</span> dat[<span class="st">&quot;c&quot;</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        spring <span class="op">=</span> dat[<span class="st">&quot;k&quot;</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        peak <span class="op">=</span> dat[<span class="st">&quot;peak&quot;</span>]</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        target.append(dat[<span class="st">&quot;targetPeak&quot;</span>])</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        kMin.append(np.<span class="bu">min</span>(spring))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        kMax.append(np.<span class="bu">max</span>(spring))</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># kMin plot.</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    resonance <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1024</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">-</span> kMin[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> np.exp(alpha <span class="op">*</span> resonance)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(alpha)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    pyplot.plot(</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        resonance, y, zorder<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, color<span class="op">=</span><span class="st">&quot;#00ff00&quot;</span>, label<span class="op">=</span><span class="st">&quot;approx.&quot;</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    fitX <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="bu">len</span>(kMin))</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    pyplot.plot(fitX, kMin, lw<span class="op">=</span><span class="dv">4</span>, zorder<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">&quot;black&quot;</span>, label<span class="op">=</span><span class="st">&quot;kMin&quot;</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    pyplot.title(<span class="st">&quot;k_Min-Resonance Plot&quot;</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    pyplot.xlabel(<span class="st">&quot;Resonance&quot;</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    pyplot.ylabel(<span class="st">&quot;k&quot;</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    pyplot.grid()</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    pyplot.legend()</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    pyplot.show()</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># KMax plot.</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    resonance <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1024</span>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    offset <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> kMin[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> np.log(offset)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> kMax[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> <span class="fl">0.01</span> <span class="op">*</span> (np.exp(alpha <span class="op">*</span> resonance) <span class="op">-</span> offset)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    pyplot.plot(</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        resonance, y, zorder<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, color<span class="op">=</span><span class="st">&quot;#00ff00&quot;</span>, label<span class="op">=</span><span class="st">&quot;approx.&quot;</span>)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(kMax[<span class="op">-</span><span class="dv">1</span>], alpha, offset)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    pyplot.plot(fitX, kMax, lw<span class="op">=</span><span class="dv">4</span>, zorder<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">&quot;black&quot;</span>, label<span class="op">=</span><span class="st">&quot;kMax&quot;</span>)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    pyplot.title(<span class="st">&quot;k_Max-Resonance Plot&quot;</span>)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    pyplot.xlabel(<span class="st">&quot;Resonance&quot;</span>)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    pyplot.ylabel(<span class="st">&quot;k&quot;</span>)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    pyplot.grid(zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    pyplot.legend()</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    pyplot.tight_layout()</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    pyplot.show()</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>plotSpringMinMax(data)</span></code></pre></div>
<p>出力されたプロットです。黒い線が実データ、緑の線 <code>approx.</code>
は近似曲線です。</p>
<figure>
<img src="img/kMinResonancePlot.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<figure>
<img src="img/kMaxResonancePlot.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<p><span class="math inline">\(k_{\mathrm{Min}}\)</span>
の近似曲線の式です。 <span
class="math inline">\(\mathtt{resonance}\)</span>
はユーザが指定するレゾナンスの値で、範囲は <span
class="math inline">\([0, 1]\)</span> です。</p>
<p><span class="math display">\[
k_{\mathrm{Min}} = 1 - \exp(-5.6852537097945195 \cdot
\mathtt{resonance})
\]</span></p>
<p><span class="math inline">\(k_{\mathrm{Max}}\)</span>
の近似曲線の式です。</p>
<p><span class="math display">\[
\begin{aligned}
k_{\mathrm{Max}} =&amp; 0.9999771732485103 \\
  &amp;- 0.01 \cdot (\exp(-5.6852537097945195 \cdot \mathtt{resonance})
- 0.0033956716251850594)
\end{aligned}
\]</span></p>
<p>レゾナンスのチューニングができました。 C++ で実装します。</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">double</span> halfpi <span class="op">=</span> <span class="fl">1.57079632679489661923</span><span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> resonanceToK<span class="op">(</span><span class="dt">float</span> c<span class="op">,</span> <span class="dt">float</span> resonance<span class="op">,</span> <span class="dt">bool</span> uniformPeak<span class="op">)</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> kExp <span class="op">=</span> expf<span class="op">(</span><span class="dt">float</span><span class="op">(-</span><span class="fl">5.6852537097945195</span><span class="op">)</span> <span class="op">*</span> resonance<span class="op">);</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> kMin <span class="op">=</span> <span class="dt">float</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">-</span> kExp<span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> kMax <span class="op">=</span> <span class="dt">float</span><span class="op">(</span><span class="fl">0.9999771732485103</span><span class="op">)</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> <span class="dt">float</span><span class="op">(</span><span class="fl">0.01</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>kExp <span class="op">-</span> <span class="dt">float</span><span class="op">(</span><span class="fl">0.0033956716251850594</span><span class="op">));</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> kMax <span class="op">-</span> <span class="op">(</span>kMax <span class="op">-</span> kMin<span class="op">)</span> <span class="op">*</span> acosf<span class="op">(</span><span class="dt">float</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">-</span> c<span class="op">)</span> <span class="op">/</span> <span class="dt">float</span><span class="op">(</span>halfpi<span class="op">);</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="ハイパスのカットオフ周波数のチューニング"><a
href="#ハイパスのカットオフ周波数のチューニング" class="header-anchor"
aria-hidden="true">ハイパスのカットオフ周波数のチューニング</a></h2>
<p>カットオフ周波数とレゾナンスのチューニングを終えて、プラグインにして試していると直流が乗ることに気がついたので
<span class="math inline">\(\alpha\)</span> を追加しました。 <span
class="math inline">\(\alpha\)</span>
を変えるとハイパスフィルタのカットオフ周波数が変わるようです。</p>
<p>ローパスのカットオフ周波数とチューニングの手順は同じなので結果だけ掲載します。</p>
<p>カットオフ周波数 <span class="math inline">\(\omega_c\)</span>
に対応する <span class="math inline">\(\alpha\)</span>
の値のプロットです。丸い点が実データ、 曲線は指数関数を使って <a
href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.curve_fit.html"><code>scipy.optimize.curve_fit</code></a>
で求めた近似です。</p>
<figure>
<img src="img/HighpassCutoffPlot.png" alt="Image of α-ω_c plot." style="padding-bottom: 12px;"/>
</figure>
<p><code>expfit</code> の式です。</p>
<p><span class="math display">\[
\alpha = 0.5638865655409118 + 0.43611343445908823 \cdot
\exp(-6.501239408777854 x)
\]</span></p>
<p>カットオフを -3 dB から -6 dB
に変えたときの式も求めました。こちらのほうが <span
class="math inline">\(\alpha\)</span> の範囲を広く使えます。</p>
<p><span class="math display">\[
\alpha = 0.39299084333814804 + 0.607009156661852 \cdot
\exp(-4.939791161282682 x)
\]</span></p>
<h2 id="実装"><a href="#実装" class="header-anchor"
aria-hidden="true">実装</a></h2>
<p>C++ による実装例です。</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Sample<span class="op">&gt;</span> <span class="kw">class</span> LP3 <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> reset<span class="op">()</span> <span class="op">{</span> acc <span class="op">=</span> vel <span class="op">=</span> pos <span class="op">=</span> x1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> set<span class="op">(</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    Sample sampleRate<span class="op">,</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    Sample lowpassHz<span class="op">,</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    Sample highpassHz<span class="op">,</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    Sample resonance<span class="op">,</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> uniformPeak<span class="op">,</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> uniformGain<span class="op">)</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    Sample x <span class="op">=</span> lowpassHz <span class="op">/</span> sampleRate<span class="op">;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> Sample<span class="op">(</span><span class="fl">56.85341479156533</span><span class="op">)</span>   <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">+</span> Sample<span class="op">(-</span><span class="fl">60.92051508862034</span><span class="op">)</span>  <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">+</span> Sample<span class="op">(-</span><span class="fl">1.6515635438744682</span><span class="op">)</span> <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">+</span> Sample<span class="op">(</span><span class="fl">31.558896956675998</span><span class="op">)</span>  <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">+</span> Sample<span class="op">(-</span><span class="fl">20.61402812645397</span><span class="op">)</span>  <span class="op">*</span> x <span class="op">*</span> x</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">+</span> Sample<span class="op">(</span><span class="fl">6.320753515093109</span><span class="op">)</span>   <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>uniformPeak<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>      Sample kExp <span class="op">=</span> exp<span class="op">(</span>Sample<span class="op">(-</span><span class="fl">5.6852537097945195</span><span class="op">)</span> <span class="op">*</span> resonance<span class="op">);</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>      Sample kMin <span class="op">=</span> Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">-</span> kExp<span class="op">;</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>      Sample kMax <span class="op">=</span> Sample<span class="op">(</span><span class="fl">0.9999771732485103</span><span class="op">)</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> Sample<span class="op">(</span><span class="fl">0.01</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span>kExp <span class="op">-</span> Sample<span class="op">(</span><span class="fl">0.0033956716251850594</span><span class="op">));</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>      k <span class="op">=</span> kMax <span class="op">-</span> <span class="op">(</span>kMax <span class="op">-</span> kMin<span class="op">)</span> <span class="op">*</span> acos<span class="op">(</span>Sample<span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">-</span> c<span class="op">)</span> <span class="op">/</span> Sample<span class="op">(</span>halfpi<span class="op">);</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>      k <span class="op">=</span> <span class="bu">std::</span>clamp<span class="op">&lt;</span>Sample<span class="op">&gt;(</span>resonance<span class="op">,</span> Sample<span class="op">(</span><span class="dv">0</span><span class="op">),</span> Sample<span class="op">(</span><span class="dv">1</span> <span class="op">-</span> <span class="fl">1e-5</span><span class="op">));</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> Sample<span class="op">(</span><span class="fl">0.5638865655409118</span><span class="op">)</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>      <span class="op">+</span> Sample<span class="op">(</span><span class="fl">0.43611343445908823</span><span class="op">)</span> <span class="op">*</span> exp<span class="op">(</span>Sample<span class="op">(-</span><span class="fl">6.501239408777854</span><span class="op">)</span> <span class="op">*</span> x<span class="op">);</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span>uniformGain <span class="op">=</span> uniformGain<span class="op">;</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>  Sample process<span class="op">(</span>Sample x0<span class="op">)</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> k <span class="op">*</span> acc <span class="op">+</span> c <span class="op">*</span> vel<span class="op">;</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    vel <span class="op">-=</span> acc <span class="op">+</span> x0 <span class="op">-</span> x1<span class="op">;</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">-=</span> <span class="op">(</span>uniformGain <span class="op">?</span> c <span class="op">/</span> <span class="op">(</span><span class="dv">1</span> <span class="op">-</span> k<span class="op">)</span> <span class="op">:</span> c<span class="op">)</span> <span class="op">*</span> vel<span class="op">;</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">*=</span> Sample<span class="op">(</span>alpha<span class="op">);</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    x1 <span class="op">=</span> x0<span class="op">;</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pos<span class="op">;</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>  Sample c <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>  Sample k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>  Sample alpha <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> uniformGain <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>  Sample acc <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  Sample vel <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>  Sample pos <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>  Sample x1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>LV2 プラグインとして実装したフィルタのコードへのリンクです。</p>
<ul>
<li><a
href="https://github.com/ryukau/LV2Plugins/blob/master/lv2cvport/CV_3PoleLP/dsp/lp3.hpp">LV2Plugins/lp3.hpp
at master · ryukau/LV2Plugins · GitHub</a></li>
</ul>
<h2 id="音のサンプル"><a href="#音のサンプル" class="header-anchor"
aria-hidden="true">音のサンプル</a></h2>
<p>フィルタの音のサンプルです。</p>
<ul>
<li>入力は <code>scipy.signal.sawtooth</code> で生成した 45 Hz
の鋸歯波。</li>
<li>ローパスのカットオフ周波数を減衰するエンベロープで変調。</li>
<li>音量は絶対値の最大値が 1 になるように正規化。</li>
<li>ハイパスのカットオフ周波数は 20 Hz 。</li>
<li><code>uniformGain</code> は False 。</li>
</ul>
<p>サンプルの生成に使ったコードへのリンクです。実行には NumPy 、 SciPy
、 Matplotlib 、 <a
href="https://pysoundfile.readthedocs.io/en/latest/">Soundfile</a>
が必要です。</p>
<ul>
<li><a
href="https://github.com/ryukau/filter_notes/blob/master/3pole_lowpass/demo/sound.py">filter_notes/sound.py
at master · ryukau/filter_notes · GitHub</a></li>
</ul>
<h3 id="指数カーブのカットオフ"><a href="#指数カーブのカットオフ"
class="header-anchor" aria-hidden="true">指数カーブのカットオフ</a></h3>
<figure>
<figcaption>
exp, uniformPeak=False, resonance=0.0
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakFalse_resonance0.0.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=False, resonance=0.5
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakFalse_resonance0.5.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=False, resonance=0.9
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakFalse_resonance0.9.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=True, resonance=0.0
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakTrue_resonance0.0.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=True, resonance=0.5
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakTrue_resonance0.5.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=True, resonance=0.9
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakTrue_resonance0.9.wav" type="audio/wav">
</audio>
</figure>
<h3 id="直線のカットオフ"><a href="#直線のカットオフ"
class="header-anchor" aria-hidden="true">直線のカットオフ</a></h3>
<figure>
<figcaption>
lin, uniformPeak=False, resonance=0.0
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakFalse_resonance0.0.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=False, resonance=0.5
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakFalse_resonance0.5.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=False, resonance=0.9
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakFalse_resonance0.9.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=True, resonance=0.0
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakTrue_resonance0.0.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=True, resonance=0.5
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakTrue_resonance0.5.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=True, resonance=0.9
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakTrue_resonance0.9.wav" type="audio/wav">
</audio>
</figure>
<h2 id="その他"><a href="#その他" class="header-anchor"
aria-hidden="true">その他</a></h2>
<p><span class="math inline">\(\arccos\)</span> を使った近似曲線は <span
class="math inline">\(\dfrac{b_0 + b_1 x + b_2 x^2 \dots}{a_0 + a_1 x +
a_2 x^2 \dots}\)</span> という形の分数でも近似できそうです。</p>
<p>レゾナンスのチューニングは計算が重たいので、効率を重視するなら省略できます。</p>
<p>ポリフォニックシンセでノートオンごとにフィルタの状態をリセットするとき、ローパスしか使わないなら
<span class="math inline">\(\alpha\)</span> を 1
に固定して処理を減らせます。</p>
<p>FL Studio で使える Fast LP と似たような音が出ます。</p>
<h2 id="変更"><a href="#変更" class="header-anchor"
aria-hidden="true">変更</a></h2>
<ul>
<li>2020-04-15
<ul>
<li><span class="math inline">\(1 - k\)</span> となる箇所が <span
class="math inline">\(k\)</span> になっていた誤りを修正。</li>
<li>不要な「を使って」を削除。</li>
</ul></li>
</ul>
<footer>
<a href="../index.html">インデックスに戻る</a>
</footer>
</body>

</html>

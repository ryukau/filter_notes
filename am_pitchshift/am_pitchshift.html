<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja" >

<head>
<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<meta name="dcterms.date" content="2023-10-30" />
<title>am_pitchshift</title>

<!-- MathJax -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
window.MathJax = {
  tex: {
    tags: 'ams'
  }
};
</script>

<style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #666666;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #666666;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; text-decoration: underline; } /* Alert */
code span.an { color: #666666; font-style: italic; } /* Annotation */
code span.at { color: #906000; } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #000000; font-weight: bold; } /* ControlFlow */
code span.ch { color: #b000b0; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008800; } /* Comment */
code span.cv { color: #008800; } /* CommentVar */
code span.do { color: #008800; } /* Documentation */
code span.dt { color: #906000; } /* DataType */
code span.dv { color: #0000ff; } /* DecVal */
code span.er { color: #ffffff; background-color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000ff; } /* Float */
code span.im { color: #000000; font-weight: bold; } /* Import */
code span.in { color: #666666; } /* Information */
code span.kw { color: #000000; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #000000; } /* Other */
code span.pp { color: #000000; font-weight: bold; } /* Preprocessor */
code span.sc { color: #b000b0; } /* SpecialChar */
code span.ss { color: #b000b0; } /* SpecialString */
code span.st { color: #b000b0; } /* String */
code span.va { color: #000088; } /* Variable */
code span.vs { color: #b000b0; } /* VerbatimString */
code span.wa { background-color: #ffff00; font-weight: bold; font-style: italic; text-decoration: underline; } /* Warning */
</style>
<style>
body {
max-width: 704px;
margin: auto;
padding: 32px 8px;
}

img {
max-width: 100%;
}

video {
max-width: 100%;
}

kbd {
font-family: inherit;
border-style: solid;
border-width: 1px 2px 2px 1px;
border-radius: 2px;
padding: 4px;
margin: 2px;
line-height: calc(1em + 16px);
}

a {
text-decoration: none;
}

h2 {
border-left: solid 32px #000000;
padding-left: 24px;
}

h3 {
border-left: solid 20px #404040;
padding-left: 16px;
}

h4 {
border-left: solid 12px #606060;
padding-left: 8px;
}

h5 {
border-left: solid 4px #808080;
padding-left: 4px;
}

h6 {
border-left: solid 2px #a0a0a0;
padding-left: 2px;
}

table {
border-spacing: 0px;
border-collapse: separate;
border-left: 1px solid #888888;
border-right: 1px solid #888888;
border-top: 1px solid #888888;
border-bottom: hidden;
}

tr:nth-child(odd) {
background: #eeeeee;
}

tr:nth-child(even) {
background: #ffffff;
}

th {
height: 2em;
padding: 4px 1em 4px 1em;
background: #ffffff;
border-bottom: 1px solid #888888;
}

th:not(:first-child) {
border-left: 1px solid #888888;
}

td {
height: 1.5em;
padding: 4px 1em 4px 1em;
border-bottom: 1px solid #888888;
}

td:not(:first-child) {
border-left: 1px solid #888888;
}

dl {
padding-left: 2em;
}

dt {
font-weight: bold;
border-bottom: 1px dashed #000000;
margin-top: 2em;
}

dd {
border-left: 1px dotted #000000;
margin-left: 1em;
padding-left: 1em;
}

audio {
vertical-align: middle;
}

label {
vertical-align: middle;
}

:not(.sourceCode)>pre {
overflow: auto;
border: 1px solid #888888;
padding: 8px;
}

div.sourceCode {
overflow: auto;
border: 1px solid #888888;
padding: 8px;
}

pre>code.sourceCode>span>a:first-child::before {
border-right: 1px solid #888888;
padding-right: 1em;
margin-right: 1em;
text-decoration: none;
}

:not(pre)>code {
color: #163eac;
}

li {
margin: 8px;
}

summary:hover {
background-color: #eeeeee;
}

header {
border-bottom: 1px gray solid;
padding: 0.5em;
margin-bottom: 1em;
}

footer {
border-top: 1px gray solid;
padding: 0.5em;
margin-top: 1em;
}


canvas {
/* image-rendering: pixelated; */
display: inline-block;
border-style: solid;
border-width: 1px;
border-color: #627f84;
}

.controlBlock {
display: inline-block;
width: 450px;
text-align: left;
vertical-align: top;
margin-left: 4px;
}

input[type="button"] {
background-color: #ffffff;
border: 2px solid #aaaaaa;
font-size: 16px;
height: 32px;
}

input[type="button"]:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}

div.numberInput {
display: block;
white-space: nowrap;
}

div.numberInput:hover {
background-color: #e0ecff;
}

.numberInputLabel {
/* max 12 letter  */
display: inline-block;
margin: 0 8px 0 8px;
text-align: left;
vertical-align: middle;
width: 100px;

font-size: 10pt;
font-family: 'Courier New', Courier, monospace;
}

.numberInputNumber {
display: inline-block;
vertical-align: middle;
width: 120px;
}

.numberInputRange {
display: inline-block;
vertical-align: middle;
width: 160px;
}

.pullDownMenu {
display: inline-block;
text-align: center;
}

.pullDownMenu:hover {
background-color: #e0ecff;
}

select {
background-color: #ffffff;
border: 2px solid #aaaaaa;
height: 24px;
vertical-align: middle;
font-size: 12px;
}

select:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}

span.math.inline a {
  color: #000000;
}
</style>

<script
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
type="text/javascript"></script>
</head>

<body>
<header>
<p>
何かあれば <a href="https://github.com/ryukau/filter_notes">GitHub のリポジトリ</a>に issue を作るか ryukau@gmail.com までお気軽にどうぞ。
</p>
<hr>
<a href="../index.html">インデックスに戻る</a>
<p>
Update: 2023-10-30
</p>
<details>
<summary translate="yes">Table of Contents</summary>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#am変調による周波数シフト"
id="toc-am変調による周波数シフト">AM変調による周波数シフト</a>
<ul>
<li><a href="#analytic-signal-の計算"
id="toc-analytic-signal-の計算">Analytic Signal の計算</a></li>
<li><a href="#実装" id="toc-実装">実装</a>
<ul>
<li><a href="#ヒルベルト変換"
id="toc-ヒルベルト変換">ヒルベルト変換</a></li>
<li><a href="#オールパスその1"
id="toc-オールパスその1">オールパスその1</a></li>
<li><a href="#オールパスその2"
id="toc-オールパスその2">オールパスその2</a></li>
<li><a href="#オールパスその3"
id="toc-オールパスその3">オールパスその3</a></li>
<li><a href="#オールパスその4"
id="toc-オールパスその4">オールパスその4</a></li>
<li><a href="#オールパスその5"
id="toc-オールパスその5">オールパスその5</a></li>
<li><a href="#オールパスその6"
id="toc-オールパスその6">オールパスその6</a></li>
</ul></li>
<li><a href="#音のサンプル" id="toc-音のサンプル">音のサンプル</a></li>
<li><a href="#その他" id="toc-その他">その他</a>
<ul>
<li><a href="#周波数特性の位相差"
id="toc-周波数特性の位相差">周波数特性の位相差</a></li>
<li><a href="#scipy.signal-の-sos"
id="toc-scipy.signal-の-sos"><code>scipy.signal</code> の
<code>sos</code></a></li>
<li><a href="#pure-data-の-biquad" id="toc-pure-data-の-biquad">Pure
Data の <code>biquad~</code></a></li>
<li><a href="#ピッチシフトと周波数シフト"
id="toc-ピッチシフトと周波数シフト">ピッチシフトと周波数シフト</a></li>
</ul></li>
<li><a href="#変更点" id="toc-変更点">変更点</a></li>
</ul></li>
</ul>
</nav>
</details>
</header>
<h1 id="am変調による周波数シフト">AM変調による周波数シフト</h1>
<p>この文章では虚数を <span class="math inline">\(j\)</span>
で表します。</p>
<p>Scott Wardle さんによる <a
href="https://www.mikrocontroller.net/attachment/33905/Audio_Hilbert_WAR19.pdf">A
Hilbert-Transformer Frequency Shifter for Audio</a>
で紹介されていたAM変調による周波数シフトで遊びます。</p>
<p>紹介されていた手法では <a
href="https://en.wikipedia.org/wiki/Analytic_signal">analytic signal</a>
<span class="math inline">\(s(t)\)</span> に <span
class="math inline">\(e^{j \omega_c t}\)</span>
を掛け合わせてから実部を取り出すことで <span
class="math inline">\(\omega_c\)</span>
だけ周波数シフトできます。Analytic signal
は負の周波数成分が全て0になる信号で、複素数です。</p>
<p><span class="math display">\[
\begin{aligned}
y_{\mathtt{shift}} (t)
  &amp;= \mathrm{Re}(s(t) e^{\pm j \omega_c t})\\
  &amp;= \mathrm{Re}(|s(t)| e^{j(\angle s(t) \pm \omega_c t)})\\
  &amp;= |s(t)| \cos(\angle s(t) \pm \omega_c t)\\
|s(t)| &amp;= \sqrt{\mathrm{Re}^2(s(t)) + \mathrm{Im}^2(s(t))}\\
\angle s(t)
  &amp;= \mathrm{atan2}\left(\mathrm{Im}(s(t)), \mathrm{Re}(s(t))
\right)
\end{aligned}
\]</span></p>
<ul>
<li><a
href="https://www.mikrocontroller.net/attachment/33905/Audio_Hilbert_WAR19.pdf">WAR19
- Audio_Hilbert_WAR19.pdf</a></li>
<li><a href="https://en.wikipedia.org/wiki/Analytic_signal">Analytic
signal - Wikipedia</a></li>
</ul>
<h2 id="analytic-signal-の計算">Analytic Signal の計算</h2>
<p>任意の信号 <span class="math inline">\(x\)</span> は FFT を使って
analytic signal <span class="math inline">\(s\)</span>
に変換できます。次の式は <a
href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.hilbert.html"><code>scipy.signal.hilbert</code></a>
の計算式で <a
href="https://en.wikipedia.org/wiki/Step_function">ステップ関数</a>
<span class="math inline">\(U\)</span>
を使って負の周波数成分を0にしています。</p>
<p><span class="math display">\[
s = \mathtt{ifft}(\mathtt{fft}(x) 2 U) = x + j \mathcal{H}(x)
\]</span></p>
<p><span class="math inline">\(\mathcal{H}\)</span> は <a
href="https://en.wikipedia.org/wiki/Hilbert_transform">ヒルベルト変換</a>です。ヒルベルト変換された信号
<span class="math inline">\(\mathcal{H}(x)\)</span> は、元の信号 <span
class="math inline">\(x\)</span>
に比べると負の周波数成分の位相が90°進み、正の周波数成分の位相が90°遅れています。</p>
<p>FFT
をリアルタイム処理で使うとレイテンシや計算コストが問題になることがあります。この問題を避けるためにオールパスフィルタを使って
analytic signal
を近似する方法があります。近似では2つのオールパスフィルタ <span
class="math inline">\(H_{\mathrm{Re}},\,H_{\mathrm{Im}}\)</span>
を用意して、位相差 <span class="math inline">\(\angle (H_{\mathrm{Re}} /
H_{\mathrm{Im}})\)</span>
がヒルベルト変換の位相特性を近似するようになっています。</p>
<p>次の図は analytic signal
の近似に使われる2つのオールパスフィルタの位相差です。</p>
<figure>
<img src="niemitalo_allpass.png" alt="Image of allpass filter approximation of hilbert transfrom by Olli Niemitalo." style="width: 480px;padding-bottom: 12px;"/>
</figure>
<ul>
<li><a
href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.hilbert.html">scipy.signal.hilbert
— SciPy v1.3.0 Reference Guide</a></li>
<li><a href="https://en.wikipedia.org/wiki/Hilbert_transform">Hilbert
transform - Wikipedia</a></li>
<li><a
href="https://www.dsprelated.com/freebooks/mdft/Analytic_Signals_Hilbert_Transform.html">Analytic
Signals and Hilbert Transform Filters | Mathematics of the DFT</a></li>
<li><a
href="https://www.gaussianwaves.com/2017/04/analytic-signal-hilbert-transform-and-fft/">Analytic
signal, Hilbert Transform and FFT – GaussianWaves</a></li>
</ul>
<h2 id="実装">実装</h2>
<p>コードはPython3です。次のライブラリを使っています。</p>
<ul>
<li><a href="https://scipy.org/">SciPy, NumPy</a></li>
<li><a
href="https://pysoundfile.readthedocs.io/en/0.9.0/">PySoundfile</a></li>
</ul>
<p>上から順番にコードをテキストファイルにコピペしていけば動くプログラムになっています。完成したコードは次のリンクから読むことができます。</p>
<ul>
<li><a href="./pitchshift.py">コードを読む</a></li>
</ul>
<h3 id="ヒルベルト変換">ヒルベルト変換</h3>
<p><code>scipy.signal.hilbert</code> を使います。</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.signal <span class="im">as</span> signal</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pitch_shift(samplerate, analytic_signal, shift_hz):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    norm <span class="op">=</span> numpy.<span class="bu">abs</span>(analytic_signal)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> numpy.angle(analytic_signal)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    time <span class="op">=</span> numpy.linspace(<span class="dv">0</span>, <span class="bu">len</span>(analytic_signal) <span class="op">/</span> samplerate, <span class="bu">len</span>(analytic_signal))</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> norm <span class="op">*</span> numpy.cos(theta <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> numpy.pi <span class="op">*</span> shift_hz <span class="op">*</span> time)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> naive(samplerate, sig, shift_hz<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pitch_shift(samplerate, signal.hilbert(wav), shift_hz)</span></code></pre></div>
<h3 id="オールパスその1">オールパスその1</h3>
<p><a href="http://yehar.com/blog/?p=368">Olli Niemitalo
さんによって紹介されていたフィルタ</a>です。</p>
<p>式の <span class="math inline">\(\times\)</span>
は乗算です。横に長くなったので改行時に明示的に演算子を書いています。</p>
<p><span class="math display">\[
\begin{aligned}
H_{sect}(z, a) =&amp;\; \frac{a^2 - z^{-2}}{1 - a^2 z^{-2}}\\
H_{\mathrm{Re}}(z) =&amp;\; H_{sect}(z, 0.4021921162426)\\
  &amp; \times H_{sect}(z, 0.8561710882420)\\
  &amp; \times H_{sect}(z, 0.9722909545651)\\
  &amp; \times H_{sect}(z, 0.9952884791278)\\
H_{\mathrm{Im}}(z) =&amp;\; H_{sect}(z, 0.6923878)\\
  &amp; \times H_{sect}(z, 0.9360654322959)\\
  &amp; \times H_{sect}(z, 0.9882295226860)\\
  &amp; \times H_{sect}(z, 0.9987488452737)\\
  &amp; \times z^{-1}\\
H_{Hilbert}(z) =&amp; 0.5 ( H_{\mathrm{Re}}(z) + j H_{\mathrm{Im}}(z))
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_delay(sos):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> numpy.vstack((sos, [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>]))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> olli(samplerate, sig, shift_hz<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> section(a):</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        a2 <span class="op">=</span> a <span class="op">*</span> a</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [a2, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span>a2]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    sos_real <span class="op">=</span> numpy.array([</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        section(a) <span class="cf">for</span> a <span class="kw">in</span> [</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.4021921162426</span>, <span class="fl">0.8561710882420</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.9722909545651</span>, <span class="fl">0.9952884791278</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    sos_imag <span class="op">=</span> numpy.array([</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        section(a) <span class="cf">for</span> a <span class="kw">in</span> [</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.6923878000000</span>, <span class="fl">0.9360654322959</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.9882295226860</span>, <span class="fl">0.9987488452737</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    sos_imag <span class="op">=</span> add_delay(sos_imag)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    real <span class="op">=</span> signal.sosfilt(sos_real, sig)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    imag <span class="op">=</span> signal.sosfilt(sos_imag, sig)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    analytic <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (real <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> imag)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pitch_shift(samplerate, analytic, shift_hz)</span></code></pre></div>
<ul>
<li><a href="http://yehar.com/blog/?p=368">Hilbert transform «
iki.fi/o</a></li>
</ul>
<h3 id="オールパスその2">オールパスその2</h3>
<p><a
href="https://dsp.stackexchange.com/questions/37411/iir-hilbert-transformer">IIR
Hilbert Transformer</a> で Robby Wasabi
さんによって紹介されていたフィルタです。</p>
<p><span class="math display">\[
\begin{aligned}
H_{\mathrm{Re}}(z) =&amp;\; \frac{0.190696 - z^{-2}}{1 - 0.190696
z^{-2}}
  \times \frac{0.860735 - z^{-2}}{1 - 0.860735 z^{-2}}\\
H_{\mathrm{Im}}(z) =&amp;\; \frac{0.553100 - z^{-2}}{1 - 0.553100
z^{-2}} \times z^{-1}\\
H_{Hilbert}(z) =&amp;\; 0.5 \left( H_{\mathrm{Re}}(z) + j
H_{\mathrm{Im}}(z) \right)
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> wasabi(samplerate, sig, shift_hz<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    sos_real <span class="op">=</span> numpy.array([</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.190696</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="fl">0.190696</span>],</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.860735</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="fl">0.860735</span>],</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    sos_imag <span class="op">=</span> numpy.array([[<span class="fl">0.553100</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="fl">0.553100</span>]])</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    sos_imag <span class="op">=</span> add_delay(sos_imag)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    real <span class="op">=</span> signal.sosfilt(sos_real, sig)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    imag <span class="op">=</span> signal.sosfilt(sos_imag, sig)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    analytic <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (real <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> imag)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pitch_shift(samplerate, analytic, shift_hz)</span></code></pre></div>
<ul>
<li><a
href="https://dsp.stackexchange.com/questions/37411/iir-hilbert-transformer">transform
- IIR Hilbert Transformer - Signal Processing Stack Exchange</a></li>
</ul>
<h3 id="オールパスその3">オールパスその3</h3>
<p>Pure Data の <a
href="https://github.com/pure-data/pure-data/blob/master/extra/hilbert%7E.pd"><code>hilbert~</code></a>
で使われているフィルタです。コメントで Emmanuel Favreau さんが 1982
年頃に作った <a href="https://en.wikipedia.org/wiki/Sogitec_4X">4X</a>
のパッチから取ってきた、とクレジットされています。</p>
<p><span class="math display">\[
\begin{aligned}
H_{biquad}(z, a_1, a_2) =&amp;\;
  \frac{a_2 + a_1 z^{-1} + z^{-2}}{1 + a_1 z^{-1} + a_2 z^{-2}}\\
H_{\mathrm{Re}}(z) =&amp;\;
  H_{biquad}(z, 0.02569, -0.260502)
  H_{biquad}(z, -1.8685, 0.870686)\\
H_{\mathrm{Im}}(z) =&amp;\;
  H_{biquad}(z, -1.94632, 0.94657)
  H_{biquad}(z, -0.83774, 0.06338)\\
H_{Hilbert}(z) =&amp;\;
  H_{\mathrm{Re}}(z) + j H_{\mathrm{Im}}(z)
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> favreau(samplerate, sig, shift_hz<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> biquad(a1, a2):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [a2, a1, <span class="dv">1</span>, <span class="dv">1</span>, a1, a2]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    sos_real <span class="op">=</span> numpy.array([</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        biquad(<span class="fl">0.02569</span>, <span class="op">-</span><span class="fl">0.260502</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        biquad(<span class="op">-</span><span class="fl">1.8685</span>, <span class="fl">0.870686</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    sos_imag <span class="op">=</span> numpy.array([</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        biquad(<span class="op">-</span><span class="fl">1.94632</span>, <span class="fl">0.94657</span>),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        biquad(<span class="op">-</span><span class="fl">0.83774</span>, <span class="fl">0.06338</span>),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    real <span class="op">=</span> signal.sosfilt(sos_real, sig)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    imag <span class="op">=</span> signal.sosfilt(sos_imag, sig)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    analytic <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (real <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> imag)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pitch_shift(samplerate, analytic, shift_hz)</span></code></pre></div>
<ul>
<li><a
href="https://github.com/pure-data/pure-data/blob/master/extra/hilbert%7E.pd">pure-data/hilbert~.pd
at master · pure-data/pure-data · GitHub</a></li>
<li><a
href="https://github.com/olilarkin/OL-OWLPatches/blob/master/IIRHilbert.lib">OL-OWLPatches/IIRHilbert.lib
at master · olilarkin/OL-OWLPatches · GitHub</a></li>
<li><a
href="http://electro-music.com/forum/topic-69813.html">electro-music.com
:: View topic - Hilbert transform code</a></li>
</ul>
<h3 id="オールパスその4">オールパスその4</h3>
<p>Signal Processing Stack Exchange で Ross Wilkinson
さんが紹介していたフィルタです。</p>
<p>奇数の <span class="math inline">\(k\)</span> についてフィルタの零点
<span class="math inline">\(q_n\)</span> 、極 <span
class="math inline">\(p_n\)</span> を定義します。 <span
class="math inline">\(n\)</span> は整数です。</p>
<p><span class="math display">\[
\begin{aligned}
q_n &amp;= \begin{cases}
  \exp \left( \pi / 2^n \right) &amp; \text{if} &amp; n\geq 0,\\
  -\exp \left( \pi / 2^{|n|} \right) &amp; \text{if} &amp; n &lt; 0.
\end{cases}\\
p_n &amp;= \frac{1}{q_n}.\\
\quad n &amp;\in [-k, k], \quad n \in \mathbb{Z}. \quad k\,\text{ is
odd}.
\end{aligned}
\]</span></p>
<p><span class="math inline">\(n\)</span>
が偶数のときだけを取り出したフィルタ <span
class="math inline">\(A_k\)</span> と、 <span
class="math inline">\(n\)</span> が奇数のときだけを取り出したフィルタ
<span class="math inline">\(B_k\)</span> の2つのフィルタを作ります。</p>
<p><span class="math display">\[
\begin{aligned}
Q_n &amp;= (q_n,\,p_n)\\
\hat{A}_k &amp;= \begin{bmatrix}
  Q_{0}&amp; Q_{2}&amp; Q_{4}&amp; \dots&amp; Q_{k - 5}&amp; Q_{k -
3}&amp; Q_{k - 1}
\end{bmatrix}\\
A_k &amp;= \mathtt{concat}(-\hat{A}_k, \hat{A}_k)\\
\hat{B}_k &amp;= \begin{bmatrix}
  Q_{1} &amp; Q_{3} &amp; Q_{5} &amp; \dots &amp; Q_{k - 4} &amp; Q_{k -
2} &amp; Q_{k}
\end{bmatrix}\\
B_k &amp;= \mathtt{concat}(-\hat{B}_k, \hat{B}_k)\\
\end{aligned}
\]</span></p>
<p><span class="math inline">\(A_k\)</span> の伝達関数を <span
class="math inline">\(H_{A_k}(z)\)</span> 、 <span
class="math inline">\(B_k\)</span> の伝達関数を <span
class="math inline">\(H_{B_k}(z)\)</span> とすると analytic signal
を次のように近似できます。</p>
<p><span class="math display">\[
H_{Hilbert}(z) = H_{A_k}(z) + j z^{-1} H_{B_k}(z)
\]</span></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> wilkinson(samplerate, sig, shift_hz<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> numpy.arange((k <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    zero_real <span class="op">=</span> numpy.exp(numpy.pi <span class="op">/</span> <span class="dv">2</span><span class="op">**</span>(<span class="dv">2</span> <span class="op">*</span> n))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    zero_real <span class="op">=</span> numpy.append(zero_real, <span class="op">-</span>zero_real)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    zero_imag <span class="op">=</span> numpy.exp(numpy.pi <span class="op">/</span> <span class="dv">2</span><span class="op">**</span>(<span class="dv">2</span> <span class="op">*</span> n <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    zero_imag <span class="op">=</span> numpy.append(zero_imag, <span class="op">-</span>zero_imag)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    sos_real <span class="op">=</span> signal.zpk2sos(zero_real, <span class="dv">1</span> <span class="op">/</span> zero_real, <span class="fl">1e-5</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    sos_imag <span class="op">=</span> signal.zpk2sos(zero_imag, <span class="dv">1</span> <span class="op">/</span> zero_imag, <span class="fl">1e-5</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    sos_imag <span class="op">=</span> add_delay(sos_imag)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    real <span class="op">=</span> signal.sosfilt(sos_real, sig)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    imag <span class="op">=</span> signal.sosfilt(sos_imag, sig)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    analytic <span class="op">=</span> real <span class="op">-</span> <span class="ot">1j</span> <span class="op">*</span> imag</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    sig <span class="op">=</span> pitch_shift(samplerate, analytic, shift_hz)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    peak <span class="op">=</span> numpy.<span class="bu">max</span>(numpy.<span class="bu">abs</span>(sig))</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sig <span class="op">/</span> peak <span class="cf">if</span> peak <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> sig</span></code></pre></div>
<ul>
<li><a
href="https://dsp.stackexchange.com/questions/8692/hilbert-transform-filter-for-audio-applications-using-iir-half-band-parallel-al">Hilbert
transform filter for audio applications: Using IIR half-band parallel
all pass structure - Signal Processing Stack Exchange</a></li>
</ul>
<h3 id="オールパスその5">オールパスその5</h3>
<p><a
href="https://web.archive.org/web/20180611174451/http://webpages.charter.net/wa1sov/technical/allpass/allpass.html">Peter
C. McNulty さんによって紹介されていたフィルタ</a>です。リンク先の Table
1 の抵抗の単位 [W] は <span class="math inline">\(\Omega\)</span>
(オーム) の意味です。 <span class="math inline">\(\Omega\)</span>
の文字が表示できないときは W で代用されることがあるそうです。</p>
<p>フィルタネットワークで使われるオールパスフィルタの伝達関数です。</p>
<p><span class="math display">\[
\begin{aligned}
H_{AP}(s, R, C) =&amp;\; \frac{-1 + 2\pi RCs}{1 + 2\pi RCs}\\
H_{\mathrm{Re}}(s) =&amp;\;
  H_{AP}(s, 93100, 100p)\\
  &amp;\times H_{AP}(s, 90900, 470p)\\
  &amp;\times H_{AP}(s, 102000, 1800p)\\
  &amp;\times H_{AP}(s, 95300, 8200p)\\
  &amp;\times H_{AP}(s, 101000, 33000p)\\
  &amp;\times H_{AP}(s, 96500, 270000p)\\
H_{\mathrm{Im}}(s) =&amp;\;
  H_{AP}(s, 98800, 27p)\\
  &amp;\times H_{AP}(s, 104000, 200p)\\
  &amp;\times H_{AP}(s, 88700, 1000p)\\
  &amp;\times H_{AP}(s, 97600, 3900p)\\
  &amp;\times H_{AP}(s, 107000, 15000p)\\
  &amp;\times H_{AP}(s, 109000, 68000p)\\
p =&amp;\; 10^{-12}\\
H_{Hilbert}(s) =&amp;\; H_{\mathrm{Re}}(s) - j H_{\mathrm{Im}}(s)
\end{aligned}
\]</span></p>
<p><span class="math inline">\(H_{AP}\)</span> は連続系なので <a
href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.cont2discrete.html#scipy.signal.cont2discrete"><code>scipy.signal.cont2discrete</code></a>
で離散系に変えます。 <code>cont2discrete</code> の <code>method</code>
は zoh よりも gbt にしたほうがノイズが減りました。</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.polynomial <span class="im">import</span> polynomial</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> allpass(samplerate, rc):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    rc <span class="op">*=</span> <span class="dv">2</span> <span class="op">*</span> numpy.pi</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    num, den, dt <span class="op">=</span> signal.cont2discrete(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        ([rc, <span class="op">-</span><span class="dv">1</span>], [rc, <span class="dv">1</span>]), <span class="dv">1</span> <span class="op">/</span> samplerate, <span class="st">&quot;gbt&quot;</span>, <span class="fl">0.5</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> num[<span class="dv">0</span>], den</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mcnulty(samplerate, sig, shift_hz<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    rc_real <span class="op">=</span> [</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        allpass(samplerate, rc) <span class="cf">for</span> rc <span class="kw">in</span> [</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>            <span class="fl">9.31e-06</span>, <span class="fl">4.2723e-05</span>, <span class="fl">0.0001836</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.00078146</span>, <span class="fl">0.003333</span>, <span class="fl">0.026055</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    rc_imag <span class="op">=</span> [</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        allpass(samplerate, rc) <span class="cf">for</span> rc <span class="kw">in</span> [</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            <span class="fl">2.6676e-06</span>, <span class="fl">2.08e-05</span>, <span class="fl">8.87e-05</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.00038064</span>, <span class="fl">0.0016049999999999999</span>, <span class="fl">0.007412</span>,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    sos_real <span class="op">=</span> [</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        signal.tf2sos(</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            polynomial.polymul(rc1[<span class="dv">0</span>], rc2[<span class="dv">0</span>]),</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            polynomial.polymul(rc1[<span class="dv">1</span>], rc2[<span class="dv">1</span>]),</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        )[<span class="dv">0</span>] <span class="cf">for</span> rc1, rc2 <span class="kw">in</span> <span class="bu">zip</span>(rc_real[::<span class="dv">2</span>], rc_real[<span class="dv">1</span>::<span class="dv">2</span>])</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    sos_imag <span class="op">=</span> [</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        signal.tf2sos(</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            polynomial.polymul(rc1[<span class="dv">0</span>], rc2[<span class="dv">0</span>]),</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>            polynomial.polymul(rc1[<span class="dv">1</span>], rc2[<span class="dv">1</span>]),</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        )[<span class="dv">0</span>] <span class="cf">for</span> rc1, rc2 <span class="kw">in</span> <span class="bu">zip</span>(rc_imag[::<span class="dv">2</span>], rc_imag[<span class="dv">1</span>::<span class="dv">2</span>])</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    real <span class="op">=</span> signal.sosfilt(sos_real, sig)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    imag <span class="op">=</span> signal.sosfilt(sos_imag, sig)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    analytic <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (real <span class="op">-</span> <span class="ot">1j</span> <span class="op">*</span> imag)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pitch_shift(samplerate, analytic, shift_hz)</span></code></pre></div>
<ul>
<li><a
href="https://web.archive.org/web/20180611174451/http://webpages.charter.net/wa1sov/technical/allpass/allpass.html">Analog
Wide Band Audio Phase Shift Networks</a></li>
<li><a href="https://en.wikipedia.org/wiki/Ohm#Symbol">Ohm -
Wikipedia</a></li>
</ul>
<h3 id="オールパスその6">オールパスその6</h3>
<p>これも McNulty さんによって紹介されていたフィルタです。設計は Chuck
さんによるそうです。</p>
<p><span class="math display">\[
\begin{aligned}
H_{AP}(s, R, C) =&amp;\; \frac{-1 + 2\pi RCs}{1 + 2\pi RCs}\\
H_{\mathrm{Re}}(z) =&amp;\;
  H_{AP}(z, 5490, 0.001\mu)\\
  &amp;\times H_{AP}(z, 47500, 0.001\mu)\\
  &amp;\times H_{AP}(z, 237000, 0.001\mu)\\
  &amp;\times H_{AP}(z, 127000, 0.01\mu)\\
H_{\mathrm{Im}}(z) =&amp;\;
  H_{AP}(z, 20000, 0.001\mu)\\
  &amp;\times H_{AP}(z, 107000, 0.001\mu)\\
  &amp;\times H_{AP}(z, 536000, 0.001\mu)\\
  &amp;\times H_{AP}(z, 464000, 0.01\mu)\\
\mu =&amp;\; 10^{-6}\\
H_{Hilbert}(s) =&amp;\; H_{\mathrm{Re}}(s) - j H_{\mathrm{Im}}(s)
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chuck(samplerate, sig, shift_hz<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    rc_imag <span class="op">=</span> [</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        allpass(samplerate, rc)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> rc <span class="kw">in</span> [<span class="fl">5.49e-06</span>, <span class="fl">4.75e-05</span>, <span class="fl">2.37e-04</span>, <span class="fl">1.27e-03</span>]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    rc_real <span class="op">=</span> [</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        allpass(samplerate, rc)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> rc <span class="kw">in</span> [<span class="fl">2.00e-05</span>, <span class="fl">1.07e-04</span>, <span class="fl">5.36e-04</span>, <span class="fl">4.64e-03</span>]</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    sos_imag <span class="op">=</span> [</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        signal.tf2sos(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>            polynomial.polymul(rc1[<span class="dv">0</span>], rc2[<span class="dv">0</span>]),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>            polynomial.polymul(rc1[<span class="dv">1</span>], rc2[<span class="dv">1</span>]),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        )[<span class="dv">0</span>] <span class="cf">for</span> rc1, rc2 <span class="kw">in</span> <span class="bu">zip</span>(rc_imag[::<span class="dv">2</span>], rc_imag[<span class="dv">1</span>::<span class="dv">2</span>])</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    sos_real <span class="op">=</span> [</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        signal.tf2sos(</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>            polynomial.polymul(rc1[<span class="dv">0</span>], rc2[<span class="dv">0</span>]),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            polynomial.polymul(rc1[<span class="dv">1</span>], rc2[<span class="dv">1</span>]),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        )[<span class="dv">0</span>] <span class="cf">for</span> rc1, rc2 <span class="kw">in</span> <span class="bu">zip</span>(rc_real[::<span class="dv">2</span>], rc_real[<span class="dv">1</span>::<span class="dv">2</span>])</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    real <span class="op">=</span> signal.sosfilt(sos_real, sig)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    imag <span class="op">=</span> signal.sosfilt(sos_imag, sig)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    analytic <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (real <span class="op">-</span> <span class="ot">1j</span> <span class="op">*</span> imag)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pitch_shift(samplerate, analytic, shift_hz)</span></code></pre></div>
<ul>
<li><a
href="https://web.archive.org/web/20180611174451/http://webpages.charter.net/wa1sov/technical/allpass/allpass.html">Analog
Wide Band Audio Phase Shift Networks</a></li>
</ul>
<h2 id="音のサンプル">音のサンプル</h2>
<p>次のようなコードで音をレンダリングしました。</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> soundfile</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>data, samplerate <span class="op">=</span> soundfile.read(<span class="st">&quot;snd/yey.wav&quot;</span>, always_2d<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>wav <span class="op">=</span> data.T[<span class="dv">0</span>]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>shift_hz <span class="op">=</span> <span class="dv">200</span>  <span class="co"># Hz</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> naive(samplerate, wav, shift_hz)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>soundfile.write(<span class="st">&quot;naive.wav&quot;</span>, out, samplerate)</span></code></pre></div>
<p><span class="math inline">\(\omega_c = 1000\)</span>
として周波数シフトした音のサンプルです。ソースは freesound.org
で見つけた hemogREC さんによる <a
href="https://freesound.org/people/hemogREC/sounds/144467/">yey.wav</a>
です。</p>
<figure>
<figcaption>
ソース
</figcaption>
<audio controls>
<source src="snd/yey.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
ヒルベルト変換
</figcaption>
<audio controls>
<source src="snd/naive.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
<ol type="1">
<li>Niemitalo のフィルタ
</figcaption>
<audio controls> <source src="snd/niemitalo.wav" type="audio/wav">
</audio>
</figure></li>
</ol>
<figure>
<figcaption>
<ol start="2" type="1">
<li>Wasabi のフィルタ
</figcaption>
<audio controls> <source src="snd/wasabi.wav" type="audio/wav"> </audio>
</figure></li>
</ol>
<figure>
<figcaption>
<ol start="3" type="1">
<li>Favreau のフィルタ
</figcaption>
<audio controls> <source src="snd/favreau.wav" type="audio/wav">
</audio>
</figure></li>
</ol>
<figure>
<figcaption>
<ol start="4" type="1">
<li>Wilkinson のフィルタ
</figcaption>
<audio controls> <source src="snd/wilkinson.wav" type="audio/wav">
</audio>
</figure></li>
</ol>
<figure>
<figcaption>
<ol start="5" type="1">
<li>McNulty のフィルタ
</figcaption>
<audio controls> <source src="snd/mcnulty.wav" type="audio/wav">
</audio>
</figure></li>
</ol>
<figure>
<figcaption>
<ol start="6" type="1">
<li>Chuck のフィルタ
</figcaption>
<audio controls> <source src="snd/chuck.wav" type="audio/wav"> </audio>
</figure></li>
</ol>
<p>Wilkinson
のフィルタは特性は問題ないのですが、うまく周波数シフトできていません。<a
href="https://ccrma.stanford.edu/~jos/fp/Series_Second_Order_Sections.html">直列2次セクション</a>に変換するときに何か問題があるのかもしれません。
Wasabi のフィルタもノイズがはっきりと聞き取れます。</p>
<h2 id="その他">その他</h2>
<h3 id="周波数特性の位相差">周波数特性の位相差</h3>
<p>伝達関数の周波数特性は複素数で表されているので、位相差の計算 <span
class="math inline">\(\angle (H_{\mathrm{Re}} /
H_{\mathrm{Im}})\)</span>
では除算が出てきます。複素数の除算は次のように書けます。</p>
<p><span class="math display">\[
\frac{z_1}{z_2} = \frac{r_1}{r_2} e^{j (\phi_1 - \phi_2)},\quad
z_1 = r_1 e^{j \phi_1},\quad
z_2 = r_2 e^{j \phi_2}
\]</span></p>
<p>よって <span class="math inline">\(\angle (z_1 / z_2)\)</span> は
<span class="math inline">\(\phi_1 - \phi_2\)</span> です。</p>
<h3 id="scipy.signal-の-sos"><code>scipy.signal</code> の
<code>sos</code></h3>
<p><code>scipy.signal</code> で <code>sos</code> と略されている cascaded
second-order sections のデータ構造です。</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sos <span class="op">=</span> [</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  [b00, b01, b02, <span class="dv">1</span>, a01, a02],</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  [b10, b11, b12, <span class="dv">1</span>, a11, a12],</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  [b20, b21, b22, <span class="dv">1</span>, a21, a22],</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p>伝達関数は次のようになります。</p>
<p><span class="math display">\[
H(z) =
  \frac{b_{00} + b_{01} z^{-1} + b_{02} z^{-2}}
    {1 + a_{01} z^{-1} + a_{02} z^{-2}}
  \times
  \frac{b_{10} + b_{11} z^{-1} + b_{12} z^{-2}}
    {1 + a_{11} z^{-1} + a_{12} z^{-2}}
  \times
  \frac{b_{20} + b_{21} z^{-1} + b_{22} z^{-2}}
    {1 + a_{21} z^{-1} + a_{22} z^{-2}}
  \times \dots
\]</span></p>
<h3 id="pure-data-の-biquad">Pure Data の <code>biquad~</code></h3>
<p>Pure Data の <code>biquad~</code> の係数を移植するときは
<code>fb</code> の符号を逆にしないと正しく動かないことがあります。</p>
<p><code>biquad~</code> の引数です。</p>
<pre class="puredata"><code>&quot;biquad~&quot; [fb1] [fb2] [ff1] [ff2] [ff3]</code></pre>
<p><code>biquad~</code> の伝達関数です。</p>
<p><span class="math display">\[
H(z) = \frac{
  \mathtt{ff_1} + \mathtt{ff_2} z^{-1} + \mathtt{ff_3} z^{-2}
}{
  1 - \mathtt{fb_1} z^{-1} - \mathtt{fb_2} z^{-2}
}
\]</span></p>
<p><code>scipy.signal</code> に移植するときは次のように書けます。</p>
<pre class="python3"><code>sos_biquad = [[ff1, ff2, ff3, 1, -fb1, -fb2]]
output = scipy.signal.sosfilt(sos_biquad, some_signal)</code></pre>
<ul>
<li><a
href="http://www.pd-tutorial.com/english/ch03s03.html">Programming
Electronic Music in Pd - 3.3 Subtractive synthesis</a></li>
</ul>
<h3 id="ピッチシフトと周波数シフト">ピッチシフトと周波数シフト</h3>
<p><a href="http://music.fullbucket.de/freqshifter.html">full bucket
music の Frequency Shifter</a>
の説明文によるとピッチシフトと周波数シフトとは別物です。ピッチシフトは倍音構造が保持されますが、周波数シフトは倍音構造が崩れてしまうからです。</p>
<p>この記事はもともと AM
ピッチシフトという呼び方を使っていましたが、今は AM
周波数シフトという呼び方に変更しました。 URL が
<code>am_pitchshift.html</code> となっているのはその名残です。</p>
<h2 id="変更点">変更点</h2>
<ul>
<li>2022/05/08
<ul>
<li>手法の呼び方を AM ピッチシフトから AM 周波数シフトに変更。</li>
</ul></li>
<li>2019/08/06
<ul>
<li>コードの <code>shift_hz</code>
が誤って周波数のまま扱われていた部分を角周波数に修正。</li>
</ul></li>
</ul>
<footer>
<a href="../index.html">インデックスに戻る</a>
</footer>
</body>

</html>

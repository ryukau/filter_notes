<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja" >

<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
      <meta name="dcterms.date" content="2024-08-06" />
      <title>one_sec_sounds_clustering</title>

  <style>
    :root {
      --background-color: #ffffff;
      --foreground-color: #000000;
      --table-odd-background-color: #eeeeee;
      --link-color: #0000ee;
      --visited-color: #551a8b;
      --active-color: #ff0000;
      --border-color: #888888;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #202020;
        --foreground-color: #eeeeee;
        --table-odd-background-color: #333333;
        --link-color: #88aaee;
        --visited-color: #dd77cc;
        --active-color: #ff6666;
        --border-color: #888888;
      }

      audio,
      code,
      img,
      .sourceCode {
        /*
        0.8745 ~= 1 - 0x20 / 0xff.
        0x20 and 0xff are brightness of dark and light theme.
        */
        filter: invert(0.8745098039215686);
      }

      pre>code {
        filter: invert(0);
      }
    }

    body {
      max-width: 704px;
      margin: auto;
      padding: 32px 8px;

      background-color: var(--background-color);
      color: var(--foreground-color);
    }

    img {
      max-width: 100%;
    }

    video {
      max-width: 100%;
    }

    kbd {
      font-family: inherit;
      border-style: solid;
      border-width: 1px 2px 2px 1px;
      border-radius: 2px;
      padding: 4px;
      margin: 2px;
      line-height: calc(1em + 16px);
    }

    a {
      text-decoration: none;
    }

    :link {
      color: var(--link-color);
    }

    :visited {
      color: var(--visited-color);
    }

    :link:active,
    :visited:active {
      color: var(--active-color);
    }

    .header-anchor {
      color: var(--foreground-color);
    }

    .header-anchor:hover {
      color: var(--link-color);
    }

    .header-anchor:hover::after {
      display: inline-block;
      font-size: min(1em, 1rem);
      content: '(クリックでここへリンク)';
      padding-left: 1em;
      color: var(--link-color);
    }

    h2 {
      border-left: solid 32px #000000;
      padding-left: 24px;
    }

    h3 {
      border-left: solid 20px #404040;
      padding-left: 16px;
    }

    h4 {
      font-size: 100%;
      border-left: solid 12px #606060;
      padding-left: 8px;
    }

    h5 {
      font-size: 90%;
      border-left: solid 8px #808080;
      padding-left: 8px;
    }

    h6 {
      font-size: 80%;
      border-left: solid 4px #a0a0a0;
      padding-left: 4px;
    }

    table {
      border-spacing: 0px;
      border-collapse: separate;
      border-left: 1px solid var(--border-color);
      border-right: 1px solid var(--border-color);
      border-top: 1px solid var(--border-color);
      border-bottom: hidden;
    }

    tr:nth-child(odd) {
      background: var(--table-odd-background-color);
    }

    tr:nth-child(even) {
      background: var(--background-color);
    }

    th {
      height: 2em;
      padding: 4px 1em 4px 1em;
      background: var(--background-color);
      border-bottom: 1px solid var(--border-color);
    }

    th:not(:first-child) {
      border-left: 1px solid var(--border-color);
    }

    td {
      height: 1.5em;
      padding: 4px 1em 4px 1em;
      border-bottom: 1px solid var(--border-color);
    }

    td:not(:first-child) {
      border-left: 1px solid var(--border-color);
    }

    dl {
      padding-left: 2em;
    }

    dt {
      font-weight: bold;
      border-bottom: 1px dashed #000000;
      margin-top: 2em;
    }

    dd {
      border-left: 1px dotted #000000;
      margin-left: 1em;
      padding-left: 1em;
    }

    audio {
      vertical-align: middle;
    }

    label {
      vertical-align: middle;
    }

    :not(.sourceCode)>pre {
      overflow: auto;
      border: 1px solid var(--border-color);
      padding: 8px;
    }

    div.sourceCode {
      overflow: auto;
      border: 1px solid var(--border-color);
      padding: 8px;
    }

    pre>code.sourceCode>span>a:first-child::before {
      border-right: 1px solid var(--border-color);
      padding-right: 1em;
      margin-right: 1em;
      text-decoration: none;
    }

    :not(pre)>code {
      color: #163eac;
    }

    li {
      margin: 8px;
    }

    summary:hover {
      background-color: var(--table-odd-background-color);
    }

    header {
      border-bottom: 1px var(--border-color) solid;
      padding: 0.5em;
      margin-bottom: 1em;
    }

    footer {
      border-top: 1px var(--border-color) solid;
      padding: 0.5em;
      margin-top: 1em;
    }


    canvas {
      /* image-rendering: pixelated; */
      display: inline-block;
      border-style: solid;
      border-width: 1px;
      border-color: #627f84;
    }

    .controlBlock {
      display: inline-block;
      width: 450px;
      text-align: left;
      vertical-align: top;
      margin-left: 4px;
    }

    input[type="button"] {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      font-size: 16px;
      height: 32px;
    }

    input[type="button"]:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }

    div.numberInput {
      display: block;
      white-space: nowrap;
    }

    div.numberInput:hover {
      background-color: #e0ecff;
    }

    .numberInputLabel {
      /* max 12 letter  */
      display: inline-block;
      margin: 0 8px 0 8px;
      text-align: left;
      vertical-align: middle;
      width: 100px;

      font-size: 10pt;
      font-family: 'Courier New', Courier, monospace;
    }

    .numberInputNumber {
      display: inline-block;
      vertical-align: middle;
      width: 120px;
    }

    .numberInputRange {
      display: inline-block;
      vertical-align: middle;
      width: 160px;
    }

    .pullDownMenu {
      display: inline-block;
      text-align: center;
    }

    .pullDownMenu:hover {
      background-color: #e0ecff;
    }

    select {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      height: 24px;
      vertical-align: middle;
      font-size: 12px;
    }

    select:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }

    span.math.inline a {
      color: #000000;
    }

    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #ffffff;
        color: #666666;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #666666;  padding-left: 4px; }
    div.sourceCode
      { color: #000000; background-color: #ffffff; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; text-decoration: underline; } /* Alert */
    code span.an { color: #666666; text-decoration: underline; } /* Annotation */
    code span.at { color: #333333; } /* Attribute */
    code span.bu { color: #000000; } /* BuiltIn */
    code span.cf { color: #666666; } /* ControlFlow */
    code span.ch { color: #b000b0; } /* Char */
    code span.cn { color: #000000; } /* Constant */
    code span.co { color: #008800; } /* Comment */
    code span.cv { color: #008800; } /* CommentVar */
    code span.do { color: #008800; } /* Documentation */
    code span.dt { color: #333333; } /* DataType */
    code span.dv { color: #0000ff; } /* DecVal */
    code span.er { color: #ffffff; background-color: #ff0000; } /* Error */
    code span.ex { color: #000000; } /* Extension */
    code span.fl { color: #0000ff; } /* Float */
    code span.im { color: #666666; } /* Import */
    code span.in { color: #666666; } /* Information */
    code span.kw { color: #666666; } /* Keyword */
    code span.op { color: #000000; } /* Operator */
    code span.ot { color: #000000; } /* Other */
    code span.pp { color: #666666; } /* Preprocessor */
    code span.sc { color: #b000b0; } /* SpecialChar */
    code span.ss { color: #b000b0; } /* SpecialString */
    code span.st { color: #b000b0; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #b000b0; } /* VerbatimString */
    code span.wa { color: #000000; background-color: #ffff00; text-decoration: underline; } /* Warning */
  </style>

    </head>

<body>
    <header>
    <p>
      何かあれば <a href="https://github.com/ryukau/filter_notes">GitHub のリポジトリ</a>に issue を作るか ryukau@gmail.com までお気軽にどうぞ。
    </p>
    <hr>
    <a href="../index.html">インデックスに戻る</a>
        <p>
      Update: 2024-08-06
    </p>
            <details>
      <summary translate="yes">Table of Contents</summary>
      <nav id="TOC" role="doc-toc">
        <ul>
        <li><a href="#秒以下の音のクラスタリング"
        id="toc-秒以下の音のクラスタリング">1秒以下の音のクラスタリング</a>
        <ul>
        <li><a href="#コードについて"
        id="toc-コードについて">コードについて</a></li>
        <li><a href="#データセット"
        id="toc-データセット">データセット</a>
        <ul>
        <li><a href="#シンセサイザの音"
        id="toc-シンセサイザの音">シンセサイザの音</a></li>
        <li><a href="#フィールドレコーディングの音"
        id="toc-フィールドレコーディングの音">フィールドレコーディングの音</a></li>
        </ul></li>
        <li><a href="#特徴抽出" id="toc-特徴抽出">特徴抽出</a>
        <ul>
        <li><a href="#mfccデルタ"
        id="toc-mfccデルタ">MFCC+デルタ</a></li>
        <li><a href="#エンベロープ"
        id="toc-エンベロープ">エンベロープ</a></li>
        <li><a href="#ソートしたピッチ"
        id="toc-ソートしたピッチ">ソートしたピッチ</a></li>
        </ul></li>
        <li><a href="#クラスタリング"
        id="toc-クラスタリング">クラスタリング</a></li>
        <li><a href="#その他" id="toc-その他">その他</a></li>
        <li><a href="#the-infinite-drum-machine-の手法"
        id="toc-the-infinite-drum-machine-の手法">The Infinite Drum
        Machine の手法</a></li>
        </ul></li>
        <li><a href="#参考サイト"
        id="toc-参考サイト">参考サイト</a></li>
        </ul>
      </nav>
    </details>
      </header>
  <h1 id="秒以下の音のクラスタリング"><a
  href="#秒以下の音のクラスタリング" class="header-anchor"
  aria-hidden="true">1秒以下の音のクラスタリング</a></h1>
  <p><a
  href="../golly_generations_clustering/golly_generations_clustering.html">GollyのGenerationsルールから生成した音のクラスタリング</a>が意外とうまく行ったので、1秒以下の音のクラスタリングを試しました。</p>
  <h2 id="コードについて"><a href="#コードについて"
  class="header-anchor" aria-hidden="true">コードについて</a></h2>
  <p>Python3では次のライブラリを使っています。</p>
  <ul>
  <li><a href="https://matplotlib.org/">matplotlib</a></li>
  <li><a
  href="https://pysoundfile.readthedocs.io/en/0.9.0/">PySoundFile</a></li>
  <li><a
  href="https://python-speech-features.readthedocs.io/en/latest/#">python_speech_features</a></li>
  <li><a
  href="https://scikit-learn.org/stable/index.html">scikit-learn</a></li>
  <li><a href="https://www.scipy.org/">SciPy, NumPy</a></li>
  </ul>
  <h2 id="データセット"><a href="#データセット" class="header-anchor"
  aria-hidden="true">データセット</a></h2>
  <p>データセットに含まれる音は、長さを1秒以下、サンプリング周波数を44100Hzにそろえています。</p>
  <p>今回作ったデータセットの大きさは6016サンプルで長さは約81分です。</p>
  <h3 id="シンセサイザの音"><a href="#シンセサイザの音"
  class="header-anchor" aria-hidden="true">シンセサイザの音</a></h3>
  <p>以前作ったシンセサイザから、それぞれ1000ほどのサンプルをレンダリングしました。</p>
  <p>今回使ったシンセサイザです。</p>
  <ul>
  <li><a href="https://ryukau.github.io/Singen0.2/">Singen0.2</a></li>
  <li><a href="https://ryukau.github.io/Singen0.3/">Singen0.3</a></li>
  <li><a href="https://ryukau.github.io/Pluck/">Pluck</a></li>
  <li><a href="https://ryukau.github.io/KSCymbal/">KSCymbal</a></li>
  <li><a href="https://ryukau.github.io/PADcymbal/">PADcymbal</a></li>
  <li><a href="https://ryukau.github.io/FDNCymbal/">FDNCymbal</a></li>
  <li><a href="https://ryukau.github.io/WaveCymbal/">WaveCymbal</a></li>
  </ul>
  <p>ブラウザのデベロッパツールのコンソールから次のコードを実行してレンダリングしました。</p>
  <div class="sourceCode" id="cb1"><pre
  class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementsByTagName</span>(<span class="st">&quot;title&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> button <span class="op">=</span> title[<span class="dv">0</span>]<span class="op">.</span><span class="at">innerText</span> <span class="op">===</span> <span class="st">&quot;Singen0.3&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">?</span> ui<span class="op">.</span><span class="at">buttonRandom</span> <span class="op">:</span> buttonRandom</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> id <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="fu">setInterval</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  () <span class="kw">=&gt;</span> {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (counter <span class="op">&gt;</span> <span class="dv">1024</span>) <span class="pp">clearInterval</span>(id)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    button<span class="op">.</span><span class="fu">onClick</span>()</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">++</span>counter</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1000</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
  <p>Pluck, KSCymbal, PADcymbal, FDNCymbal,
  WaveCymbalはステレオでレンダリングした音をチャンネルごとに分離してそれぞれ別のサンプルとして扱っています。</p>
  <p>得られた音を次のコードで正規化しました。<a
  href="http://sox.sourceforge.net/">SoX</a>を使っています。</p>
  <ul>
  <li><a
  href="https://github.com/ryukau/filter_notes/blob/master/one_sec_sounds_clustering/demo/split.py">シンセサイザの音を加工するコードを読む
  (github.com)</a></li>
  </ul>
  <h3 id="フィールドレコーディングの音"><a
  href="#フィールドレコーディングの音" class="header-anchor"
  aria-hidden="true">フィールドレコーディングの音</a></h3>
  <p>近所を歩いてフィールドレコーディングした音をデータセットに加えました。</p>
  <p>フィールドレコーディングの音はSoXの <code>remix -</code>
  でモノラルにしてから1秒間隔で切っています。</p>
  <ul>
  <li><p><a
  href="https://github.com/ryukau/filter_notes/blob/master/one_sec_sounds_clustering/demo/slice.py">フィールドレコーディングの音を加工するコードを読む
  (github.com)</a></p></li>
  <li><p><a href="http://sox.sourceforge.net/sox.html">SoX man page</a>
  - EFFECTSの節に <code>remix</code> の解説</p></li>
  </ul>
  <h2 id="特徴抽出"><a href="#特徴抽出" class="header-anchor"
  aria-hidden="true">特徴抽出</a></h2>
  <h3 id="mfccデルタ"><a href="#mfccデルタ" class="header-anchor"
  aria-hidden="true">MFCC+デルタ</a></h3>
  <p><code>python_speech_features.mfcc</code> で取り出したMFCCを
  <code>numpy.ravel</code> で1次元にして
  <code>sklearn.cluster.AffinityPropagation</code>
  でクラスタリングしました。</p>
  <p>今回使った <code>python_speech_features.mfcc</code>
  のパラメータです。</p>
  <div class="sourceCode" id="cb2"><pre
  class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> python_speech_features</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> soundfile</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>data, samplerate <span class="op">=</span> soundfile.read(<span class="st">&quot;path/to/wav_file&quot;</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>nfft <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>mfcc <span class="op">=</span> python_speech_features.mfcc(</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    samplerate,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    winlen<span class="op">=</span>nfft <span class="op">/</span> samplerate,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    winstep<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    numcep<span class="op">=</span><span class="dv">26</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    nfilt<span class="op">=</span><span class="dv">52</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    nfft<span class="op">=</span>nfft,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    lowfreq<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    highfreq<span class="op">=</span><span class="dv">20000</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    preemph<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    ceplifter<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
  <p>今回は1秒以下の音のクラスタリングなので MFCC のフレーム数が
  <code>1 / winstep = 100</code>
  になるように調整しました。フレーム数が100より少ないときは0で埋めたフレームを付け足しています。フレーム数が100より大きいときは、音の始まりから100フレームだけを取り出して、残りのフレームを切り捨てています。</p>
  <p><a
  href="http://www.practicalcryptography.com/miscellaneous/machine-learning/guide-mel-frequency-cepstral-coefficients-mfccs/">Practical
  Cryptography の MFCC
  チュートリアル</a>にMFCCのデルタで結果が改善することがあると書いてあったので
  <code>numpy.concatenate</code>
  でMFCCと、MFCCのデルタをつないで一つのデータポイントにまとめました。</p>
  <div class="sourceCode" id="cb3"><pre
  class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mfcc の取得は省略。</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>delta <span class="op">=</span> python_speech_features.base.delta(mfcc, <span class="dv">1</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>mfccdelta <span class="op">=</span> numpy.concatenate((numpy.ravel(mfcc), numpy.ravel(delta)))</span></code></pre></div>
  <p>ここでは <code>mfccdelta</code>
  のことをMFCC+デルタと呼んでいます。</p>
  <h3 id="エンベロープ"><a href="#エンベロープ" class="header-anchor"
  aria-hidden="true">エンベロープ</a></h3>
  <p>ここでのエンベロープは信号を短い区間に区切って、それぞれの区間で信号の絶対値の最大値を取り出したものです。</p>
  <div class="sourceCode" id="cb4"><pre
  class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_envelope(data, samplerate, winstep, n_frame):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    :data: 一次元の信号。</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    :samplerate: サンプリング周波数。</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    :winstep: 区間の長さ。秒。</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">    :n_frame: 区間の数。</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    data_abs <span class="op">=</span> numpy.<span class="bu">abs</span>(data)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    envelope <span class="op">=</span> numpy.zeros(n_frame)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    step <span class="op">=</span> <span class="bu">int</span>(winstep <span class="op">*</span> samplerate)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> step</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> frame <span class="kw">in</span> <span class="bu">range</span>(n_frame):</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> end <span class="op">&gt;=</span> <span class="bu">len</span>(data_abs):</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            index <span class="op">=</span> frame</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        envelope[frame] <span class="op">=</span> numpy.<span class="bu">max</span>(data_abs[start:end])</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> end</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        end <span class="op">+=</span> step</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> index <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        envelope[index] <span class="op">=</span> numpy.<span class="bu">max</span>(data_abs[start:])</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        index <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> envelope</span></code></pre></div>
  <p>エンベロープの区間の長さと数はMFCCの対応するパラメータと合わせました。区間の長さは
  <code>winstep=0.01</code> 、区間の数は <code>n_frame=100</code>
  です。</p>
  <h3 id="ソートしたピッチ"><a href="#ソートしたピッチ"
  class="header-anchor" aria-hidden="true">ソートしたピッチ</a></h3>
  <p>ピッチは <code>python_speech_features.sigproc.framesig</code>
  で区切った各フレームから次の手順で取り出しました。</p>
  <ol type="1">
  <li>NSD type II の局所最大点を全て取り出す。</li>
  <li>局所最大点を降順にソート。</li>
  <li>ソートした局所最大点の前から18個のインデックスを取り出して周波数を計算。</li>
  <li>周波数をセント値に変換。</li>
  <li>セント値を昇順にソート。</li>
  </ol>
  <p>手順 5.
  のソートがないと似たような音でまとまりにくくなります。推定したピッチは似たような値で順番が入れ替わっていることが多いので、ソートなしだとクラスタリングで計算される距離が大きくなることが予想されます。</p>
  <p>CMND type II も試したのですが、テストに使った小さなデータセットでは
  NSD type II のほうが良い結果が出ました。</p>
  <p>係数 k の値ではテストデータでの結果は変わりませんでした。</p>
  <h2 id="クラスタリング"><a href="#クラスタリング"
  class="header-anchor" aria-hidden="true">クラスタリング</a></h2>
  <p>エンベロープ、MFCC+デルタ、ソートしたピッチは別物なのでクラスタリングを分けることにしました。以下はエンベロープ
  -&gt; MFCC+デルタ -&gt;
  ソートしたピッチの順でクラスタリングした結果の一例です。クラスタリングの階層構造がなんとなく見て取れるかと思います。
  Outlier と判断されたクラスタは番号が飛んでいます。</p>
  <pre><code>cluster/test2
├── envelope1
│   ├── mfccdelta2
│   │   ├── pitch1
│   │   │   ├── fast_vib2.wav
│   │   │   ├── high_vib.wav
│   │   │   ├── klang4.wav
│   │   │   ├── noisy1.wav
│   │   │   └── vib2.wav
│   │   └── pitch_outlier
│   │       └── fast_vib1.wav
│   └── mfccdelta_outlier
│       ├── ping1.wav
│       └── ping2.wav
├── envelope2
│   ├── mfccdelta0
│   │   ├── pitch1
│   │   │   ├── ding.wav
│   │   │   ├── fm.wav
│   │   │   └── noisy4.wav
│   │   └── pitch_outlier
│   │       └── sweep_to_high.wav
│   └── mfccdelta_outlier
│       └── vib1.wav
├── envelope3
│   ├── mfccdelta0
│   │   ├── pitch1
│   │   │   ├── klang1.wav
│   │   │   ├── klang3.wav
│   │   │   └── noisy3.wav
│   │   └── pitch_outlier
│   │       ├── mid_crack.wav
│   │       └── noisy5.wav
│   └── mfccdelta_outlier
│       ├── klang2.wav
│       └── vib3.wav
└── envelope_outlier
    └── noisy2.wav</code></pre>
  <p>クラスタリング手法は
  <code>sklearn.cluster.AffinityPropagation</code>
  を使いました。エンベロープのクラスタリングでは
  <code>damping=0.9</code> 、MFCC+デルタのクラスタリングでは
  <code>damping=0.6</code> 、ソートしたピッチのクラスタリングでは
  <code>damping=0.5</code> としました。</p>
  <p>次の動画はクラスタリングの結果です。音は0.25秒間隔で再生されます。残りの0.75秒は次の音と重なっています。</p>
  <iframe width="640" height="360" src="https://www.youtube.com/embed/4SleDuWeYT4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
  </iframe>
  <p>多少は似たような音が集まっている気がします。</p>
  <h2 id="その他"><a href="#その他" class="header-anchor"
  aria-hidden="true">その他</a></h2>
  <p>ラベルのついていないデータセットでのクラスタリングは無謀です。</p>
  <p>今回使ったエンベロープとMFCC+デルタはそういう無茶でもそれなりになんとかしてくれました。エンベロープとMFCC+デルタによるクラスタリングではビブラートのような細かいピッチの揺れやカラーノイズはうまく区別できていないように感じたのでピッチ推定に注目したのですがあまり大きく改善したようには感じませんでした。</p>
  <h2 id="the-infinite-drum-machine-の手法"><a
  href="#the-infinite-drum-machine-の手法" class="header-anchor"
  aria-hidden="true">The Infinite Drum Machine の手法</a></h2>
  <p>Google AI Experiments の <a
  href="https://experiments.withgoogle.com/drum-machine">The Infinite
  Drum Machine</a> で使われていた手法を参考にしたので紹介します。 The
  Infinite Drum Machine は <a
  href="https://github.com/kylemcdonald/AudioNotebooks">Kyle Mcdonald
  さんの AudioNotebooks</a>
  の視覚化です。クラスタリングはインターフェイス上で音を表す点の色付けに使っているだけのようです。</p>
  <ol type="1">
  <li>音の始まりから250msを切り取って <a
  href="https://en.wikipedia.org/wiki/Short-time_Fourier_transform">STFT</a>。</li>
  <li>STFTの結果を [0, 1] の範囲に正規化。</li>
  <li><a
  href="http://scikit-image.org/docs/dev/api/skimage.measure.html#skimage.measure.block_reduce"><code>skimage.measure.block_reduce</code></a>
  で正規化したSTFTの結果を縮小。</li>
  <li>縮小したSTFTの結果をデータポイントとして t-SNE
  で2次元にマッピング。</li>
  <li>マッピングした空間で K-Means を使ってクラスタリング。</li>
  </ol>
  <p><code>block_reduce</code>
  は画像の特徴抽出で使われる関数です。STFTの結果は2次元なので、画像とみなして処理できるというのは面白いです。</p>
  <h1 id="参考サイト"><a href="#参考サイト" class="header-anchor"
  aria-hidden="true">参考サイト</a></h1>
  <ul>
  <li><a
  href="http://www.practicalcryptography.com/miscellaneous/machine-learning/guide-mel-frequency-cepstral-coefficients-mfccs/">Practical
  Cryptography</a></li>
  <li><a href="https://github.com/kylemcdonald/AudioNotebooks">GitHub -
  kylemcdonald/AudioNotebooks: Collection of notebooks and scripts
  related to audio processing and machine learning.</a></li>
  <li><a href="https://experiments.withgoogle.com/drum-machine">The
  Infinite Drum Machine by Manny Tan &amp; Kyle McDonald | Experiments
  with Google</a></li>
  <li><a
  href="https://github.com/googlecreativelab/aiexperiments-drum-machine">GitHub
  - googlecreativelab/aiexperiments-drum-machine: Thousands of everyday
  sounds, organized using machine learning.</a></li>
  <li><a
  href="https://ujjwalkarn.me/2016/08/11/intuitive-explanation-convnets/">An
  Intuitive Explanation of Convolutional Neural Networks – the data
  science blog</a></li>
  </ul>
    <footer>
    <a href="../index.html">インデックスに戻る</a>
  </footer>
</body>

</html>
